# EventEditModal V2 - å®é™…è¿›å±•æ•°æ®é›†æˆæµ‹è¯•æŒ‡å—

**ç‰ˆæœ¬**: v2.16.0  
**æ›´æ–°æ—¶é—´**: 2025-11-27  
**æµ‹è¯•ç›®æ ‡**: éªŒè¯å®é™…è¿›å±•åŒºåŸŸåŠ¨æ€æ•°æ®æ¸²æŸ“åŠŸèƒ½

---

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

æœ¬æ¬¡æ›´æ–°å®ç°äº† EventEditModal V2 å®é™…è¿›å±•åŒºåŸŸçš„åŠ¨æ€æ•°æ®é›†æˆï¼Œæ›¿æ¢äº†ä¹‹å‰çš„ç¡¬ç¼–ç æ¨¡æ‹Ÿæ•°æ®ã€‚

### å®ç°å†…å®¹

âœ… **åŠ¨æ€æ•°æ®æ¸²æŸ“**ï¼šä» `childEvents` è¯»å– Timer å­äº‹ä»¶ï¼ŒåŠ¨æ€ç”Ÿæˆæ—¶é—´ç‰‡æ®µåˆ—è¡¨  
âœ… **æ€»æ—¶é•¿æ±‡æ€»**ï¼šè‡ªåŠ¨è®¡ç®—æ‰€æœ‰å­äº‹ä»¶çš„ç´¯ç§¯æ—¶é•¿  
âœ… **è·¨å¤©æ ‡è®°**ï¼šè‡ªåŠ¨æ£€æµ‹å¹¶æ˜¾ç¤º `+1` æ ‡è®°  
âœ… **ç©ºçŠ¶æ€æç¤º**ï¼šæ— è®¡æ—¶è®°å½•æ—¶æ˜¾ç¤ºå‹å¥½æç¤º  
âœ… **æ—¶é—´æ ¼å¼åŒ–**ï¼šç»Ÿä¸€çš„æ—¥æœŸã€æ˜ŸæœŸã€æ—¶é—´æ˜¾ç¤ºæ ¼å¼

---

## ğŸ§ª æµ‹è¯•åœºæ™¯

### åœºæ™¯ 1ï¼šæŸ¥çœ‹åŒ…å«å¤šæ¬¡è®¡æ—¶çš„çˆ¶äº‹ä»¶

**å‰ç½®æ¡ä»¶**ï¼š
- éœ€è¦ä¸€ä¸ªçˆ¶äº‹ä»¶ï¼ŒåŒ…å« 2+ ä¸ª Timer å­äº‹ä»¶

**æµ‹è¯•æ­¥éª¤**ï¼š
1. æ‰“å¼€ TimeCalendar é¡µé¢
2. åˆ›å»ºä¸€ä¸ªæ–°äº‹ä»¶ï¼ˆä¾‹å¦‚ï¼š"å­¦ä¹ è‹±è¯­"ï¼‰
3. ç‚¹å‡»è¯¥äº‹ä»¶ï¼Œæ‰“å¼€ EventEditModal V2ï¼ˆè¯¦æƒ…è§†å›¾ï¼‰
4. ç‚¹å‡» Timer æŒ‰é’®"å¼€å§‹ä¸“æ³¨"
5. ç­‰å¾… 1-2 åˆ†é’Ÿåï¼Œç‚¹å‡»"åœæ­¢è®¡æ—¶"
6. å†æ¬¡ç‚¹å‡»"å¼€å§‹ä¸“æ³¨"ï¼Œå†è®¡æ—¶ 1-2 åˆ†é’Ÿååœæ­¢
7. å…³é—­å¼¹çª—ï¼Œé‡æ–°æ‰“å¼€è¯¥äº‹ä»¶

**é¢„æœŸç»“æœ**ï¼š
```
å®é™…è¿›å±•                æ€»æ—¶é•¿: 3min

âœ“ 2025-11-27 (å‘¨ä¸‰) 14:30  1min â†’ 14:31
âœ“ 2025-11-27 (å‘¨ä¸‰) 14:32  2min â†’ 14:34
```

**éªŒè¯è¦ç‚¹**ï¼š
- âœ… æ˜¾ç¤ºæ‰€æœ‰å­äº‹ä»¶çš„æ—¶é—´ç‰‡æ®µ
- âœ… æ€»æ—¶é•¿ = æ‰€æœ‰ç‰‡æ®µæ—¶é•¿ä¹‹å’Œ
- âœ… æ—¶é—´æ ¼å¼æ­£ç¡®ï¼ˆæ—¥æœŸã€æ˜ŸæœŸã€æ—¶é—´ï¼‰
- âœ… æ—¶é•¿æ ¼å¼æ­£ç¡®ï¼ˆ1h30min / 45minï¼‰

---

### åœºæ™¯ 2ï¼šæŸ¥çœ‹è·¨å¤©è®¡æ—¶è®°å½•

**å‰ç½®æ¡ä»¶**ï¼š
- éœ€è¦æ‰‹åŠ¨åˆ›å»ºä¸€ä¸ªè·¨å¤©çš„ Timer å­äº‹ä»¶ï¼ˆé€šè¿‡ä¿®æ”¹ localStorage æˆ–ç­‰åˆ°åˆå¤œï¼‰

**æµ‹è¯•æ­¥éª¤**ï¼š
1. æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°
2. æ‰§è¡Œä»¥ä¸‹ä»£ç åˆ›å»ºè·¨å¤© Timerï¼š
   ```javascript
   const EventService = window.EventService || require('./services/EventService').EventService;
   
   // åˆ›å»ºçˆ¶äº‹ä»¶
   const parentId = 'test-parent-' + Date.now();
   const parentEvent = {
     id: parentId,
     title: 'è·¨å¤©æµ‹è¯•',
     startTime: '2025-11-26 23:00:00',
     endTime: '2025-11-27 01:00:00',
     isTimeCalendar: true,
     timerLogs: [],
     tags: []
   };
   EventService.createEvent(parentEvent);
   
   // åˆ›å»ºè·¨å¤© Timer å­äº‹ä»¶
   const timerId = 'timer-crossday-' + Date.now();
   const timerEvent = {
     id: timerId,
     title: 'è·¨å¤©æµ‹è¯•',
     startTime: '2025-11-26 23:30:00',
     endTime: '2025-11-27 01:30:00',
     isTimer: true,
     parentEventId: parentId,
     tags: []
   };
   EventService.createEvent(timerEvent);
   
   // å…³è”çˆ¶å­äº‹ä»¶
   EventService.updateEvent(parentId, {
     timerLogs: [timerId]
   });
   
   console.log('âœ… è·¨å¤©æµ‹è¯•äº‹ä»¶å·²åˆ›å»º');
   ```
3. æ‰“å¼€è¯¥çˆ¶äº‹ä»¶

**é¢„æœŸç»“æœ**ï¼š
```
å®é™…è¿›å±•                æ€»æ—¶é•¿: 2h

âœ“ 2025-11-26 (å‘¨äºŒ) 23:30  2h â†’ 01:30âºÂ¹
```

**éªŒè¯è¦ç‚¹**ï¼š
- âœ… ç»“æŸæ—¶é—´æ˜¾ç¤ºè“è‰² `+1` ä¸Šæ ‡
- âœ… æ—¶é•¿è®¡ç®—æ­£ç¡®ï¼ˆè·¨å¤©ä¸å½±å“è®¡ç®—ï¼‰

---

### åœºæ™¯ 3ï¼šæŸ¥çœ‹æ— è®¡æ—¶è®°å½•çš„äº‹ä»¶

**æµ‹è¯•æ­¥éª¤**ï¼š
1. æ‰“å¼€ TimeCalendar é¡µé¢
2. åˆ›å»ºä¸€ä¸ªæ–°äº‹ä»¶ï¼ˆä¾‹å¦‚ï¼š"å¾…åŠä»»åŠ¡"ï¼‰
3. ä¸å¯åŠ¨ Timerï¼Œç›´æ¥æ‰“å¼€è¯¥äº‹ä»¶

**é¢„æœŸç»“æœ**ï¼š
```
å®é™…è¿›å±•

     è¿˜æ²¡æœ‰è®¡æ—¶è®°å½•
```

**éªŒè¯è¦ç‚¹**ï¼š
- âœ… æ˜¾ç¤ºå‹å¥½çš„ç©ºçŠ¶æ€æç¤º
- âœ… ä¸æ˜¾ç¤º"æ€»æ—¶é•¿"æ ‡ç­¾
- âœ… ç•Œé¢ä¸ä¼šæ˜¾ç¤ºç©ºç™½æˆ–é”™è¯¯

---

### åœºæ™¯ 4ï¼šéªŒè¯æ€»æ—¶é•¿è®¡ç®—å‡†ç¡®æ€§

**æµ‹è¯•æ­¥éª¤**ï¼š
1. åˆ›å»ºä¸€ä¸ªçˆ¶äº‹ä»¶ï¼Œå¯åŠ¨ Timer
2. è®¡æ—¶ 15 åˆ†é’Ÿååœæ­¢
3. å†æ¬¡å¯åŠ¨ï¼Œè®¡æ—¶ 30 åˆ†é’Ÿååœæ­¢
4. ç¬¬ä¸‰æ¬¡å¯åŠ¨ï¼Œè®¡æ—¶ 45 åˆ†é’Ÿååœæ­¢
5. æ‰“å¼€è¯¥äº‹ä»¶

**é¢„æœŸç»“æœ**ï¼š
```
å®é™…è¿›å±•                æ€»æ—¶é•¿: 1h30min

âœ“ 2025-11-27 (å‘¨ä¸‰) 10:00  15min â†’ 10:15
âœ“ 2025-11-27 (å‘¨ä¸‰) 10:20  30min â†’ 10:50
âœ“ 2025-11-27 (å‘¨ä¸‰) 11:00  45min â†’ 11:45
```

**éªŒè¯è¦ç‚¹**ï¼š
- âœ… æ€»æ—¶é•¿ = 15min + 30min + 45min = 1h30min
- âœ… æ¯ä¸ªç‰‡æ®µçš„æ—¶é•¿ç‹¬ç«‹æ˜¾ç¤º
- âœ… æ—¶é•¿æ ¼å¼åŒ–æ­£ç¡®ï¼ˆè¶…è¿‡ 60 åˆ†é’Ÿæ˜¾ç¤ºä¸º `Xh` æˆ– `XhYmin`ï¼‰

---

## ğŸ” è°ƒè¯•å·¥å…·

### æŸ¥çœ‹äº‹ä»¶çš„å­äº‹ä»¶åˆ—è¡¨

```javascript
const EventService = window.EventService || require('./services/EventService').EventService;

// è·å–çˆ¶äº‹ä»¶
const parentEvent = EventService.getEventById('your-event-id');
console.log('çˆ¶äº‹ä»¶:', parentEvent);
console.log('å­äº‹ä»¶ IDs:', parentEvent.timerLogs);

// è·å–æ‰€æœ‰å­äº‹ä»¶
const childEvents = parentEvent.timerLogs
  .map(id => EventService.getEventById(id))
  .filter(e => e !== null);
console.log('å­äº‹ä»¶åˆ—è¡¨:', childEvents);

// è®¡ç®—æ€»æ—¶é•¿
const totalDuration = childEvents.reduce((sum, e) => {
  const start = new Date(e.startTime).getTime();
  const end = new Date(e.endTime).getTime();
  return sum + (end - start);
}, 0);
console.log('æ€»æ—¶é•¿ï¼ˆæ¯«ç§’ï¼‰:', totalDuration);
console.log('æ€»æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰:', Math.floor(totalDuration / (1000 * 60)));
```

### å¼ºåˆ¶åˆ·æ–° EventEditModal

```javascript
// å¦‚æœæ•°æ®æ›´æ–°å Modal æœªåˆ·æ–°ï¼Œå°è¯•ï¼š
window.location.reload();
```

---

## ğŸ“Š æ€§èƒ½éªŒè¯

### æ¸²æŸ“æ€§èƒ½

- **å­äº‹ä»¶æ•°é‡**: å»ºè®®æµ‹è¯• 1-20 ä¸ªå­äº‹ä»¶
- **é¢„æœŸæ¸²æŸ“æ—¶é—´**: < 50msï¼ˆå³ä½¿ 20 ä¸ªå­äº‹ä»¶ï¼‰
- **å†…å­˜å ç”¨**: æ— æ˜æ˜¾å¢åŠ ï¼ˆä½¿ç”¨ React.useMemo ç¼“å­˜ï¼‰

### è®¡ç®—æ€§èƒ½

```javascript
// æµ‹è¯•æ€»æ—¶é•¿è®¡ç®—æ€§èƒ½
console.time('totalDuration');
const childEvents = [...]; // 20 ä¸ªå­äº‹ä»¶
const totalDuration = childEvents.reduce((sum, e) => {
  const start = new Date(e.startTime).getTime();
  const end = new Date(e.endTime).getTime();
  return sum + (end - start);
}, 0);
console.timeEnd('totalDuration');
// é¢„æœŸ: < 1ms
```

---

## âœ… éªŒæ”¶æ ‡å‡†

### åŠŸèƒ½å®Œæ•´æ€§

- [x] åŠ¨æ€æ¸²æŸ“ Timer å­äº‹ä»¶åˆ—è¡¨
- [x] æ€»æ—¶é•¿è‡ªåŠ¨è®¡ç®—å¹¶æ˜¾ç¤º
- [x] è·¨å¤©æ—¶é—´æ˜¾ç¤º `+1` æ ‡è®°
- [x] ç©ºçŠ¶æ€æ˜¾ç¤ºå‹å¥½æç¤º
- [x] æ—¶é—´æ ¼å¼ç»Ÿä¸€æ­£ç¡®

### è¾¹ç•Œæƒ…å†µ

- [x] æ— å­äº‹ä»¶ï¼šæ˜¾ç¤º"è¿˜æ²¡æœ‰è®¡æ—¶è®°å½•"
- [x] å•ä¸ªå­äº‹ä»¶ï¼šæ­£å¸¸æ˜¾ç¤º
- [x] 20+ å­äº‹ä»¶ï¼šåˆ—è¡¨å¯æ»šåŠ¨ï¼Œæ€§èƒ½æ­£å¸¸
- [x] å­äº‹ä»¶ç¼ºå°‘ startTime/endTimeï¼šè‡ªåŠ¨è·³è¿‡ï¼Œä¸æŠ¥é”™

### UI/UX

- [x] æ—¶é—´ç‰‡æ®µå¯¹é½ä¸€è‡´
- [x] æ€»æ—¶é•¿ä½ç½®æ­£ç¡®ï¼ˆå³ä¸Šè§’ï¼‰
- [x] è·¨å¤©æ ‡è®°æ¸…æ™°å¯è§
- [x] ç©ºçŠ¶æ€å±…ä¸­æ˜¾ç¤º

---

## ğŸ› å·²çŸ¥é—®é¢˜

### é—®é¢˜ 1ï¼šå®æ—¶æ›´æ–°å»¶è¿Ÿ

**ç—‡çŠ¶**ï¼šåœæ­¢ Timer åï¼Œéœ€è¦å…³é—­å¹¶é‡æ–°æ‰“å¼€ EventEditModal æ‰èƒ½çœ‹åˆ°æ–°ç‰‡æ®µ

**æ ¹å› **ï¼šEventEditModal çš„ `childEvents` ä¾èµ– `event?.timerLogs`ï¼Œè€Œ `event` prop æœªå®æ—¶æ›´æ–°

**è§£å†³æ–¹æ¡ˆ**ï¼ˆæœªæ¥ä¼˜åŒ–ï¼‰ï¼š
- æ–¹æ¡ˆ Aï¼šEventHub è§¦å‘äº‹ä»¶æ›´æ–°æ—¶ï¼Œé€šçŸ¥ Modal åˆ·æ–°
- æ–¹æ¡ˆ Bï¼šModal å†…éƒ¨ç›‘å¬ localStorage å˜åŒ–
- æ–¹æ¡ˆ Cï¼šä½¿ç”¨ Context ç®¡ç†å…¨å±€äº‹ä»¶çŠ¶æ€

**ä¸´æ—¶è§£å†³åŠæ³•**ï¼šå…³é—­å¹¶é‡æ–°æ‰“å¼€ Modal

---

## ğŸ“ ä»£ç ä½ç½®

**å®ç°æ–‡ä»¶**ï¼š`src/components/EventEditModal/EventEditModalV2.tsx`

**å…³é”®ä»£ç æ®µ**ï¼š

1. **æ—¶é•¿è®¡ç®—å·¥å…·å‡½æ•°**ï¼ˆL1390-1430ï¼‰ï¼š
   ```typescript
   const calculateTimerDuration = (timerEvent: Event): number => { ... }
   const formatDuration = (durationMs: number): string => { ... }
   const totalDuration = React.useMemo(() => { ... }, [childEvents]);
   ```

2. **åŠ¨æ€æ¸²æŸ“é€»è¾‘**ï¼ˆL2028-2100ï¼‰ï¼š
   ```tsx
   {childEvents.length > 0 ? (
     <div className="timer-segments-list">
       {childEvents.map((timerEvent) => { ... })}
     </div>
   ) : (
     <div>è¿˜æ²¡æœ‰è®¡æ—¶è®°å½•</div>
   )}
   ```

---

## ğŸ”„ ç‰ˆæœ¬å†å²

| ç‰ˆæœ¬ | æ—¥æœŸ | æ›´æ–°å†…å®¹ |
|------|------|---------|
| v2.16.0 | 2025-11-27 | å®ç°å®é™…è¿›å±•åŠ¨æ€æ•°æ®æ¸²æŸ“ï¼ˆP0 åŠŸèƒ½ï¼‰ |
| v2.15.2 | 2025-11-25 | è¿œç¨‹å›è°ƒå­—æ®µä¿æŠ¤æœºåˆ¶ |
| v2.15.1 | 2025-11-24 | syncMode åŒæ­¥æ¨¡å¼æ§åˆ¶ |

---

## ğŸ“– ç›¸å…³æ–‡æ¡£

- [EventEditModal V2 PRD](./PRD/EVENTEDITMODAL_V2_PRD.md)
- [Timer æ¨¡å— PRD](./PRD/TIMER_MODULE_PRD.md)
- [App æ¶æ„æ–‡æ¡£](./architecture/APP_ARCHITECTURE_PRD.md)
