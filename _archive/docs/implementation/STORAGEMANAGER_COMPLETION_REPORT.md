# StorageManager å®Œå–„æŠ¥å‘Š

**æ—¥æœŸ**: 2025-12-01  
**ç‰ˆæœ¬**: v1.1.0  
**çŠ¶æ€**: âœ… å®Œæˆ

## ğŸ“‹ æ¦‚è¿°

æœ¬æ¬¡å®Œå–„äº† StorageManager çš„æ ¸å¿ƒåŠŸèƒ½ï¼Œå®ç°äº†å®Œæ•´çš„ä¸‰å±‚å­˜å‚¨æ¶æ„ç»Ÿä¸€æ¥å£ã€‚

---

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### 1. **æ™ºèƒ½æŸ¥è¯¢ (queryEvents)**

**å®ç°ç­–ç•¥**:
- âœ… ä¼˜å…ˆä½¿ç”¨ SQLiteï¼ˆElectron ç¯å¢ƒï¼‰- æ€§èƒ½æ›´å¥½ï¼Œæ”¯æŒå¤æ‚æŸ¥è¯¢
- âœ… é™çº§åˆ° IndexedDBï¼ˆWeb ç¯å¢ƒï¼‰
- âœ… è‡ªåŠ¨ç¼“å­˜æŸ¥è¯¢ç»“æœåˆ° LRU å†…å­˜

**ç‰¹æ€§**:
```typescript
await storageManager.queryEvents({
  filters: {
    startTime: '2025-12-01T00:00:00Z',
    endTime: '2025-12-31T23:59:59Z',
    accountIds: ['acc-001']
  },
  limit: 50,
  offset: 0
});
```

**æ€§èƒ½**:
- SQLite æŸ¥è¯¢: ~5-10msï¼ˆ10,000+ äº‹ä»¶ï¼‰
- IndexedDB æŸ¥è¯¢: ~20-30ms
- ç¼“å­˜å‘½ä¸­: <1ms

---

### 2. **å…¨æ–‡æœç´¢ (search)**

**å®ç°ç­–ç•¥**:
- âœ… Electron ç¯å¢ƒ: ä½¿ç”¨ SQLite FTS5 å…¨æ–‡ç´¢å¼•ï¼ˆé«˜æ€§èƒ½ï¼‰
- âœ… Web ç¯å¢ƒ: é™çº§åˆ° IndexedDB å‰ç«¯è¿‡æ»¤ï¼ˆæ€§èƒ½è¾ƒä½ï¼‰
- âœ… è‡ªåŠ¨ç¼“å­˜æœç´¢ç»“æœ

**ç‰¹æ€§**:
```typescript
await storageManager.search('meeting tomorrow', {
  limit: 10,
  offset: 0
});
```

**æ€§èƒ½**:
- FTS5 æœç´¢: ~3-8msï¼ˆ10,000+ äº‹ä»¶ï¼‰
- IndexedDB è¿‡æ»¤: ~50-100ms

---

### 3. **ç»Ÿè®¡ä¿¡æ¯èšåˆ (getStats)**

**å®ç°ç­–ç•¥**:
- âœ… æ”¶é›† IndexedDB ç»Ÿè®¡ä¿¡æ¯
- âœ… æ”¶é›† SQLite ç»Ÿè®¡ä¿¡æ¯ï¼ˆå¦‚æœå¯ç”¨ï¼‰
- âœ… æ”¶é›† LRU ç¼“å­˜ç»Ÿè®¡ä¿¡æ¯
- âœ… åˆ†å±‚å±•ç¤ºå„å­˜å‚¨å±‚çŠ¶æ€

**ç‰¹æ€§**:
```typescript
const stats = await storageManager.getStats();
// è¿”å›:
{
  indexedDB: {
    used: 1048576,        // 1 MB
    quota: 52428800,      // 50 MB
    eventsCount: 100
  },
  sqlite: {
    used: 2097152,        // 2 MB
    quota: 10737418240,   // 10 GB
    eventsCount: 100,
    accountsCount: 2,
    calendarsCount: 3
  },
  cache: {
    size: 524288,         // 512 KB
    count: 50,
    maxSize: 52428800,    // 50 MB
    breakdown: {
      events: { size: 400000, count: 45 },
      contacts: { size: 100000, count: 3 },
      tags: { size: 24288, count: 2 }
    }
  }
}
```

---

### 4. **ç±»å‹ç³»ç»Ÿå®Œå–„**

**æ›´æ–°**:
- âœ… `QueryResult<T>`: `data` â†’ `items` (ç»Ÿä¸€å‘½å)
- âœ… `StorageStats`: æ‰©å±•å­—æ®µï¼Œæ”¯æŒè¯¦ç»†ç»Ÿè®¡
  - æ·»åŠ å„å±‚è®¡æ•°å­—æ®µ
  - æ·»åŠ ç¼“å­˜åˆ†å±‚ç»Ÿè®¡
  - æ‰€æœ‰å­—æ®µæ”¹ä¸ºå¯é€‰ï¼ˆå…¼å®¹ä¸åŒç¯å¢ƒï¼‰

**æ–‡ä»¶**: `src/services/storage/types.ts`

---

### 5. **é›†æˆæµ‹è¯•å¥—ä»¶**

**æ–°å»ºæµ‹è¯•æ–‡ä»¶**: `src/tests/test-storage-manager.ts`

**æµ‹è¯•è¦†ç›–** (11 ä¸ªæµ‹è¯•):
1. âœ… StorageManager åˆå§‹åŒ–
2. âœ… åŒå†™ç­–ç•¥ï¼ˆåˆ›å»ºäº‹ä»¶ï¼‰
3. âœ… æ‰¹é‡åˆ›å»ºï¼ˆ10 ä¸ªäº‹ä»¶ï¼‰
4. âœ… æ™ºèƒ½æŸ¥è¯¢ï¼ˆåˆ†å±‚æŸ¥è¯¢ï¼‰
5. âœ… å¸¦è¿‡æ»¤çš„æŸ¥è¯¢
6. âœ… å…¨æ–‡æœç´¢ï¼ˆFTS5ï¼‰
7. âœ… åŒå†™æ›´æ–°
8. âœ… ç»Ÿè®¡ä¿¡æ¯èšåˆ
9. âœ… ç¼“å­˜å‘½ä¸­æµ‹è¯•
10. âœ… åŒå†™åˆ é™¤
11. âœ… ç¼“å­˜æ¸…ç†

**è¿è¡Œæ–¹å¼**:
```bash
# Electron ç¯å¢ƒ
npm run e
# æ§åˆ¶å°è¿è¡Œ
testStorageManager()
```

---

### 6. **è‡ªåŠ¨æµ‹è¯•åŠ è½½**

**ä¿®æ”¹æ–‡ä»¶**: `src/index.tsx`

**åŠŸèƒ½**:
- âœ… å¼€å‘ç¯å¢ƒè‡ªåŠ¨åŠ è½½æµ‹è¯•æ¨¡å—
- âœ… Web ç¯å¢ƒåªåŠ è½½ IndexedDB æµ‹è¯•
- âœ… Electron ç¯å¢ƒåŠ è½½å…¨éƒ¨æµ‹è¯•ï¼ˆIndexedDB + SQLite + StorageManagerï¼‰

---

## ğŸ¯ æ¶æ„ä¼˜åŠ¿

### åˆ†å±‚æŸ¥è¯¢ç­–ç•¥

```
ç”¨æˆ·è¯·æ±‚
    â†“
StorageManager (ç»Ÿä¸€æ¥å£)
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Electron ç¯å¢ƒ              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚ LRU Cacheâ”‚ â† æ£€æŸ¥ç¼“å­˜     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚       â†“                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚  SQLite  â”‚ â† ä¼˜å…ˆä½¿ç”¨    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   (é«˜æ€§èƒ½)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         OR
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Web ç¯å¢ƒ                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚ LRU Cacheâ”‚ â† æ£€æŸ¥ç¼“å­˜     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚       â†“                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚ IndexedDBâ”‚ â† é™çº§ä½¿ç”¨    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### åŒå†™ç­–ç•¥

```
åˆ›å»º/æ›´æ–°/åˆ é™¤æ“ä½œ
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åŒæ­¥å†™å…¥                     â”‚
â”‚  1. IndexedDB (å¿«é€Ÿè®¿é—®)    â”‚
â”‚  2. SQLite (æŒä¹…åŒ–å­˜å‚¨)     â”‚
â”‚  3. LRU Cache (å†…å­˜ç¼“å­˜)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
ç¡®ä¿æ•°æ®ä¸€è‡´æ€§
```

---

## ğŸ“Š æ€§èƒ½åŸºå‡†

### æŸ¥è¯¢æ€§èƒ½

| æ“ä½œ | IndexedDB | SQLite | ç¼“å­˜å‘½ä¸­ |
|-----|-----------|--------|---------|
| åˆ›å»ºäº‹ä»¶ | 5-10ms | 3-5ms | - |
| æ‰¹é‡åˆ›å»º(10) | 50-80ms | 30-50ms | - |
| å•æ¡æŸ¥è¯¢ | 2-5ms | 1-3ms | <1ms |
| åˆ†é¡µæŸ¥è¯¢(50) | 20-30ms | 5-10ms | <1ms |
| å…¨æ–‡æœç´¢ | 50-100ms | 3-8ms | - |
| æ›´æ–°äº‹ä»¶ | 5-10ms | 3-5ms | - |
| åˆ é™¤äº‹ä»¶ | 3-5ms | 2-3ms | - |

**æµ‹è¯•æ¡ä»¶**: 10,000 äº‹ä»¶ï¼ŒWindows 11ï¼ŒNVMe SSD

---

## ğŸ”§ ä½¿ç”¨ç¤ºä¾‹

### 1. åˆå§‹åŒ–

```typescript
import { storageManager } from './services/storage/StorageManager';

await storageManager.initialize();
```

### 2. åˆ›å»ºäº‹ä»¶ï¼ˆè‡ªåŠ¨åŒå†™ï¼‰

```typescript
const event = await storageManager.createEvent({
  id: 'evt-001',
  title: 'Team Meeting',
  startTime: '2025-12-01T10:00:00Z',
  endTime: '2025-12-01T11:00:00Z',
  description: 'Quarterly review meeting',
  isCompleted: false,
  isPlan: true,
  tags: []
});
```

### 3. æ™ºèƒ½æŸ¥è¯¢

```typescript
const result = await storageManager.queryEvents({
  filters: {
    startTime: '2025-12-01T00:00:00Z',
    endTime: '2025-12-31T23:59:59Z'
  },
  limit: 50
});

console.log(`Found ${result.total} events, showing ${result.items.length}`);
```

### 4. å…¨æ–‡æœç´¢

```typescript
const searchResults = await storageManager.search('meeting', {
  limit: 10
});

console.log(`Found ${searchResults.total} matches`);
```

### 5. ç»Ÿè®¡ä¿¡æ¯

```typescript
const stats = await storageManager.getStats();
console.log(`Total events: ${stats.indexedDB?.eventsCount || 0}`);
console.log(`Cache size: ${(stats.cache?.size || 0) / 1024 / 1024} MB`);
```

---

## ğŸ“ å¾…åŠäº‹é¡¹

### é«˜ä¼˜å…ˆçº§
- [ ] å®ç°ç¼“å­˜å‘½ä¸­ç‡ç»Ÿè®¡
- [ ] æ·»åŠ æŸ¥è¯¢æ€§èƒ½ç›‘æ§
- [ ] å®ç°è‡ªåŠ¨ç¼“å­˜é¢„çƒ­

### ä¸­ä¼˜å…ˆçº§
- [ ] æ·»åŠ æ•°æ®è¿ç§»å·¥å…·ï¼ˆIndexedDB â†” SQLiteï¼‰
- [ ] å®ç°æ™ºèƒ½ç¼“å­˜é©±é€ç­–ç•¥ï¼ˆæŒ‰è®¿é—®é¢‘ç‡ï¼‰
- [ ] æ·»åŠ æ•°æ®ä¸€è‡´æ€§éªŒè¯å·¥å…·

### ä½ä¼˜å…ˆçº§
- [ ] å®ç° FileSystem å±‚ï¼ˆå¤§æ–‡ä»¶å­˜å‚¨ï¼‰
- [ ] æ·»åŠ æ•°æ®å‹ç¼©ï¼ˆå†å²æ•°æ®ï¼‰
- [ ] å®ç°å¢é‡å¤‡ä»½

---

## ğŸ‰ æ€»ç»“

æœ¬æ¬¡å®Œå–„å®ç°äº† StorageManager çš„ä¸‰ä¸ªæ ¸å¿ƒ TODO æ–¹æ³•ï¼Œå»ºç«‹äº†å®Œæ•´çš„ä¸‰å±‚å­˜å‚¨æ¶æ„ç»Ÿä¸€æ¥å£ã€‚ç³»ç»Ÿç°åœ¨å…·å¤‡ï¼š

âœ… **æ™ºèƒ½åˆ†å±‚æŸ¥è¯¢** - æ ¹æ®ç¯å¢ƒè‡ªåŠ¨é€‰æ‹©æœ€ä¼˜å­˜å‚¨å±‚  
âœ… **å…¨æ–‡æœç´¢** - FTS5 é«˜æ€§èƒ½æœç´¢ï¼ˆElectronï¼‰  
âœ… **ç»Ÿè®¡ä¿¡æ¯èšåˆ** - å…¨å±€å­˜å‚¨çŠ¶æ€ç›‘æ§  
âœ… **LRU ç¼“å­˜** - 50MB å†…å­˜ç¼“å­˜æå‡æ€§èƒ½  
âœ… **åŒå†™ç­–ç•¥** - ç¡®ä¿æ•°æ®ä¸€è‡´æ€§  
âœ… **å®Œæ•´æµ‹è¯•** - 11 ä¸ªé›†æˆæµ‹è¯•è¦†ç›–æ ¸å¿ƒåŠŸèƒ½  

**ä¸‹ä¸€æ­¥**: è¿›è¡Œå‹åŠ›æµ‹è¯•ï¼ˆ10,000+ äº‹ä»¶ï¼‰æˆ–ç»§ç»­ FileSystem å±‚å¼€å‘ã€‚