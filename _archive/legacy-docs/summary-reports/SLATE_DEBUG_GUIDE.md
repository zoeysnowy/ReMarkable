# Slate 编辑器调试指南

## 🎯 目的

当你在 Plan 页面编辑时遇到问题（如键盘行为异常、光标跳动、文本显示错误等），但很难向我完整描述问题时，可以使用这个调试系统来记录详细的操作日志。

## 📋 快速开始

### 1. 启用调试模式

在浏览器控制台（F12）中运行以下命令：

```javascript
window.SLATE_DEBUG = true
localStorage.setItem('SLATE_DEBUG', 'true')
```

然后刷新页面（F5）。

你会看到提示信息：
```
[🚀] SLATE_DEBUG 已启用
💡 提示：关闭调试请运行: window.SLATE_DEBUG = false; localStorage.removeItem("SLATE_DEBUG")
```

### 2. 开始编辑

现在在 Plan 页面的编辑器中进行操作，控制台会自动记录：

- ⌨️ **键盘事件**：每个按键、组合键
- 🎯 **光标位置**：当前节点、选区、文本内容
- 📝 **内容变化**：节点增删、文本修改
- 🔄 **DOM 变化**：元素添加/删除、文本变化、属性修改
- ⚡ **操作日志**：Enter、Tab、Delete 等特殊操作

### 3. 复制日志

在控制台中：
- 右键点击某个日志组 → "Save as..." 保存日志
- 或者直接复制相关的日志内容

### 4. 关闭调试

```javascript
window.SLATE_DEBUG = false
localStorage.removeItem('SLATE_DEBUG')
```

刷新页面即可。

---

## 📊 日志类型详解

### ⌨️ 键盘事件日志

每次按键都会记录：

```
[⌨️ HH:MM:SS.mmm] Shift+Enter
  📋 按键信息:
    key: "Enter"
    code: "Enter"
    shiftKey: true
    ctrlKey: false
    altKey: false
    metaKey: false
    isComposing: false
  
  📍 光标位置:
    节点路径: [2]
    Line ID: "abc123..."
    显示模式: "标题行"
    缩进层级: 1
    当前文本: "这是一行任务"
    文本长度: 6
  
  🎯 选区详情:
    类型: "光标"
    Anchor: [2,0,0] offset:3
    Focus: [2,0,0] offset:3
    是否折叠: true
```

**说明**：
- `节点路径`：当前光标所在节点的索引
- `Line ID`：唯一标识符（截取后10位）
- `显示模式`：标题行或描述行
- `缩进层级`：0-5 的层级
- `Anchor/Focus`：选区的起点和终点

### 📝 内容变化日志

编辑器内容发生变化时：

```
[📝 HH:MM:SS.mmm] 内容变化
  📊 变化统计:
    旧节点数: 5
    新节点数: 6
    变化: +1
  
  📄 新节点列表:
    0. [标题] xyz789... "待办事项1" (L0)
    1. [描述] xyz789... "详细说明" (L1)
    2. [标题] abc123... "新创建的任务" (L0)
    3. [标题] def456... "待办事项2" (L0)
    ...
```

**说明**：
- `(L0)`：层级 0（无缩进）
- `(L1)`：层级 1（缩进一次）
- 每个节点显示：索引、类型、ID、文本内容、层级

### ⚡ 操作日志

特殊操作（Enter、Delete 等）：

```
[⚡ HH:MM:SS.mmm] Enter - 创建新行
  📋 操作详情:
    currentLine: 2
    lineId: "abc123..."
    mode: "title"
    level: 1
    insertIndex: 3
    newLineId: "xyz789..."
    totalLines: 5
```

### 🔄 DOM 变化日志

DOM 结构变化：

```
[🔄 HH:MM:SS.mmm] DOM: 子节点变化
  addedNodes: 1
  removedNodes: 0
  target: "DIV"
```

### 🖱️ 焦点/点击日志

用户交互：

```
[🖱️ HH:MM:SS.mmm] CLICK
  📍 光标位置: (同键盘事件的选区信息)
  附加信息:
    clientX: 456
    clientY: 234
```

---

## 🛠️ 高级调试命令

### 查看编辑器完整快照

在控制台运行：

```javascript
window.slateEditorSnapshot()
```

输出：

```
[📸 HH:MM:SS.mmm] 编辑器快照
  📄 所有节点:
    0. [title] ID:abc123 L0 "待办事项1"
    1. [description] ID:abc123 L1 "详细说明"
    2. [title] ID:def456 L0 "待办事项2"
    ...
  
  🎯 当前选区:
    (同上)
  
  📊 统计:
    总节点数: 8
    是否有选区: true
```

---

## 💡 使用场景示例

### 场景 1：输入文字时光标跳动

1. 启用调试模式
2. 在编辑器中输入几个字符
3. 观察控制台的键盘事件和内容变化日志
4. 复制日志发给我，我可以看到：
   - 每个按键的详细信息
   - 每次文本变化后的节点状态
   - 光标位置的变化轨迹

### 场景 2：按 Enter 后行为异常

1. 启用调试模式
2. 按 Enter 键
3. 查看 `[⚡] Enter - 创建新行` 日志
4. 可以看到：
   - 当前行的状态
   - 新行插入的位置
   - 是否正确继承了层级

### 场景 3：删除操作不符合预期

1. 启用调试模式
2. 按 Backspace 或 Delete
3. 查看 `[⚡] Backspace - 删除空行` 或相关日志
4. 可以看到：
   - 删除前的节点状态
   - 执行的具体操作
   - 删除后的结果

### 场景 4：粘贴内容后格式错误

1. 启用调试模式
2. 复制一些内容
3. 粘贴到编辑器
4. 查看 DOM 变化和内容变化日志
5. 可以看到：
   - 粘贴的原始内容
   - 解析后的节点结构
   - 最终生成的编辑器内容

---

## 📤 如何向我反馈问题

### 1. 准备日志

启用调试模式后，**重现问题**一次，复制相关的控制台日志。

### 2. 描述步骤

简单描述你的操作步骤，例如：

```
1. 打开 Plan 页面
2. 输入"待办事项1"
3. 按 Enter 创建新行
4. 输入"待办事项2"
5. 此时发现光标跳到了第一行
```

### 3. 附上日志

粘贴相关的控制台日志，特别是：
- 键盘事件日志（⌨️）
- 内容变化日志（📝）
- 操作日志（⚡）

### 4. 截图（可选）

如果问题涉及视觉效果，也可以附上截图。

---

## ⚙️ 调试配置

### 临时启用（刷新后失效）

```javascript
window.SLATE_DEBUG = true
```

### 持久启用（刷新后保持）

```javascript
window.SLATE_DEBUG = true
localStorage.setItem('SLATE_DEBUG', 'true')
```

### 关闭调试

```javascript
window.SLATE_DEBUG = false
localStorage.removeItem('SLATE_DEBUG')
```

---

## 🎨 日志颜色说明

- 🟠 **橙色背景**：键盘事件
- 🟢 **绿色背景**：内容变化
- 🔵 **蓝色背景**：编辑器快照
- 🟣 **紫色背景**：DOM 变化
- 🔴 **红色背景**：错误
- 🟤 **棕色背景**：结构化信息
- 🔘 **灰色背景**：焦点/点击事件

---

## ⚠️ 注意事项

1. **性能影响**：调试模式会记录大量日志，可能略微影响编辑器性能。日常使用时请关闭。

2. **日志量**：频繁编辑会产生大量日志，建议只在需要调试时启用，并且只重现一次问题即可。

3. **隐私**：日志中会包含你输入的文本内容，分享日志前请确认没有敏感信息。

4. **浏览器控制台**：确保你熟悉如何打开浏览器控制台（F12 或 Ctrl+Shift+I）。

---

## 🔧 故障排除

### Q: 启用调试后看不到日志？

A: 
1. 检查控制台是否打开（F12）
2. 检查控制台是否设置了日志过滤（应该显示所有级别）
3. 尝试刷新页面
4. 确认 `window.SLATE_DEBUG` 的值为 `true`

### Q: 日志太多看不清？

A: 
1. 使用控制台的搜索功能（Ctrl+F）
2. 点击某个日志组展开/折叠
3. 清空控制台（右键 → Clear console）后重新操作
4. 使用过滤器只显示特定类型的日志

### Q: 如何只看键盘事件？

A: 在控制台的过滤框中输入 `⌨️` 或 `按键`

### Q: 如何保存日志？

A: 
1. 右键控制台 → "Save as..."
2. 或者选中日志内容 → 复制 → 粘贴到文本文件

---

## 📚 相关文档

- [Slate 编辑器开发指南](./SLATE_DEVELOPMENT_GUIDE.md)
- [Plan Manager 模块 PRD](./PRD/PLANMANAGER_MODULE_PRD.md)
- [调试日志系统实现](../src/components/PlanSlate/debugLogger.ts)

---

**最后更新**: 2025-11-08  
**适用版本**: v1.7+
