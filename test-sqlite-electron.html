<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Test SQLite in Electron</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1000px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        h1 {
            color: #333;
        }
        #results {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-top: 20px;
        }
        .test-item {
            margin: 15px 0;
            padding: 15px;
            border-left: 4px solid #ddd;
        }
        .test-item.success {
            border-left-color: #4caf50;
            background: #f1f8f4;
        }
        .test-item.error {
            border-left-color: #f44336;
            background: #fef1f0;
        }
        .test-name {
            font-weight: bold;
            margin-bottom: 8px;
            color: #333;
        }
        .test-message {
            color: #666;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
        button {
            background: #2196F3;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
        }
        button:hover {
            background: #1976D2;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            border-left: 4px solid #2196F3;
        }
    </style>
</head>
<body>
    <h1>ğŸ§ª SQLite Electron Test Suite</h1>
    
    <div class="info">
        <strong>æµ‹è¯•ç›®æ ‡ï¼š</strong> éªŒè¯ better-sqlite3 åœ¨ Electron ä¸­æ˜¯å¦æ­£å¸¸å·¥ä½œ
        <br><strong>ç¼–è¯‘ç›®æ ‡ï¼š</strong> Electron 27.3.11 (Node.js v18 - MODULE_VERSION 118)
    </div>

    <button id="testBtn" onclick="runAllTests()">ğŸš€ è¿è¡Œæ‰€æœ‰æµ‹è¯•</button>
    <button onclick="clearResults()">ğŸ—‘ï¸ æ¸…é™¤ç»“æœ</button>
    
    <div id="results"></div>

    <script>
        const results = document.getElementById('results');
        const testBtn = document.getElementById('testBtn');
        
        let dbId = null;

        function addResult(testName, success, message) {
            const item = document.createElement('div');
            item.className = `test-item ${success ? 'success' : 'error'}`;
            item.innerHTML = `
                <div class="test-name">${success ? 'âœ…' : 'âŒ'} ${testName}</div>
                <div class="test-message">${message}</div>
            `;
            results.appendChild(item);
        }

        function clearResults() {
            results.innerHTML = '';
        }

        async function runAllTests() {
            clearResults();
            testBtn.disabled = true;
            
            try {
                // Test 1: Check if SQLite is available
                addResult(
                    'Test 1: SQLite å¯ç”¨æ€§æ£€æŸ¥',
                    true,
                    `window.electronAPI.sqlite.available = ${window.electronAPI?.sqlite?.available}`
                );

                if (!window.electronAPI?.sqlite?.available) {
                    throw new Error('SQLite not available in this Electron build');
                }

                // Test 2: Create database
                const dbPath = ':memory:'; // In-memory database for testing
                const dbResult = await window.electronAPI.sqlite.createDatabase(dbPath, {});
                dbId = dbResult.dbId;
                addResult(
                    'Test 2: åˆ›å»ºæ•°æ®åº“',
                    dbResult.success,
                    `Database ID: ${dbId}`
                );

                // Test 3: Create table
                await window.electronAPI.sqlite.exec(dbId, `
                    CREATE TABLE test_users (
                        id INTEGER PRIMARY KEY AUTOINCREMENT,
                        name TEXT NOT NULL,
                        email TEXT UNIQUE,
                        created_at INTEGER
                    )
                `);
                addResult('Test 3: åˆ›å»ºè¡¨', true, 'Table "test_users" created');

                // Test 4: Insert data
                const stmtId1 = await window.electronAPI.sqlite.prepare(
                    dbId,
                    'INSERT INTO test_users (name, email, created_at) VALUES (?, ?, ?)'
                );
                
                const insertResult = await window.electronAPI.sqlite.run(
                    stmtId1,
                    ['Alice', 'alice@example.com', Date.now()]
                );
                addResult(
                    'Test 4: æ’å…¥æ•°æ®',
                    insertResult.changes === 1,
                    `Inserted 1 row, lastInsertRowid: ${insertResult.lastInsertRowid}`
                );

                // Test 5: Insert multiple rows
                for (let i = 0; i < 5; i++) {
                    await window.electronAPI.sqlite.run(
                        stmtId1,
                        [`User${i}`, `user${i}@test.com`, Date.now()]
                    );
                }
                addResult('Test 5: æ‰¹é‡æ’å…¥', true, 'Inserted 5 more rows');

                // Test 6: Query single row
                const stmtId2 = await window.electronAPI.sqlite.prepare(
                    dbId,
                    'SELECT * FROM test_users WHERE name = ?'
                );
                const user = await window.electronAPI.sqlite.get(stmtId2, ['Alice']);
                addResult(
                    'Test 6: æŸ¥è¯¢å•è¡Œ',
                    user && user.name === 'Alice',
                    `Found user: ${JSON.stringify(user)}`
                );

                // Test 7: Query all rows
                const stmtId3 = await window.electronAPI.sqlite.prepare(
                    dbId,
                    'SELECT * FROM test_users ORDER BY id'
                );
                const allUsers = await window.electronAPI.sqlite.all(stmtId3, []);
                addResult(
                    'Test 7: æŸ¥è¯¢æ‰€æœ‰è¡Œ',
                    allUsers.length === 6,
                    `Found ${allUsers.length} users: ${allUsers.map(u => u.name).join(', ')}`
                );

                // Test 8: Test PRAGMA
                const journalMode = await window.electronAPI.sqlite.pragma(dbId, 'journal_mode = WAL');
                addResult(
                    'Test 8: PRAGMA è®¾ç½®',
                    journalMode === 'wal',
                    `Journal mode set to: ${journalMode}`
                );

                // Test 9: Test transactions (via exec)
                await window.electronAPI.sqlite.exec(dbId, `
                    BEGIN TRANSACTION;
                    UPDATE test_users SET name = 'Alice Updated' WHERE name = 'Alice';
                    COMMIT;
                `);
                const updated = await window.electronAPI.sqlite.get(stmtId2, ['Alice Updated']);
                addResult(
                    'Test 9: äº‹åŠ¡æµ‹è¯•',
                    updated && updated.name === 'Alice Updated',
                    `Transaction successful, updated user: ${JSON.stringify(updated)}`
                );

                // Test 10: Close database
                await window.electronAPI.sqlite.close(dbId);
                addResult('Test 10: å…³é—­æ•°æ®åº“', true, 'Database closed successfully');
                dbId = null;

                // Summary
                addResult(
                    'ğŸ‰ æµ‹è¯•æ€»ç»“',
                    true,
                    'All 10 tests passed! better-sqlite3 is working perfectly in Electron!'
                );

            } catch (error) {
                addResult('âŒ Test Failed', false, error.message + '\n' + error.stack);
            } finally {
                testBtn.disabled = false;
            }
        }

        // Auto-run tests on load
        window.addEventListener('load', () => {
            setTimeout(() => runAllTests(), 500);
        });
    </script>
</body>
</html>
