<!DOCTYPE html>
<html>
<head>
    <title>LocalStorage è¯Šæ–­å·¥å…·</title>
    <style>
        body { font-family: monospace; padding: 20px; }
        .large { color: red; font-weight: bold; }
        .medium { color: orange; }
        .small { color: green; }
        pre { background: #f5f5f5; padding: 10px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>ğŸ” LocalStorage å­˜å‚¨åˆ†æ</h1>
    
    <h2>1. å­˜å‚¨ä½¿ç”¨æƒ…å†µ</h2>
    <div id="storage-usage"></div>
    
    <h2>2. åŒæ­¥é˜Ÿåˆ—åˆ†æ</h2>
    <div id="sync-queue"></div>
    
    <h2>3. æ¸…ç†æ“ä½œ</h2>
    <button onclick="clearOldActions()">æ¸…ç†æ—§çš„åŒæ­¥æ“ä½œ</button>
    <button onclick="clearDuplicateActions()">æ¸…ç†é‡å¤æ“ä½œ</button>
    <button onclick="resetSyncQueue()">é‡ç½®æ•´ä¸ªé˜Ÿåˆ—</button>
    
    <h2>4. åŒ¹é…é€»è¾‘æµ‹è¯•</h2>
    <div id="match-test"></div>
    
    <script>
        // åˆ†æå­˜å‚¨ä½¿ç”¨
        function analyzeStorage() {
            const usage = document.getElementById('storage-usage');
            let totalSize = 0;
            const items = [];
            
            for (let key in localStorage) {
                if (localStorage.hasOwnProperty(key)) {
                    const value = localStorage[key];
                    const size = (value.length + key.length) * 2; // ä¼°ç®—å­—èŠ‚æ•°
                    totalSize += size;
                    items.push({ key, size, valueLength: value.length });
                }
            }
            
            items.sort((a, b) => b.size - a.size);
            
            let html = `<p>æ€»ä½¿ç”¨: <strong>${(totalSize / 1024 / 1024).toFixed(2)} MB</strong></p>`;
            html += `<p>å‰©ä½™ç©ºé—´: <strong>${((10 * 1024 * 1024 - totalSize) / 1024 / 1024).toFixed(2)} MB</strong></p>`;
            html += '<h3>å¤§å­˜å‚¨é¡¹:</h3><ul>';
            
            items.slice(0, 10).forEach(item => {
                const sizeKB = item.size / 1024;
                const className = sizeKB > 500 ? 'large' : sizeKB > 100 ? 'medium' : 'small';
                html += `<li class="${className}">${item.key}: ${sizeKB.toFixed(2)} KB (${item.valueLength} å­—ç¬¦)</li>`;
            });
            
            html += '</ul>';
            usage.innerHTML = html;
        }
        
        // åˆ†æåŒæ­¥é˜Ÿåˆ—
        function analyzeSyncQueue() {
            const queueDiv = document.getElementById('sync-queue');
            
            try {
                const actions = JSON.parse(localStorage.getItem('remarkable-sync-actions') || '[]');
                
                let html = `<p>é˜Ÿåˆ—æ€»æ•°: <strong>${actions.length}</strong></p>`;
                
                // ç»Ÿè®¡ç±»å‹
                const types = {};
                const sources = {};
                const entities = {};
                
                actions.forEach(action => {
                    types[action.type] = (types[action.type] || 0) + 1;
                    sources[action.source] = (sources[action.source] || 0) + 1;
                    
                    const entityKey = `${action.type}-${action.entityType}-${action.entityId}`;
                    entities[entityKey] = (entities[entityKey] || 0) + 1;
                });
                
                html += '<h4>æŒ‰ç±»å‹ç»Ÿè®¡:</h4><pre>' + JSON.stringify(types, null, 2) + '</pre>';
                html += '<h4>æŒ‰æ¥æºç»Ÿè®¡:</h4><pre>' + JSON.stringify(sources, null, 2) + '</pre>';
                
                // æŸ¥æ‰¾é‡å¤æ“ä½œ
                const duplicates = Object.entries(entities).filter(([k, v]) => v > 1);
                if (duplicates.length > 0) {
                    html += '<h4>é‡å¤æ“ä½œ (å‰20ä¸ª):</h4><ul>';
                    duplicates.slice(0, 20).forEach(([key, count]) => {
                        html += `<li class="medium">${key}: ${count} æ¬¡</li>`;
                    });
                    html += '</ul>';
                }
                
                queueDiv.innerHTML = html;
            } catch (e) {
                queueDiv.innerHTML = `<p style="color: red;">è§£æé˜Ÿåˆ—å¤±è´¥: ${e.message}</p>`;
            }
        }
        
        // æ¸…ç†æ—§æ“ä½œ
        function clearOldActions() {
            try {
                const actions = JSON.parse(localStorage.getItem('remarkable-sync-actions') || '[]');
                const oneDayAgo = Date.now() - 24 * 60 * 60 * 1000;
                
                const filtered = actions.filter(action => {
                    const timestamp = new Date(action.timestamp).getTime();
                    return timestamp > oneDayAgo;
                });
                
                localStorage.setItem('remarkable-sync-actions', JSON.stringify(filtered));
                console.log(`æ¸…ç†äº† ${actions.length - filtered.length} ä¸ªæ—§æ“ä½œ`);
                analyzeSyncQueue();
                analyzeStorage();
            } catch (e) {
                console.error('æ¸…ç†å¤±è´¥:', e);
            }
        }
        
        // æ¸…ç†é‡å¤æ“ä½œ
        function clearDuplicateActions() {
            try {
                const actions = JSON.parse(localStorage.getItem('remarkable-sync-actions') || '[]');
                const seen = new Set();
                const filtered = [];
                
                // åªä¿ç•™æ¯ä¸ªå®ä½“çš„æœ€æ–°æ“ä½œ
                actions.reverse().forEach(action => {
                    const key = `${action.type}-${action.entityType}-${action.entityId}`;
                    if (!seen.has(key)) {
                        seen.add(key);
                        filtered.push(action);
                    }
                });
                
                filtered.reverse();
                localStorage.setItem('remarkable-sync-actions', JSON.stringify(filtered));
                console.log(`æ¸…ç†äº† ${actions.length - filtered.length} ä¸ªé‡å¤æ“ä½œ`);
                analyzeSyncQueue();
                analyzeStorage();
            } catch (e) {
                console.error('æ¸…ç†å¤±è´¥:', e);
            }
        }
        
        // é‡ç½®é˜Ÿåˆ—
        function resetSyncQueue() {
            if (confirm('ç¡®å®šè¦é‡ç½®æ•´ä¸ªåŒæ­¥é˜Ÿåˆ—å—ï¼Ÿè¿™å°†æ¸…é™¤æ‰€æœ‰å¾…åŒæ­¥çš„æ“ä½œã€‚')) {
                localStorage.removeItem('remarkable-sync-actions');
                console.log('å·²é‡ç½®åŒæ­¥é˜Ÿåˆ—');
                analyzeSyncQueue();
                analyzeStorage();
            }
        }
        
        // æµ‹è¯•åŒ¹é…é€»è¾‘
        function testMatchLogic() {
            const testDiv = document.getElementById('match-test');
            
            try {
                const events = JSON.parse(localStorage.getItem('remarkable-events') || '[]');
                
                // æŸ¥æ‰¾æ²¡æœ‰ externalId çš„æœ¬åœ°äº‹ä»¶
                const localEvents = events.filter(e => !e.externalId && (e.id.startsWith('local-') || e.remarkableSource));
                
                // æŸ¥æ‰¾æœ‰ externalId ä½†å¯èƒ½é‡å¤çš„äº‹ä»¶
                const externalEvents = events.filter(e => e.externalId);
                
                let html = `<p>æ²¡æœ‰ externalId çš„æœ¬åœ°äº‹ä»¶: <strong>${localEvents.length}</strong></p>`;
                html += `<p>æœ‰ externalId çš„äº‹ä»¶: <strong>${externalEvents.length}</strong></p>`;
                
                if (localEvents.length > 0) {
                    html += '<h4>æœ€è¿‘çš„æœ¬åœ°äº‹ä»¶:</h4><ul>';
                    localEvents.slice(0, 10).forEach(event => {
                        html += `<li>${event.id} - ${event.title} (${event.createdAt})</li>`;
                    });
                    html += '</ul>';
                }
                
                testDiv.innerHTML = html;
            } catch (e) {
                testDiv.innerHTML = `<p style="color: red;">åˆ†æäº‹ä»¶å¤±è´¥: ${e.message}</p>`;
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶æ‰§è¡Œåˆ†æ
        window.onload = function() {
            analyzeStorage();
            analyzeSyncQueue();
            testMatchLogic();
        };
    </script>
</body>
</html>