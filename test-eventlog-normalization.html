<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æµ‹è¯• EventLog æ ‡å‡†åŒ–åŠŸèƒ½</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 1200px;
      margin: 40px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .test-section {
      background: white;
      padding: 20px;
      margin: 20px 0;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      border-bottom: 3px solid #4CAF50;
      padding-bottom: 10px;
    }
    h2 {
      color: #555;
      margin-top: 0;
    }
    .test-case {
      margin: 15px 0;
      padding: 15px;
      background: #f9f9f9;
      border-left: 4px solid #2196F3;
      border-radius: 4px;
    }
    .test-case h3 {
      margin-top: 0;
      color: #2196F3;
    }
    .input {
      background: #fff3cd;
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
      border: 1px solid #ffc107;
    }
    .output {
      background: #d4edda;
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
      border: 1px solid #28a745;
    }
    .error {
      background: #f8d7da;
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
      border: 1px solid #dc3545;
      color: #721c24;
    }
    pre {
      background: #263238;
      color: #aed581;
      padding: 15px;
      border-radius: 4px;
      overflow-x: auto;
      font-size: 12px;
      line-height: 1.5;
    }
    button {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      margin: 5px;
    }
    button:hover {
      background: #45a049;
    }
    button:active {
      background: #3d8b40;
    }
    .status {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: bold;
      margin-left: 10px;
    }
    .status.pass {
      background: #d4edda;
      color: #155724;
    }
    .status.fail {
      background: #f8d7da;
      color: #721c24;
    }
  </style>
</head>
<body>
  <h1>ğŸ§ª EventLog æ ‡å‡†åŒ–åŠŸèƒ½æµ‹è¯•</h1>
  
  <div class="test-section">
    <h2>æµ‹è¯•è¯´æ˜</h2>
    <p>æœ¬æµ‹è¯•éªŒè¯ä»¥ä¸‹åŠŸèƒ½ï¼š</p>
    <ul>
      <li><strong>normalizeEventLog()</strong>: 5ç§è¾“å…¥æ ¼å¼çš„æ ‡å‡†åŒ–</li>
      <li><strong>htmlToSlateJsonWithRecognition()</strong>: HTMLåå‘è¯†åˆ«</li>
      <li><strong>recognizeTagNodeByPattern()</strong>: TagèŠ‚ç‚¹æ¨¡ç³ŠåŒ¹é…</li>
      <li><strong>recognizeDateMentionByPattern()</strong>: DateMentionèŠ‚ç‚¹æ¨¡ç³ŠåŒ¹é…</li>
    </ul>
  </div>

  <div class="test-section">
    <h2>æµ‹è¯•ç”¨ä¾‹</h2>
    <button onclick="runAllTests()">è¿è¡Œæ‰€æœ‰æµ‹è¯•</button>
    <button onclick="clearResults()">æ¸…ç©ºç»“æœ</button>
    
    <div id="test-results"></div>
  </div>

  <script type="module">
    // æ³¨æ„ï¼šç”±äºè¿™æ˜¯ä¸€ä¸ªæµ‹è¯•æ–‡ä»¶ï¼Œæˆ‘ä»¬éœ€è¦ç­‰å¾…åº”ç”¨åŠ è½½å®Œæˆ
    window.runAllTests = async function() {
      const resultsDiv = document.getElementById('test-results');
      resultsDiv.innerHTML = '<p>â³ åŠ è½½ä¸­...</p>';
      
      // ç­‰å¾… EventService åŠ è½½
      let retries = 0;
      while (!window.EventService && retries < 50) {
        await new Promise(resolve => setTimeout(resolve, 100));
        retries++;
      }
      
      if (!window.EventService) {
        resultsDiv.innerHTML = '<div class="error">âŒ EventService æœªåŠ è½½ï¼Œè¯·åœ¨åº”ç”¨è¿è¡Œæ—¶ä½¿ç”¨æ­¤æµ‹è¯•é¡µé¢</div>';
        return;
      }
      
      resultsDiv.innerHTML = '';
      
      // æµ‹è¯•ç”¨ä¾‹
      const tests = [
        {
          name: 'åœºæ™¯1: EventLogå¯¹è±¡è¾“å…¥ï¼ˆå·²æ ‡å‡†åŒ–ï¼‰',
          input: {
            slateJson: '[{"type":"paragraph","children":[{"text":"æµ‹è¯•å†…å®¹"}]}]',
            html: '<p>æµ‹è¯•å†…å®¹</p>',
            plainText: 'æµ‹è¯•å†…å®¹',
            attachments: [],
            versions: []
          },
          expectedType: 'EventLogå¯¹è±¡',
          validate: (result) => result && result.slateJson && result.html
        },
        {
          name: 'åœºæ™¯2: undefinedè¾“å…¥',
          input: undefined,
          expectedType: 'ç©ºEventLogå¯¹è±¡',
          validate: (result) => result && result.slateJson === '[]'
        },
        {
          name: 'åœºæ™¯3: Slate JSONå­—ç¬¦ä¸²è¾“å…¥',
          input: '[{"type":"paragraph","children":[{"text":"Slateå†…å®¹"}]}]',
          expectedType: 'EventLogå¯¹è±¡ï¼ˆä»JSONè½¬æ¢ï¼‰',
          validate: (result) => result && result.slateJson && result.html && result.plainText === 'Slateå†…å®¹'
        },
        {
          name: 'åœºæ™¯4: HTMLå­—ç¬¦ä¸²è¾“å…¥ï¼ˆæ— data-*å±æ€§ï¼‰',
          input: '<p>è¿™æ˜¯<strong>ç²—ä½“</strong>æ–‡æœ¬</p>',
          expectedType: 'EventLogå¯¹è±¡ï¼ˆHTMLåå‘è¯†åˆ«ï¼‰',
          validate: (result) => result && result.slateJson && result.html
        },
        {
          name: 'åœºæ™¯5: çº¯æ–‡æœ¬è¾“å…¥',
          input: 'çº¯æ–‡æœ¬å†…å®¹',
          expectedType: 'EventLogå¯¹è±¡ï¼ˆå•æ®µè½ï¼‰',
          validate: (result) => result && result.plainText === 'çº¯æ–‡æœ¬å†…å®¹'
        },
        {
          name: 'åœºæ™¯6: HTMLå«Tagï¼ˆdata-*å±æ€§ï¼‰',
          input: '<p>ä»»åŠ¡ <span data-tag-id="tag123" data-tag-name="å·¥ä½œ" data-tag-emoji="ğŸ’¼">@å·¥ä½œ</span> å®Œæˆ</p>',
          expectedType: 'EventLogå¯¹è±¡ï¼ˆTagèŠ‚ç‚¹è¯†åˆ«ï¼‰',
          validate: (result) => {
            if (!result || !result.slateJson) return false;
            try {
              const nodes = JSON.parse(result.slateJson);
              return JSON.stringify(nodes).includes('"type":"tag"');
            } catch {
              return false;
            }
          }
        },
        {
          name: 'åœºæ™¯7: HTMLå«DateMentionï¼ˆdata-*å±æ€§ï¼‰',
          input: '<p>ä¼šè®®æ—¶é—´ <span data-type="dateMention" data-start-date="2025-11-29T10:00:00">11/29 10:00</span></p>',
          expectedType: 'EventLogå¯¹è±¡ï¼ˆDateMentionèŠ‚ç‚¹è¯†åˆ«ï¼‰',
          validate: (result) => {
            if (!result || !result.slateJson) return false;
            try {
              const nodes = JSON.parse(result.slateJson);
              return JSON.stringify(nodes).includes('"type":"dateMention"');
            } catch {
              return false;
            }
          }
        },
        {
          name: 'åœºæ™¯8: æ–‡æœ¬å«Tagæ¨¡å¼ï¼ˆæ— å±æ€§ï¼Œæ¨¡ç³ŠåŒ¹é…ï¼‰',
          input: '<p>ä»»åŠ¡ @å·¥ä½œ å®Œæˆ</p>',
          expectedType: 'EventLogå¯¹è±¡ï¼ˆTagæ¨¡ç³Šè¯†åˆ«ï¼‰',
          validate: (result) => {
            if (!result || !result.slateJson) return false;
            try {
              const nodes = JSON.parse(result.slateJson);
              const jsonStr = JSON.stringify(nodes);
              return jsonStr.includes('"type":"tag"') || jsonStr.includes('@å·¥ä½œ');
            } catch {
              return false;
            }
          }
        },
        {
          name: 'åœºæ™¯9: æ–‡æœ¬å«DateMentionæ¨¡å¼ï¼ˆæ¨¡ç³ŠåŒ¹é…ï¼‰',
          input: '<p>ä¼šè®®å®‰æ’åœ¨ 11/29 10:00 å¼€å§‹</p>',
          expectedType: 'EventLogå¯¹è±¡ï¼ˆDateMentionæ¨¡ç³Šè¯†åˆ«ï¼‰',
          validate: (result) => {
            if (!result || !result.slateJson) return false;
            try {
              const nodes = JSON.parse(result.slateJson);
              const jsonStr = JSON.stringify(nodes);
              return jsonStr.includes('"type":"dateMention"') || jsonStr.includes('11/29 10:00');
            } catch {
              return false;
            }
          }
        }
      ];
      
      // è¿è¡Œæµ‹è¯•
      for (let i = 0; i < tests.length; i++) {
        const test = tests[i];
        const testDiv = document.createElement('div');
        testDiv.className = 'test-case';
        
        try {
          // è°ƒç”¨ normalizeEventLogï¼ˆé€šè¿‡åå°„è®¿é—®ç§æœ‰æ–¹æ³•ï¼‰
          // æ³¨æ„ï¼šè¿™æ˜¯æµ‹è¯•ä»£ç ï¼Œå®é™…åº”ç”¨ä¸­ä¸åº”è¯¥è®¿é—®ç§æœ‰æ–¹æ³•
          let result;
          
          // ä½¿ç”¨å…¬å¼€æ–¹æ³•æµ‹è¯•
          // æˆ‘ä»¬éœ€è¦æ¨¡æ‹Ÿä¸€ä¸ªäº‹ä»¶å¹¶è¯»å–
          const testEvent = {
            id: 'test-' + i,
            title: { simpleTitle: 'æµ‹è¯•äº‹ä»¶' },
            eventlog: test.input,
            createdAt: new Date().toISOString()
          };
          
          // ä¿å­˜åˆ° localStorage
          const events = JSON.parse(localStorage.getItem('remarkable-events') || '[]');
          events.push(testEvent);
          localStorage.setItem('remarkable-events', JSON.stringify(events));
          
          // è¯»å–äº‹ä»¶ï¼ˆä¼šè§¦å‘ normalizeEventLogï¼‰
          result = window.EventService.getEventById(testEvent.id);
          
          // æ¸…ç†æµ‹è¯•æ•°æ®
          const cleanedEvents = events.filter(e => e.id !== testEvent.id);
          localStorage.setItem('remarkable-events', JSON.stringify(cleanedEvents));
          
          const passed = result && result.eventlog && test.validate(result.eventlog);
          
          testDiv.innerHTML = `
            <h3>${test.name} <span class="status ${passed ? 'pass' : 'fail'}">${passed ? 'âœ“ PASS' : 'âœ— FAIL'}</span></h3>
            <div class="input">
              <strong>è¾“å…¥:</strong>
              <pre>${typeof test.input === 'string' ? test.input : JSON.stringify(test.input, null, 2)}</pre>
            </div>
            <div class="${passed ? 'output' : 'error'}">
              <strong>è¾“å‡º:</strong>
              <pre>${result ? JSON.stringify(result.eventlog, null, 2) : 'æ— ç»“æœ'}</pre>
            </div>
            <div>
              <strong>é¢„æœŸç±»å‹:</strong> ${test.expectedType}
            </div>
          `;
        } catch (error) {
          testDiv.innerHTML = `
            <h3>${test.name} <span class="status fail">âœ— ERROR</span></h3>
            <div class="input">
              <strong>è¾“å…¥:</strong>
              <pre>${typeof test.input === 'string' ? test.input : JSON.stringify(test.input, null, 2)}</pre>
            </div>
            <div class="error">
              <strong>é”™è¯¯:</strong>
              <pre>${error.message}\n${error.stack}</pre>
            </div>
          `;
        }
        
        resultsDiv.appendChild(testDiv);
      }
    };
    
    window.clearResults = function() {
      document.getElementById('test-results').innerHTML = '';
    };
  </script>

  <div class="test-section">
    <h2>ğŸ“‹ ä½¿ç”¨è¯´æ˜</h2>
    <ol>
      <li>åœ¨ä¸»åº”ç”¨è¿è¡Œçš„æƒ…å†µä¸‹æ‰“å¼€æ­¤æµ‹è¯•é¡µé¢</li>
      <li>ç‚¹å‡»"è¿è¡Œæ‰€æœ‰æµ‹è¯•"æŒ‰é’®</li>
      <li>æŸ¥çœ‹æ¯ä¸ªæµ‹è¯•ç”¨ä¾‹çš„ç»“æœ</li>
      <li>æ£€æŸ¥æ˜¯å¦æ‰€æœ‰æµ‹è¯•éƒ½é€šè¿‡ï¼ˆæ˜¾ç¤ºç»¿è‰²âœ“ PASSï¼‰</li>
    </ol>
    <p><strong>æ³¨æ„ï¼š</strong>æ­¤æµ‹è¯•éœ€è¦åœ¨åº”ç”¨è¿è¡Œæ—¶è¿›è¡Œï¼Œå› ä¸ºéœ€è¦è®¿é—® EventService å’Œç›¸å…³ä¾èµ–ã€‚</p>
  </div>
</body>
</html>
