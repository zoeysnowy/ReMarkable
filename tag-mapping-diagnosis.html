<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ ‡ç­¾æ˜ å°„è¯Šæ–­å·¥å…·</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .section {
            margin: 20px 0;
            padding: 15px;
            border-radius: 4px;
        }
        .info { background: #e3f2fd; border-left: 4px solid #2196f3; }
        .warning { background: #fff3e0; border-left: 4px solid #ff9800; }
        .error { background: #ffebee; border-left: 4px solid #f44336; }
        .success { background: #e8f5e8; border-left: 4px solid #4caf50; }
        .code {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            margin: 10px 0;
            white-space: pre-wrap;
        }
        button {
            background: #2196f3;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #1976d2;
        }
        #results {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” æ ‡ç­¾åˆ°æ—¥å†æ˜ å°„è¯Šæ–­å·¥å…·</h1>
        
        <div class="section info">
            <h2>é—®é¢˜æè¿°</h2>
            <p>TimeCalendaråˆ›å»ºäº‹ä»¶æ—¶å‡ºç°"Empty calendarId provided"é”™è¯¯ï¼Œéœ€è¦æ£€æŸ¥æ ‡ç­¾æ˜ å°„é…ç½®ã€‚</p>
        </div>

        <div class="section warning">
            <h2>è¯Šæ–­æ­¥éª¤</h2>
            <p>ç‚¹å‡»ä»¥ä¸‹æŒ‰é’®é€æ­¥æ£€æŸ¥ç³»ç»ŸçŠ¶æ€ï¼š</p>
            <button onclick="checkTagStorage()">1. æ£€æŸ¥æ ‡ç­¾å­˜å‚¨</button>
            <button onclick="checkPersonalTag()">2. æ£€æŸ¥"ä¸ªäºº"æ ‡ç­¾æ˜ å°„</button>
            <button onclick="checkAllMappings()">3. æ£€æŸ¥æ‰€æœ‰æ—¥å†æ˜ å°„</button>
            <button onclick="checkCalendarCache()">4. æ£€æŸ¥æ—¥å†ç¼“å­˜</button>
            <button onclick="runFullDiagnosis()">ğŸ”¬ å®Œæ•´è¯Šæ–­</button>
        </div>

        <div id="results">
            <!-- ç»“æœå°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
        </div>
    </div>

    <script>
        function log(message, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `section ${type}`;
            div.innerHTML = `<div class="code">${message}</div>`;
            results.appendChild(div);
            results.scrollTop = results.scrollHeight;
        }

        function checkTagStorage() {
            log('=== æ£€æŸ¥æ ‡ç­¾å­˜å‚¨ ===');
            
            try {
                const tagsKey = 'remarkable-hierarchical-tags';
                const tagsData = localStorage.getItem(tagsKey);
                
                if (!tagsData) {
                    log('âŒ æœªæ‰¾åˆ°æ ‡ç­¾æ•°æ®: ' + tagsKey, 'error');
                    return;
                }
                
                const tags = JSON.parse(tagsData);
                log(`âœ… æ‰¾åˆ°æ ‡ç­¾æ•°æ®ï¼Œå…± ${Array.isArray(tags) ? tags.length : 'N/A'} ä¸ªæ ¹æ ‡ç­¾`, 'success');
                
                // å±•å¹³æ ‡ç­¾
                function flattenTags(tags, result = [], level = 0) {
                    tags.forEach(tag => {
                        result.push({...tag, level});
                        if (tag.children) {
                            flattenTags(tag.children, result, level + 1);
                        }
                    });
                    return result;
                }
                
                const flatTags = flattenTags(tags);
                log(`ğŸ“‹ å±•å¹³åå…± ${flatTags.length} ä¸ªæ ‡ç­¾`, 'info');
                
                // æ˜¾ç¤ºå‰å‡ ä¸ªæ ‡ç­¾
                flatTags.slice(0, 5).forEach(tag => {
                    const indent = '  '.repeat(tag.level);
                    log(`${indent}- ${tag.name} (ID: ${tag.id})${tag.calendarMapping ? ' [æœ‰æ˜ å°„]' : ''}`, 'info');
                });
                
                if (flatTags.length > 5) {
                    log(`... è¿˜æœ‰ ${flatTags.length - 5} ä¸ªæ ‡ç­¾`, 'info');
                }
                
            } catch (error) {
                log('âŒ æ£€æŸ¥æ ‡ç­¾å­˜å‚¨å¤±è´¥: ' + error.message, 'error');
            }
        }

        function checkPersonalTag() {
            log('=== æ£€æŸ¥"ä¸ªäºº"æ ‡ç­¾æ˜ å°„ ===');
            
            try {
                const tagsData = JSON.parse(localStorage.getItem('remarkable-hierarchical-tags') || '[]');
                
                function findTagByName(tags, name) {
                    for (const tag of tags) {
                        if (tag.name === name) return tag;
                        if (tag.children) {
                            const found = findTagByName(tag.children, name);
                            if (found) return found;
                        }
                    }
                    return null;
                }
                
                const personalTag = findTagByName(tagsData, 'ä¸ªäºº');
                
                if (!personalTag) {
                    log('âŒ æœªæ‰¾åˆ°"ä¸ªäºº"æ ‡ç­¾', 'error');
                    return;
                }
                
                log(`âœ… æ‰¾åˆ°"ä¸ªäºº"æ ‡ç­¾: ID=${personalTag.id}`, 'success');
                
                if (personalTag.calendarMapping) {
                    log(`ğŸ“… æ—¥å†æ˜ å°„é…ç½®:
  - æ—¥å†ID: ${personalTag.calendarMapping.calendarId}
  - æ—¥å†åç§°: ${personalTag.calendarMapping.calendarName}`, 'success');
                } else {
                    log('âŒ "ä¸ªäºº"æ ‡ç­¾æ²¡æœ‰é…ç½®æ—¥å†æ˜ å°„', 'error');
                }
                
            } catch (error) {
                log('âŒ æ£€æŸ¥"ä¸ªäºº"æ ‡ç­¾å¤±è´¥: ' + error.message, 'error');
            }
        }

        function checkAllMappings() {
            log('=== æ£€æŸ¥æ‰€æœ‰æ—¥å†æ˜ å°„ ===');
            
            try {
                const tagsData = JSON.parse(localStorage.getItem('remarkable-hierarchical-tags') || '[]');
                
                function flattenTags(tags, result = []) {
                    tags.forEach(tag => {
                        result.push(tag);
                        if (tag.children) {
                            flattenTags(tag.children, result);
                        }
                    });
                    return result;
                }
                
                const allTags = flattenTags(tagsData);
                const mappedTags = allTags.filter(tag => tag.calendarMapping && tag.calendarMapping.calendarId);
                
                if (mappedTags.length === 0) {
                    log('âŒ æ²¡æœ‰æ‰¾åˆ°ä»»ä½•é…ç½®äº†æ—¥å†æ˜ å°„çš„æ ‡ç­¾', 'error');
                    return;
                }
                
                log(`âœ… æ‰¾åˆ° ${mappedTags.length} ä¸ªæœ‰æ—¥å†æ˜ å°„çš„æ ‡ç­¾:`, 'success');
                
                mappedTags.forEach(tag => {
                    log(`ğŸ“Œ ${tag.name} (${tag.id})
   â†’ ${tag.calendarMapping.calendarName} (${tag.calendarMapping.calendarId})`, 'info');
                });
                
            } catch (error) {
                log('âŒ æ£€æŸ¥æ‰€æœ‰æ˜ å°„å¤±è´¥: ' + error.message, 'error');
            }
        }

        function checkCalendarCache() {
            log('=== æ£€æŸ¥æ—¥å†ç¼“å­˜ ===');
            
            try {
                const calendarsKey = 'remarkable-calendars-cache';
                const calendarsData = localStorage.getItem(calendarsKey);
                
                if (!calendarsData) {
                    log('âŒ æœªæ‰¾åˆ°æ—¥å†ç¼“å­˜æ•°æ®', 'error');
                    return;
                }
                
                const calendars = JSON.parse(calendarsData);
                log(`âœ… æ‰¾åˆ° ${calendars.length} ä¸ªç¼“å­˜æ—¥å†:`, 'success');
                
                calendars.forEach(calendar => {
                    log(`ğŸ“… ${calendar.name} (${calendar.id})`, 'info');
                });
                
                // æ£€æŸ¥æ˜ å°„çš„æ—¥å†IDæ˜¯å¦å­˜åœ¨äºç¼“å­˜ä¸­
                const tagsData = JSON.parse(localStorage.getItem('remarkable-hierarchical-tags') || '[]');
                function flattenTags(tags, result = []) {
                    tags.forEach(tag => {
                        result.push(tag);
                        if (tag.children) flattenTags(tag.children, result);
                    });
                    return result;
                }
                
                const allTags = flattenTags(tagsData);
                const mappedTags = allTags.filter(tag => tag.calendarMapping?.calendarId);
                
                log('\\n=== æ˜ å°„éªŒè¯ ===', 'info');
                mappedTags.forEach(tag => {
                    const calendarId = tag.calendarMapping.calendarId;
                    const exists = calendars.some(cal => cal.id === calendarId);
                    const status = exists ? 'âœ…' : 'âŒ';
                    log(`${status} ${tag.name} â†’ ${calendarId} ${exists ? '(å­˜åœ¨)' : '(ä¸å­˜åœ¨)'}`, exists ? 'success' : 'error');
                });
                
            } catch (error) {
                log('âŒ æ£€æŸ¥æ—¥å†ç¼“å­˜å¤±è´¥: ' + error.message, 'error');
            }
        }

        function runFullDiagnosis() {
            document.getElementById('results').innerHTML = '';
            log('ğŸ”¬ å¼€å§‹å®Œæ•´è¯Šæ–­...', 'info');
            
            setTimeout(() => checkTagStorage(), 100);
            setTimeout(() => checkPersonalTag(), 500);
            setTimeout(() => checkAllMappings(), 900);
            setTimeout(() => checkCalendarCache(), 1300);
            
            setTimeout(() => {
                log('\\n=== è¯Šæ–­æ€»ç»“ ===', 'info');
                log('å¦‚æœå‘ç°é—®é¢˜ï¼Œå¯èƒ½çš„è§£å†³æ–¹æ¡ˆ:', 'warning');
                log('1. é‡æ–°é…ç½®æ ‡ç­¾çš„æ—¥å†æ˜ å°„', 'info');
                log('2. åˆ·æ–°æ—¥å†ç¼“å­˜', 'info');
                log('3. æ£€æŸ¥Microsoft Graph APIè®¤è¯çŠ¶æ€', 'info');
                log('4. éªŒè¯æ—¥å†IDæ ¼å¼æ˜¯å¦æ­£ç¡®', 'info');
            }, 1700);
        }

        // é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºè¯´æ˜
        window.onload = function() {
            log('ğŸ‘‹ æ¬¢è¿ä½¿ç”¨æ ‡ç­¾æ˜ å°„è¯Šæ–­å·¥å…·ï¼\\nç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹è¯Šæ–­ã€‚', 'info');
        };
    </script>
</body>
</html>