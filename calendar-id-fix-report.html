<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—¥å†IDé”™è¯¯ä¿®å¤éªŒè¯</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .problem {
            background: #fee;
            border-left: 4px solid #dc2626;
            padding: 15px;
            margin: 15px 0;
        }
        .solution {
            background: #efe;
            border-left: 4px solid #10b981;
            padding: 15px;
            margin: 15px 0;
        }
        .code {
            background: #f8f8f8;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            margin: 10px 0;
        }
        .log {
            background: #f0f9ff;
            border: 1px solid #e0f2fe;
            padding: 10px;
            border-radius: 4px;
            font-size: 12px;
            color: #666;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ æ—¥å†ID "Id is malformed" é”™è¯¯ä¿®å¤</h1>
        
        <div class="problem">
            <h2>âŒ é—®é¢˜æè¿°</h2>
            <ul>
                <li>TimeCalendaré¡µé¢åˆ›å»ºäº‹ä»¶æ—¶å‡ºç° <strong>"Id is malformed"</strong> é”™è¯¯</li>
                <li>é”™è¯¯åŸå› ï¼šä½¿ç”¨äº†æ— æ•ˆçš„æ—¥å†ID <code>'primary'</code></li>
                <li>Microsoft Graph API ä¸æ”¯æŒ <code>'primary'</code> è¿™ä¸ªç‰¹æ®Šå€¼</li>
            </ul>
            
            <h3>é”™è¯¯æ—¥å¿—:</h3>
            <div class="log">
logger.ts:53 [MSCalendar] âš ï¸ [validateCalendarExists] Empty calendarId provided
ActionBasedSyncManager.ts:2126 âš ï¸ [CALENDAR VALIDATION] Target calendar not found, falling back to default: 
  {invalidCalendarId: null, fallbackCalendarId: null, eventTitle: 'ğŸ·ï¸ä¸ªäºº', eventId: 'local-1763806255595'}
MicrosoftCalendarService.ts:2384 POST https://graph.microsoft.com/v1.0/me/calendars/primary/events 400 (Bad Request)
logger.ts:56 [MSCalendar] âŒ Graph API Error Response: 
  {"error":{"code":"ErrorInvalidIdMalformed","message":"Id is malformed."}}
            </div>
        </div>

        <div class="solution">
            <h2>âœ… ä¿®å¤æ–¹æ¡ˆ</h2>
            
            <h3>1. å¢å¼ºfallbacké€»è¾‘</h3>
            <p>å½“é€‰å®šçš„æ—¥å†IDä¸ºnullæˆ–æ— æ•ˆæ—¶ï¼Œè‡ªåŠ¨è·å–å®é™…çš„é»˜è®¤æ—¥å†ï¼š</p>
            <div class="code">
// ğŸ”§ å¦‚æœé€‰å®šæ—¥å†ä¹Ÿæ— æ•ˆæˆ–ä¸ºnullï¼Œè·å–å®é™…é»˜è®¤æ—¥å†
if (!fallbackCalendarId) {
  try {
    const defaultCalendar = await this.microsoftService.getDefaultCalendar();
    fallbackCalendarId = defaultCalendar.id;
    // ä¿å­˜ä¸ºé»˜è®¤é€‰æ‹©
    this.microsoftService.setSelectedCalendar(fallbackCalendarId);
  } catch (error) {
    throw new Error('æ— æ³•è·å–é»˜è®¤æ—¥å†ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–é‡æ–°ç™»å½•');
  }
}
            </div>

            <h3>2. ç§»é™¤'primary'å­—ç¬¦ä¸²</h3>
            <p>æ‰€æœ‰ä½¿ç”¨ <code>|| 'primary'</code> çš„åœ°æ–¹æ”¹ä¸ºä¸¥æ ¼æ£€æŸ¥ï¼š</p>
            <div class="code">
// âŒ ä¹‹å‰: ä½¿ç”¨æ— æ•ˆçš„'primary'
const newEventId = await this.microsoftService.syncEventToCalendar(eventData, syncTargetCalendarId || 'primary');

// âœ… ç°åœ¨: ç¡®ä¿æœ‰æœ‰æ•ˆçš„æ—¥å†ID
if (!syncTargetCalendarId) {
  throw new Error('æ— æ³•ç¡®å®šç›®æ ‡æ—¥å†IDï¼Œäº‹ä»¶åŒæ­¥å¤±è´¥');
}
const newEventId = await this.microsoftService.syncEventToCalendar(eventData, syncTargetCalendarId);
            </div>

            <h3>3. æ–°å¢ä¾¿æ·æ–¹æ³•</h3>
            <p>åœ¨ MicrosoftCalendarService ä¸­æ·»åŠ  <code>getValidCalendarId()</code> æ–¹æ³•ï¼š</p>
            <div class="code">
async getValidCalendarId(): Promise&lt;string&gt; {
  let calendarId = this.getSelectedCalendarId();
  
  if (!calendarId) {
    // è·å–é»˜è®¤æ—¥å†å¹¶ä¿å­˜
    const defaultCalendar = await this.getDefaultCalendar();
    calendarId = defaultCalendar.id;
    this.setSelectedCalendar(calendarId);
  }
  
  return calendarId;
}
            </div>
        </div>

        <div class="solution">
            <h2>ğŸ¯ ä¿®å¤æ•ˆæœ</h2>
            
            <h3>ä¿®æ”¹çš„æ–‡ä»¶ï¼š</h3>
            <ul>
                <li><code>ActionBasedSyncManager.ts</code> - å¢å¼ºæ—¥å†IDéªŒè¯å’Œfallbacké€»è¾‘</li>
                <li><code>MicrosoftCalendarService.ts</code> - æ·»åŠ ä¾¿æ·çš„è·å–æœ‰æ•ˆæ—¥å†IDæ–¹æ³•</li>
            </ul>

            <h3>é¢„æœŸç»“æœï¼š</h3>
            <ul>
                <li>âœ… åˆ›å»ºäº‹ä»¶æ—¶è‡ªåŠ¨è·å–æœ‰æ•ˆçš„æ—¥å†ID</li>
                <li>âœ… ä¸å†å‡ºç° "Id is malformed" é”™è¯¯</li>
                <li>âœ… è‡ªåŠ¨è®¾ç½®é»˜è®¤æ—¥å†ï¼Œé¿å…åç»­é—®é¢˜</li>
                <li>âœ… æä¾›æ¸…æ™°çš„é”™è¯¯æç¤ºï¼Œä¾¿äºç”¨æˆ·ç†è§£</li>
            </ul>
        </div>

        <div class="solution" style="background: #fff3cd; border-left-color: #f59e0b;">
            <h2>ğŸ” æµ‹è¯•æ­¥éª¤</h2>
            <ol>
                <li>é‡æ–°å¯åŠ¨åº”ç”¨ç¨‹åº</li>
                <li>åœ¨TimeCalendaré¡µé¢å°è¯•åˆ›å»ºæ–°äº‹ä»¶</li>
                <li>ç¡®è®¤äº‹ä»¶èƒ½å¤ŸæˆåŠŸåˆ›å»ºè€Œä¸å‡ºç°é”™è¯¯</li>
                <li>æ£€æŸ¥æ§åˆ¶å°æ—¥å¿—ï¼Œåº”è¯¥çœ‹åˆ°è‡ªåŠ¨è®¾ç½®é»˜è®¤æ—¥å†çš„æ¶ˆæ¯</li>
                <li>éªŒè¯äº‹ä»¶æ­£ç¡®åŒæ­¥åˆ° Outlook æ—¥å†</li>
            </ol>
        </div>

        <div class="problem" style="background: #f0f9ff; border-left-color: #3b82f6;">
            <h2>ğŸ“š æŠ€æœ¯è¦ç‚¹</h2>
            
            <h3>Microsoft Graph API æ—¥å†IDè§„èŒƒï¼š</h3>
            <ul>
                <li>å¿…é¡»ä½¿ç”¨å®é™…çš„æ—¥å†ID (å¦‚: <code>AQMkADVj...AAAA</code>)</li>
                <li>ä¸æ”¯æŒ <code>'primary'</code>ã€<code>'default'</code> ç­‰ç‰¹æ®Šå€¼</li>
                <li>å¯é€šè¿‡ <code>/me/calendar</code> è·å–é»˜è®¤æ—¥å†</li>
                <li>å¯é€šè¿‡ <code>/me/calendars</code> è·å–æ‰€æœ‰æ—¥å†</li>
            </ul>

            <h3>é”™è¯¯å¤„ç†æœ€ä½³å®è·µï¼š</h3>
            <ul>
                <li>æå‰éªŒè¯å¿…éœ€çš„å‚æ•°</li>
                <li>æä¾›æœ‰æ„ä¹‰çš„é”™è¯¯æ¶ˆæ¯</li>
                <li>è‡ªåŠ¨fallbackåˆ°å®‰å…¨çš„é»˜è®¤å€¼</li>
                <li>è®°å½•è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯</li>
            </ul>
        </div>
    </div>

    <script>
        console.log('âœ… æ—¥å†IDé”™è¯¯ä¿®å¤å·²å®Œæˆ');
        console.log('ğŸ“ ç°åœ¨å¯ä»¥æµ‹è¯•äº‹ä»¶åˆ›å»ºåŠŸèƒ½äº†');
    </script>
</body>
</html>