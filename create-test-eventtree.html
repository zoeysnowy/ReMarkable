<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>åˆ›å»ºæµ‹è¯• EventTree</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      padding: 20px;
      background: #f5f5f5;
      max-width: 800px;
      margin: 0 auto;
    }
    .container {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    button {
      padding: 12px 24px;
      margin: 8px;
      border: none;
      border-radius: 6px;
      background: #2196f3;
      color: white;
      font-size: 16px;
      cursor: pointer;
      font-weight: 600;
    }
    button:hover {
      background: #1976d2;
    }
    button.success {
      background: #4caf50;
    }
    button.danger {
      background: #f44336;
    }
    pre {
      background: #f8f8f8;
      padding: 12px;
      border-radius: 4px;
      overflow-x: auto;
      max-height: 400px;
    }
    .result {
      margin-top: 20px;
      padding: 16px;
      border-radius: 6px;
      border: 2px solid #e0e0e0;
    }
    .result.success {
      background: #e8f5e9;
      border-color: #4caf50;
    }
    .result.error {
      background: #ffebee;
      border-color: #f44336;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸŒ² åˆ›å»ºæµ‹è¯• EventTree</h1>
    <p>åœ¨æµè§ˆå™¨ Console ä¸­è¿è¡Œæ­¤è„šæœ¬ï¼Œåˆ›å»ºåŒ…å«çˆ¶å­å…³ç³»çš„æµ‹è¯•äº‹ä»¶æ ‘ã€‚</p>
    
    <button onclick="createTestTree()">åˆ›å»ºæµ‹è¯•æ ‘</button>
    <button onclick="checkExistingData()" class="success">æ£€æŸ¥ç°æœ‰æ•°æ®</button>
    <button onclick="clearTestData()" class="danger">æ¸…é™¤æµ‹è¯•æ•°æ®</button>
    
    <div id="result"></div>
  </div>

  <script>
    const resultDiv = document.getElementById('result');

    function showResult(message, type = 'success') {
      resultDiv.className = `result ${type}`;
      resultDiv.innerHTML = message;
    }

    async function createTestTree() {
      showResult('åˆ›å»ºä¸­...', '');
      
      try {
        // æ£€æŸ¥æ˜¯å¦åœ¨æ­£ç¡®çš„ç¯å¢ƒä¸­
        if (!window.EventService) {
          throw new Error('æœªæ‰¾åˆ° EventServiceï¼Œè¯·åœ¨ ReMarkable åº”ç”¨ä¸­æ‰“å¼€æ­¤é¡µé¢');
        }

        const EventService = window.EventService;
        
        // 1. åˆ›å»ºçˆ¶äº‹ä»¶
        console.log('ğŸ“ åˆ›å»ºçˆ¶äº‹ä»¶...');
        const parentResult = await EventService.createEvent({
          title: { simpleTitle: 'æµ‹è¯•çˆ¶äº‹ä»¶ - é¡¹ç›®è§„åˆ’' },
          isTask: false,
          tags: ['å·¥ä½œ'],
        });

        if (!parentResult.success) {
          throw new Error(`åˆ›å»ºçˆ¶äº‹ä»¶å¤±è´¥: ${parentResult.error}`);
        }

        const parentId = parentResult.event.id;
        console.log('âœ… çˆ¶äº‹ä»¶åˆ›å»ºæˆåŠŸ:', parentId);

        // 2. åˆ›å»ºå­äº‹ä»¶ 1
        console.log('ğŸ“ åˆ›å»ºå­äº‹ä»¶ 1...');
        const child1Result = await EventService.createEvent({
          title: { simpleTitle: 'æµ‹è¯•å­äº‹ä»¶ 1 - éœ€æ±‚åˆ†æ' },
          parentEventId: parentId,
          isTask: false,
          tags: ['å·¥ä½œ'],
        });

        if (!child1Result.success) {
          throw new Error(`åˆ›å»ºå­äº‹ä»¶ 1 å¤±è´¥: ${child1Result.error}`);
        }

        const child1Id = child1Result.event.id;
        console.log('âœ… å­äº‹ä»¶ 1 åˆ›å»ºæˆåŠŸ:', child1Id);

        // 3. åˆ›å»ºå­äº‹ä»¶ 2
        console.log('ğŸ“ åˆ›å»ºå­äº‹ä»¶ 2...');
        const child2Result = await EventService.createEvent({
          title: { simpleTitle: 'æµ‹è¯•å­äº‹ä»¶ 2 - æŠ€æœ¯æ–¹æ¡ˆ' },
          parentEventId: parentId,
          isTask: false,
          tags: ['å·¥ä½œ'],
        });

        if (!child2Result.success) {
          throw new Error(`åˆ›å»ºå­äº‹ä»¶ 2 å¤±è´¥: ${child2Result.error}`);
        }

        const child2Id = child2Result.event.id;
        console.log('âœ… å­äº‹ä»¶ 2 åˆ›å»ºæˆåŠŸ:', child2Id);

        // 4. åˆ›å»ºä¸‰çº§å­äº‹ä»¶ï¼ˆchild1 çš„å­äº‹ä»¶ï¼‰
        console.log('ğŸ“ åˆ›å»ºä¸‰çº§å­äº‹ä»¶...');
        const grandChildResult = await EventService.createEvent({
          title: { simpleTitle: 'æµ‹è¯•ä¸‰çº§äº‹ä»¶ - ç”¨æˆ·è°ƒç ”' },
          parentEventId: child1Id,
          isTask: false,
          tags: ['å·¥ä½œ'],
        });

        if (!grandChildResult.success) {
          throw new Error(`åˆ›å»ºä¸‰çº§å­äº‹ä»¶å¤±è´¥: ${grandChildResult.error}`);
        }

        const grandChildId = grandChildResult.event.id;
        console.log('âœ… ä¸‰çº§å­äº‹ä»¶åˆ›å»ºæˆåŠŸ:', grandChildId);

        // 5. æ›´æ–°çˆ¶äº‹ä»¶çš„ childEventIds
        console.log('ğŸ“ æ›´æ–°çˆ¶äº‹ä»¶çš„ childEventIds...');
        const updateParentResult = await EventService.updateEvent(parentId, {
          childEventIds: [child1Id, child2Id]
        });

        if (!updateParentResult.success) {
          throw new Error(`æ›´æ–°çˆ¶äº‹ä»¶å¤±è´¥: ${updateParentResult.error}`);
        }

        // 6. æ›´æ–° child1 çš„ childEventIds
        console.log('ğŸ“ æ›´æ–° child1 çš„ childEventIds...');
        const updateChild1Result = await EventService.updateEvent(child1Id, {
          childEventIds: [grandChildId]
        });

        if (!updateChild1Result.success) {
          throw new Error(`æ›´æ–° child1 å¤±è´¥: ${updateChild1Result.error}`);
        }

        // 7. éªŒè¯æ•°æ®
        const verifyParent = await EventService.getEventById(parentId);
        const verifyChild1 = await EventService.getEventById(child1Id);

        showResult(`
          <h3>âœ… æµ‹è¯•æ ‘åˆ›å»ºæˆåŠŸï¼</h3>
          <h4>æ ‘ç»“æ„:</h4>
          <pre>
ğŸ“ ${verifyParent.title.simpleTitle} (${parentId})
  â”œâ”€ ${verifyChild1.title.simpleTitle} (${child1Id})
  â”‚  â””â”€ æµ‹è¯•ä¸‰çº§äº‹ä»¶ - ç”¨æˆ·è°ƒç ” (${grandChildId})
  â””â”€ æµ‹è¯•å­äº‹ä»¶ 2 - æŠ€æœ¯æ–¹æ¡ˆ (${child2Id})
          </pre>
          <h4>æ•°æ®éªŒè¯:</h4>
          <pre>
çˆ¶äº‹ä»¶ childEventIds: ${JSON.stringify(verifyParent.childEventIds, null, 2)}
å­äº‹ä»¶ 1 childEventIds: ${JSON.stringify(verifyChild1.childEventIds, null, 2)}
ä¸‰çº§å­äº‹ä»¶ parentEventId: ${grandChildId}
          </pre>
          <p><strong>ç°åœ¨æ‰“å¼€ EventEditModal ç¼–è¾‘çˆ¶äº‹ä»¶ï¼Œç‚¹å‡»å…³è”æ‘˜è¦å³å¯çœ‹åˆ°å®Œæ•´æ ‘ç»“æ„ï¼</strong></p>
          <p>çˆ¶äº‹ä»¶ ID: <code>${parentId}</code></p>
        `, 'success');

        console.log('ğŸ‰ æµ‹è¯•æ ‘åˆ›å»ºå®Œæˆï¼');
        console.log('çˆ¶äº‹ä»¶ ID:', parentId);
        console.log('çˆ¶äº‹ä»¶ childEventIds:', verifyParent.childEventIds);

      } catch (error) {
        console.error('âŒ åˆ›å»ºæµ‹è¯•æ ‘å¤±è´¥:', error);
        showResult(`
          <h3>âŒ åˆ›å»ºå¤±è´¥</h3>
          <pre>${error.message}\n\n${error.stack}</pre>
        `, 'error');
      }
    }

    async function checkExistingData() {
      showResult('æ£€æŸ¥ä¸­...', '');
      
      try {
        if (!window.EventService) {
          throw new Error('æœªæ‰¾åˆ° EventService');
        }

        const EventService = window.EventService;
        const allEvents = await EventService.getAllEvents();
        
        // æŸ¥æ‰¾æœ‰å­äº‹ä»¶çš„äº‹ä»¶
        const withChildren = allEvents.filter(e => 
          e.childEventIds && e.childEventIds.length > 0
        );

        // æŸ¥æ‰¾æœ‰çˆ¶äº‹ä»¶çš„äº‹ä»¶
        const withParent = allEvents.filter(e => e.parentEventId);

        showResult(`
          <h3>ğŸ“Š æ•°æ®ç»Ÿè®¡</h3>
          <ul>
            <li>æ€»äº‹ä»¶æ•°: ${allEvents.length}</li>
            <li>æœ‰å­äº‹ä»¶çš„äº‹ä»¶: ${withChildren.length}</li>
            <li>æœ‰çˆ¶äº‹ä»¶çš„äº‹ä»¶: ${withParent.length}</li>
          </ul>

          ${withChildren.length > 0 ? `
            <h4>æœ‰å­äº‹ä»¶çš„äº‹ä»¶:</h4>
            <ul>
              ${withChildren.map(e => {
                const title = typeof e.title === 'string' 
                  ? e.title 
                  : (e.title?.simpleTitle || e.title?.colorTitle || 'æ— æ ‡é¢˜');
                return `<li>${title} (${e.id})<br>å­äº‹ä»¶: ${e.childEventIds.length} ä¸ª</li>`;
              }).join('')}
            </ul>
          ` : '<p>âš ï¸ æ²¡æœ‰æ‰¾åˆ°åŒ…å«å­äº‹ä»¶çš„äº‹ä»¶</p>'}

          ${withParent.length > 0 ? `
            <h4>æœ‰çˆ¶äº‹ä»¶çš„äº‹ä»¶:</h4>
            <ul>
              ${withParent.map(e => {
                const title = typeof e.title === 'string' 
                  ? e.title 
                  : (e.title?.simpleTitle || e.title?.colorTitle || 'æ— æ ‡é¢˜');
                return `<li>${title} (${e.id})<br>çˆ¶äº‹ä»¶: ${e.parentEventId}</li>`;
              }).join('')}
            </ul>
          ` : ''}
        `, 'success');

      } catch (error) {
        showResult(`
          <h3>âŒ æ£€æŸ¥å¤±è´¥</h3>
          <pre>${error.message}</pre>
        `, 'error');
      }
    }

    async function clearTestData() {
      if (!confirm('ç¡®å®šè¦åˆ é™¤æ‰€æœ‰æµ‹è¯•äº‹ä»¶å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
        return;
      }

      showResult('åˆ é™¤ä¸­...', '');
      
      try {
        if (!window.EventService) {
          throw new Error('æœªæ‰¾åˆ° EventService');
        }

        const EventService = window.EventService;
        const allEvents = await EventService.getAllEvents();
        
        // æŸ¥æ‰¾æµ‹è¯•äº‹ä»¶
        const testEvents = allEvents.filter(e => {
          const title = typeof e.title === 'string' 
            ? e.title 
            : (e.title?.simpleTitle || e.title?.colorTitle || '');
          return title.includes('æµ‹è¯•');
        });

        console.log(`æ‰¾åˆ° ${testEvents.length} ä¸ªæµ‹è¯•äº‹ä»¶`);

        // åˆ é™¤æµ‹è¯•äº‹ä»¶
        for (const event of testEvents) {
          await EventService.deleteEvent(event.id);
          console.log(`âœ… å·²åˆ é™¤: ${event.id}`);
        }

        showResult(`
          <h3>âœ… æ¸…é™¤å®Œæˆ</h3>
          <p>å·²åˆ é™¤ ${testEvents.length} ä¸ªæµ‹è¯•äº‹ä»¶</p>
        `, 'success');

      } catch (error) {
        showResult(`
          <h3>âŒ æ¸…é™¤å¤±è´¥</h3>
          <pre>${error.message}</pre>
        `, 'error');
      }
    }
  </script>
</body>
</html>
