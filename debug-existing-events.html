<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è°ƒè¯• getExistingEventsAtTime</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      max-width: 1200px;
      margin: 40px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      margin-bottom: 30px;
    }
    .controls {
      display: flex;
      gap: 15px;
      margin-bottom: 30px;
      align-items: center;
    }
    label {
      font-weight: 600;
      color: #555;
    }
    input[type="datetime-local"] {
      padding: 8px 12px;
      border: 2px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
    }
    button {
      padding: 10px 20px;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
    }
    button:hover {
      background: #45a049;
    }
    .stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
      margin-bottom: 30px;
    }
    .stat-card {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      border-left: 4px solid #4CAF50;
    }
    .stat-label {
      font-size: 12px;
      color: #666;
      text-transform: uppercase;
      margin-bottom: 5px;
    }
    .stat-value {
      font-size: 32px;
      font-weight: 700;
      color: #333;
    }
    .results {
      margin-top: 30px;
    }
    .event-list {
      max-height: 500px;
      overflow-y: auto;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
    }
    .event-item {
      padding: 12px 16px;
      border-bottom: 1px solid #f0f0f0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .event-item:hover {
      background: #f8f9fa;
    }
    .event-title {
      font-weight: 500;
      color: #333;
      flex: 1;
    }
    .event-id {
      font-size: 12px;
      color: #999;
      font-family: monospace;
    }
    .event-created {
      font-size: 12px;
      color: #666;
      margin-left: 15px;
    }
    .debug-info {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      margin-top: 20px;
      font-family: monospace;
      font-size: 12px;
      white-space: pre-wrap;
      max-height: 300px;
      overflow-y: auto;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ” è°ƒè¯• getExistingEventsAtTime</h1>
    
    <div class="controls">
      <label for="timestamp">é€‰æ‹©æ—¶é—´ç‚¹:</label>
      <input type="datetime-local" id="timestamp" />
      <button onclick="queryEvents()">æŸ¥è¯¢</button>
      <button onclick="queryNow()">å½“å‰æ—¶é—´</button>
    </div>

    <div class="stats">
      <div class="stat-card">
        <div class="stat-label">æŸ¥è¯¢åˆ°çš„äº‹ä»¶æ•°</div>
        <div class="stat-value" id="existingCount">-</div>
      </div>
      <div class="stat-card" style="border-left-color: #2196F3;">
        <div class="stat-label">å½“å‰æ€»äº‹ä»¶æ•°</div>
        <div class="stat-value" id="currentCount">-</div>
      </div>
      <div class="stat-card" style="border-left-color: #FF9800;">
        <div class="stat-label">å†å²è®°å½•æ€»æ•°</div>
        <div class="stat-value" id="historyCount">-</div>
      </div>
    </div>

    <div class="results">
      <h3>äº‹ä»¶åˆ—è¡¨</h3>
      <div class="event-list" id="eventList"></div>
    </div>

    <div class="debug-info" id="debugInfo"></div>
  </div>

  <script>
    // è®¾ç½®é»˜è®¤æ—¶é—´ä¸ºå½“å‰æ—¶é—´
    const now = new Date();
    const localDateTime = new Date(now.getTime() - now.getTimezoneOffset() * 60000)
      .toISOString()
      .slice(0, 16);
    document.getElementById('timestamp').value = localDateTime;

    // ä» localStorage åŠ è½½æœåŠ¡
    function loadServices() {
      // åŠ è½½ EventService
      const EventService = {
        getAllEvents() {
          const eventsJson = localStorage.getItem('events');
          return eventsJson ? JSON.parse(eventsJson) : [];
        }
      };

      // åŠ è½½ EventHistoryService
      const EventHistoryService = {
        getAllLogs() {
          const logsJson = localStorage.getItem('event-history-logs');
          return logsJson ? JSON.parse(logsJson) : [];
        },
        
        getExistingEventsAtTime(timestamp) {
          const targetTime = new Date(timestamp);
          const allLogs = this.getAllLogs();
          const allCurrentEvents = EventService.getAllEvents();
          
          // å…ˆè·å–æ‰€æœ‰å½“å‰å­˜åœ¨çš„äº‹ä»¶
          const existingEvents = new Set(allCurrentEvents.map(e => e.id));
          
          const debugInfo = {
            timestamp,
            targetTime: targetTime.toISOString(),
            å½“å‰äº‹ä»¶æ€»æ•°: existingEvents.size,
            å†å²è®°å½•æ€»æ•°: allLogs.length,
            å¤„ç†è¿‡ç¨‹: []
          };
          
          // éå†æ‰€æœ‰å†å²è®°å½•
          allLogs.forEach(log => {
            const logTime = new Date(log.timestamp);
            
            if (logTime <= targetTime) {
              // æ—¶é—´ç‚¹ä¹‹å‰çš„æ“ä½œ
              if (log.operation === 'create') {
                existingEvents.add(log.eventId);
                debugInfo.å¤„ç†è¿‡ç¨‹.push(`âœ… [${log.timestamp}] CREATE ${log.eventId.slice(-8)}`);
              } else if (log.operation === 'delete') {
                existingEvents.delete(log.eventId);
                debugInfo.å¤„ç†è¿‡ç¨‹.push(`âŒ [${log.timestamp}] DELETE ${log.eventId.slice(-8)}`);
              }
            } else {
              // æ—¶é—´ç‚¹ä¹‹åçš„æ“ä½œï¼šåå‘åº”ç”¨
              if (log.operation === 'create') {
                existingEvents.delete(log.eventId);
                debugInfo.å¤„ç†è¿‡ç¨‹.push(`âª [${log.timestamp}] æ’¤é”€CREATE ${log.eventId.slice(-8)}`);
              } else if (log.operation === 'delete') {
                existingEvents.add(log.eventId);
                debugInfo.å¤„ç†è¿‡ç¨‹.push(`âª [${log.timestamp}] æ’¤é”€DELETE ${log.eventId.slice(-8)}`);
              }
            }
          });
          
          debugInfo.æœ€ç»ˆç»“æœ = existingEvents.size;
          
          return { existingEvents, debugInfo, allEvents: allCurrentEvents };
        }
      };

      return { EventService, EventHistoryService };
    }

    function formatTime(timestamp) {
      if (!timestamp) return '-';
      const date = new Date(timestamp);
      return date.toLocaleString('zh-CN');
    }

    function queryEvents() {
      const timestamp = document.getElementById('timestamp').value;
      if (!timestamp) {
        alert('è¯·é€‰æ‹©æ—¶é—´ç‚¹');
        return;
      }

      const { EventService, EventHistoryService } = loadServices();
      const result = EventHistoryService.getExistingEventsAtTime(timestamp);
      
      // æ›´æ–°ç»Ÿè®¡å¡ç‰‡
      document.getElementById('existingCount').textContent = result.existingEvents.size;
      document.getElementById('currentCount').textContent = result.allEvents.length;
      document.getElementById('historyCount').textContent = result.debugInfo.å†å²è®°å½•æ€»æ•°;

      // æ›´æ–°äº‹ä»¶åˆ—è¡¨
      const eventList = document.getElementById('eventList');
      const existingIds = result.existingEvents;
      
      const eventsToShow = result.allEvents.filter(e => existingIds.has(e.id));
      
      if (eventsToShow.length === 0) {
        eventList.innerHTML = '<div style="padding: 20px; text-align: center; color: #999;">æ— äº‹ä»¶</div>';
      } else {
        eventList.innerHTML = eventsToShow.map(event => `
          <div class="event-item">
            <span class="event-title">${event.title || '(æ— æ ‡é¢˜)'}</span>
            <span class="event-created">${formatTime(event.createdAt)}</span>
            <span class="event-id">${event.id.slice(-10)}</span>
          </div>
        `).join('');
      }

      // æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯
      const debugInfo = document.getElementById('debugInfo');
      debugInfo.textContent = JSON.stringify(result.debugInfo, null, 2);
    }

    function queryNow() {
      const now = new Date();
      const localDateTime = new Date(now.getTime() - now.getTimezoneOffset() * 60000)
        .toISOString()
        .slice(0, 16);
      document.getElementById('timestamp').value = localDateTime;
      queryEvents();
    }

    // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æŸ¥è¯¢
    window.addEventListener('load', () => {
      queryNow();
    });
  </script>
</body>
</html>
