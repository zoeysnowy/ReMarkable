# 假日数据自动更新方案总结

> **问题**: 中国每年的国定假日安排会变化，如何让用户及时获取最新数据？  
> **解决方案**: GitHub Actions + 本地存储 + 后台检查更新

---

## 🎯 核心问题

用户关心的问题：
1. **如何知道有新的假日安排？** → 自动通知
2. **需要重新下载应用吗？** → 不需要，只下载数据（5KB）
3. **必须联网吗？** → 不必须，离线可用旧数据
4. **数据从哪来？** → 开发者根据国务院通知更新
5. **会不会很麻烦？** → 一键更新，无需重启

---

## ✅ 解决方案

### 方案架构

```
国务院发布假日安排
      │
      ▼
开发者更新 + 推送 tag (15分钟)
      │
      ▼
GitHub Actions 自动发布 (自动)
      │
      ▼
用户应用检查更新 (后台)
      │
      ▼
显示通知 + 一键下载 (用户点击)
      │
      ▼
立即生效（无需重启）
```

### 关键特性

| 特性 | 实现方式 | 用户体验 |
|------|---------|---------|
| **自动检查** | 每周后台检查一次 | 无感知 |
| **通知提醒** | 发现新版本弹出横幅 | 及时了解 |
| **可选更新** | 用户决定是否下载 | 自主控制 |
| **离线可用** | 无更新也能使用 | 不受网络影响 |
| **小文件** | JSON 仅 5KB | 秒级下载 |
| **无需重启** | 合并到 localStorage | 立即生效 |

---

## 📋 涉及文件

### 核心代码（需实现）

```
src/
├── utils/holidays/
│   ├── updateManager.ts          # 更新管理器（核心逻辑）
│   └── README.md                  # 技术文档
├── services/
│   └── HolidayUpdateService.ts   # 后台检查服务
└── components/
    └── HolidayUpdateBanner.tsx   # 通知 UI 组件

scripts/
└── buildHolidayData.js           # 构建脚本

.github/workflows/
└── publish-holidays.yml          # 自动发布流程

docs/
└── HOLIDAY_UPDATE_GUIDE.md       # 维护指南
```

### 数据文件（每年添加）

```
public/holidays/
├── holidays-2025.json  # 内置
├── holidays-2026.json  # 发布到 GitHub Release
├── holidays-2027.json  # 未来年份
└── ...
```

---

## 🔄 完整流程

### 开发者侧（每年12月，约15分钟）

#### Step 1: 获取官方数据（5分钟）
访问 http://www.gov.cn/zhengce/  
查找"国务院办公厅关于2026年部分节假日安排的通知"

#### Step 2: 更新代码（5分钟）

```typescript
// src/utils/holidays/adjustedWorkdays.ts

export const ADJUSTED_WORKDAYS_2026 = {
  workdays: [
    "2026-02-04",  // 春节调班
    "2026-02-15",
    "2026-04-26",  // 五一调班
    "2026-10-10",  // 国庆调班
  ],
  holidays: [
    { start: "2026-01-01", end: "2026-01-03", name: "元旦假期", days: 3 },
    { start: "2026-02-07", end: "2026-02-13", name: "春节假期", days: 7 },
    // ... 其他假期
  ]
};
```

#### Step 3: 测试验证（3分钟）

```bash
node scripts/testHolidayData.js
# 输出: ✅ 所有测试通过！
```

#### Step 4: 发布（2分钟）

```bash
git add src/utils/holidays/adjustedWorkdays.ts
git commit -m "feat: 添加2026年假日安排"
git push origin master

# 创建标签触发自动发布
git tag holidays-2026
git push origin holidays-2026
```

#### Step 5: GitHub Actions 自动运行

- ✅ 构建 `holidays-2026.json`
- ✅ 创建 GitHub Release
- ✅ 上传 JSON 文件
- ✅ 生成发布说明

**无需手动操作！**

---

### 用户侧（自动，无感知）

#### Day 1-7: 应用后台检查

```typescript
// 应用启动时
HolidayUpdateService.start();
  └─ 检查上次检查时间
      └─ 超过7天 → 后台检查更新
          └─ 发现新版本 → 显示通知
```

#### 用户看到通知

```
┌────────────────────────────────────────┐
│ 🎉  2026年假日安排                      │
│     已发布，点击更新                     │
│                                        │
│  [立即更新]  [稍后提醒]                  │
└────────────────────────────────────────┘
```

#### 用户点击"立即更新"

1. 下载 `holidays-2026.json` (约 5KB)
2. 合并到 `localStorage['holidayUpdates']`
3. 显示提示：**"✅ 2026年假日数据已更新"**
4. 日历立即显示新假期（无需重启）

---

## 💡 技术亮点

### 1️⃣ 渐进式更新

```typescript
// 数据优先级
function getHolidayData(year: number) {
  // 1. 优先从 localStorage 获取（用户已更新）
  if (localStorage['holidayUpdates'][year]) {
    return localStorage['holidayUpdates'][year];
  }
  
  // 2. 回退到内置数据（应用内置的2025年）
  if (year === 2025) return ADJUSTED_WORKDAYS_2025;
  
  // 3. 都没有 → 返回 null（功能降级）
  return null;
}
```

### 2️⃣ 离线优先

- ✅ 应用内置 2025 年数据（初始版本）
- ✅ 即使不联网也能正常使用
- ✅ 联网后才检查更新
- ✅ 更新失败不影响使用

### 3️⃣ 安全性

- ✅ 只下载 JSON 数据文件
- ✅ 不执行任何远程代码
- ✅ 使用 HTTPS 下载
- ✅ 从 GitHub Release 下载（可信源）

### 4️⃣ 性能优化

- ✅ 后台检查（不阻塞 UI）
- ✅ 每周检查一次（不频繁）
- ✅ 小文件下载（5KB）
- ✅ 增量更新（只下载新年份）

---

## 📊 方案对比

### 与其他方案的对比

| 方案 | 优点 | 缺点 | 适用场景 |
|------|------|------|---------|
| **外部 API** | 开发简单 | 需联网、有成本、不稳定 | 数据频繁变化 |
| **应用更新** | 简单直接 | 用户需重新下载、更新慢 | 固定数据 |
| **我们的方案** | 离线可用、自动更新、零成本 | 每年需维护15分钟 | 年度数据更新 ✅ |

### 成本对比

| 方案 | 服务器成本 | 带宽成本 | 维护成本 | 用户体验 |
|------|-----------|---------|---------|---------|
| **外部 API** | ¥500/年 | ¥200/年 | 0 | ⭐⭐⭐ |
| **应用更新** | ¥0 | ¥0 | 1小时/次 | ⭐⭐ |
| **我们的方案** | ¥0 | ¥0（GitHub免费） | 15分钟/年 | ⭐⭐⭐⭐⭐ |

---

## 🎉 总结

### 优势

✅ **用户体验极佳**
- 自动通知
- 一键更新
- 无需重启
- 离线可用

✅ **开发成本极低**
- 每年仅 15 分钟
- GitHub Actions 自动化
- 无需额外服务器

✅ **维护成本极低**
- 无需购买 API
- 无需管理服务器
- 数据由开发者控制

✅ **技术实现优雅**
- 渐进式更新
- 离线优先
- 安全可靠

### 适用性

- ✅ **完美适用**于每年固定更新的数据（如假日安排）
- ✅ **完美适用**于 Electron 应用（本地存储）
- ✅ **完美适用**于开源项目（GitHub Actions 免费）

### 未来扩展

- [ ] 支持多国假日切换
- [ ] 支持自定义节日数据
- [ ] 支持历史年份查询
- [ ] 支持假期提醒功能

---

**最后更新**: 2025-11-11  
**方案版本**: v2.2  
**状态**: ✅ 设计完成，待实现
