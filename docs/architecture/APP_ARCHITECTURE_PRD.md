# App ç»„ä»¶æ¶æ„æ–‡æ¡£ (PRD)

**ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2025-11-10  
**æ–‡æ¡£ç±»å‹**: æ¶æ„è®¾è®¡æ–‡æ¡£ï¼ˆé€†å‘å·¥ç¨‹ï¼‰

---

## æ–‡æ¡£æ¦‚è¿°

æœ¬æ–‡æ¡£é€šè¿‡é€†å‘å·¥ç¨‹åˆ†æ `src/App.tsx` ç»„ä»¶ï¼Œè®°å½•å…¶æ¶æ„è®¾è®¡ã€çŠ¶æ€ç®¡ç†ã€æ¸²æŸ“æœºåˆ¶ã€æ€§èƒ½ä¼˜åŒ–ç­–ç•¥åŠå·²çŸ¥é—®é¢˜ã€‚

---

## 1. ç»„ä»¶èŒè´£

### 1.1 æ ¸å¿ƒèŒè´£

`App.tsx` æ˜¯ ReMarkable åº”ç”¨çš„**æ ¹ç»„ä»¶**ï¼Œè´Ÿè´£ï¼š

1. **è·¯ç”±ç®¡ç†**: ç®¡ç†é¡µé¢åˆ‡æ¢ï¼ˆhome, calendar, plan, tag, settingsï¼‰
2. **å…¨å±€çŠ¶æ€ç®¡ç†**: ç»´æŠ¤è·¨ç»„ä»¶å…±äº«çš„çŠ¶æ€
3. **æœåŠ¡åˆå§‹åŒ–**: åˆå§‹åŒ– TagService, EventService, MicrosoftCalendarService, SyncManager
4. **å¸ƒå±€æ¸²æŸ“**: æä¾›ç»Ÿä¸€çš„åº”ç”¨å¸ƒå±€å’Œå¯¼èˆª
5. **å…¨å±€äº‹ä»¶åè°ƒ**: å¤„ç†è·¨ç»„ä»¶çš„äº‹ä»¶é€šä¿¡
6. **Timer çˆ¶å­äº‹ä»¶ç®¡ç†**: è‡ªåŠ¨æ£€æµ‹ç‹¬ç«‹ Timer äºŒæ¬¡è®¡æ—¶ï¼Œå‡çº§ä¸ºçˆ¶å­ç»“æ„

### 1.2 å­ç»„ä»¶æ¸²æŸ“

æ ¹æ® `currentPage` æ¸²æŸ“ä¸åŒçš„é¡µé¢ç»„ä»¶ï¼š
- **home**: `TimerCard` + `DailyStatsCard`
- **calendar**: `TimeCalendar`
- **plan**: `PlanManager`
- **tag**: `TagManager` (FigmaTagManager)
- **settings**: `SettingsModal`

---

## 2. çŠ¶æ€ç®¡ç†

### 2.1 State å®Œæ•´æ¸…å•ï¼ˆå…±18ä¸ªï¼‰

#### 2.1.1 è®¡æ—¶å™¨ç›¸å…³ï¼ˆ1ä¸ªï¼‰

| State | ç±»å‹ | ç”¨é€” | è§¦å‘æ¸²æŸ“åœºæ™¯ |
|-------|------|------|------------|
| `globalTimer` | `GlobalTimer \| null` | å…¨å±€è®¡æ—¶å™¨å¯¹è±¡ | å¼€å§‹/æš‚åœ/æ¢å¤/åœæ­¢ |

**æ¸²æŸ“é¢‘ç‡**: ç”¨æˆ·äº¤äº’æ—¶è§¦å‘ï¼ˆå¼€å§‹/åœæ­¢è®¡æ—¶å™¨ï¼‰

**ğŸ¯ v1.7.1 ä¼˜åŒ–**: ç§»é™¤æ—§è®¡æ—¶å™¨ç³»ç»Ÿï¼ˆ6ä¸ªçŠ¶æ€ï¼‰å’Œæ­»ä»£ç ï¼ŒTimerCard è‡ªè¡Œç®¡ç†æ—¶é—´æ˜¾ç¤ºæ›´æ–°

#### 2.1.2 åŒæ­¥ç›¸å…³ï¼ˆ3ä¸ªï¼‰

| State | ç±»å‹ | ç”¨é€” | è§¦å‘æ¸²æŸ“åœºæ™¯ |
|-------|------|------|------------|
| `lastSyncTime` | `Date \| null` | æœ€ååŒæ­¥æ—¶é—´ | åŒæ­¥å®Œæˆåæ›´æ–° |
| `syncManager` | `ActionBasedSyncManager \| null` | åŒæ­¥ç®¡ç†å™¨å®ä¾‹ | åˆå§‹åŒ–æ—¶ï¼ˆä»…ä¸€æ¬¡ï¼‰ |
| `lastAuthState` | `boolean` | è®¤è¯çŠ¶æ€ | ç™»å½•/ç™»å‡º |

**æ¸²æŸ“é¢‘ç‡**: ä½é¢‘ï¼ˆåˆå§‹åŒ–ã€åŒæ­¥å®Œæˆã€è®¤è¯å˜åŒ–æ—¶ï¼‰

#### 2.1.3 äº‹ä»¶ç¼–è¾‘ç›¸å…³ï¼ˆ6ä¸ªï¼‰

| State | ç±»å‹ | ç”¨é€” | è§¦å‘æ¸²æŸ“åœºæ™¯ |
|-------|------|------|------------|
| `editingEventId` | `string` | ç¼–è¾‘ä¸­çš„äº‹ä»¶ID | æ‰“å¼€ç¼–è¾‘æ¡† |
| `editingEventTitle` | `string` | ç¼–è¾‘ä¸­çš„æ ‡é¢˜ | ç”¨æˆ·è¾“å…¥ |
| `editingEventDescription` | `string` | ç¼–è¾‘ä¸­çš„æè¿° | ç”¨æˆ·è¾“å…¥ |
| `editingEventTagId` | `string` | ç¼–è¾‘ä¸­çš„æ ‡ç­¾ID | é€‰æ‹©æ ‡ç­¾ |
| `availableTagsForEdit` | `FlatTag[]` | å¯ç”¨æ ‡ç­¾åˆ—è¡¨ | TagService æ›´æ–° |
| `showEventEditModal` | `boolean` | æ˜¯å¦æ˜¾ç¤ºç¼–è¾‘æ¡† | æ‰“å¼€/å…³é—­ |

**æ¸²æŸ“é¢‘ç‡**: ä¸­é¢‘ï¼ˆç”¨æˆ·ç¼–è¾‘äº‹ä»¶æ—¶ï¼‰

#### 2.1.4 æ ‡ç­¾å’Œäº‹ä»¶æ•°æ®ï¼ˆ2ä¸ªï¼‰ âš ï¸ æ€§èƒ½å…³é”®

| State | ç±»å‹ | ç”¨é€” | è§¦å‘æ¸²æŸ“åœºæ™¯ | æ€§èƒ½å½±å“ |
|-------|------|------|------------|----------|
| ~~`appTags`~~ | ~~`any[]`~~ | ~~æ ‡ç­¾æ•°æ®~~ | **å·²ç§»é™¤** | **é«˜** - å·²ä¼˜åŒ–ä¸º `tagsVersion` |
| `tagsVersion` | `number` | æ ‡ç­¾ç‰ˆæœ¬å· | TagService æ›´æ–° | **ä½** - ç‰ˆæœ¬å·å˜åŒ–æ—¶ |
| `allEvents` | `Event[]` | æ‰€æœ‰äº‹ä»¶æ•°æ® | äº‹ä»¶å¢åˆ æ”¹ | **é«˜** - æ¯æ¬¡äº‹ä»¶å˜åŒ–éƒ½è§¦å‘ |

**æ€§èƒ½ä¼˜åŒ–è®°å½•**:
- âœ… **v1.7.0 ä¼˜åŒ–**: ç§»é™¤ `appTags` stateï¼Œæ”¹ç”¨ `tagsVersion` è§¦å‘æ›´æ–°
**æ€§èƒ½ä¼˜åŒ–è®°å½•**:
- âœ… **v1.7.0**: ç§»é™¤ `appTags` stateï¼Œæ”¹ç”¨ `tagsVersion` è§¦å‘æ›´æ–°
- âœ… **v1.7.1**: ç§»é™¤æ—§è®¡æ—¶å™¨ç³»ç»Ÿå’Œæ­»ä»£ç 
- âš ï¸ **å¾…ä¼˜åŒ–**: `allEvents` ä¸»è¦ç”¨äºé¦–é¡µç»Ÿè®¡ï¼Œä½†ä¼šå¯¼è‡´å…¨å±€é‡æ¸²æŸ“

#### 2.1.5 è®¾ç½®å’ŒUIï¼ˆ2ä¸ªï¼‰

| State | ç±»å‹ | ç”¨é€” | è§¦å‘æ¸²æŸ“åœºæ™¯ |
|-------|------|------|------------|
| `appSettings` | `AppSettings` | åº”ç”¨è®¾ç½® | ç”¨æˆ·ä¿®æ”¹è®¾ç½® |
| `clickTrackerEnabled` | `boolean` | è°ƒè¯•å·¥å…·å¼€å…³ | å¼€å‘è°ƒè¯• |

**æ¸²æŸ“é¢‘ç‡**: ä½é¢‘ï¼ˆç”¨æˆ·ä¿®æ”¹è®¾ç½®ã€å¼€å‘è°ƒè¯•æ—¶ï¼‰

---

### 2.2 Computed Values (useMemo)

#### 2.2.1 hierarchicalTags

```typescript
const hierarchicalTags = useMemo(() => {
  return TagService.getTags();
}, [tagsVersion]);
```

**ä¾èµ–**: `tagsVersion`  
**æ›´æ–°æ—¶æœº**: TagService.updateTags() è¢«è°ƒç”¨æ—¶  
**æ€§èƒ½ä¼˜åŒ–**: 
- âœ… TagService.getTags() è¿”å›ç¨³å®šå¼•ç”¨ï¼ˆç›´æ¥è¿”å› `this.tags`ï¼‰
- âœ… ä½¿ç”¨ç‰ˆæœ¬å·æœºåˆ¶é¿å…ä¸å¿…è¦çš„é‡æ–°è®¡ç®—

#### 2.2.2 availableCalendars

```typescript
const availableCalendars = useMemo(() => {
  return getAvailableCalendarsForSettings();
}, []);
```

**ä¾èµ–**: æ— ï¼ˆç©ºä¾èµ–æ•°ç»„ï¼‰  
**æ›´æ–°æ—¶æœº**: ç»„ä»¶æŒ‚è½½æ—¶è®¡ç®—ä¸€æ¬¡  
**æ€§èƒ½ä¼˜åŒ–**: âœ… ç¼“å­˜æ—¥å†åˆ—è¡¨ï¼Œé¿å…æ¯æ¬¡æ¸²æŸ“åˆ›å»ºæ–°æ•°ç»„

---

## 3. æ¸²æŸ“æœºåˆ¶

### 3.1 æ¸²æŸ“è§¦å‘æ¡ä»¶

App ç»„ä»¶ä¼šåœ¨ä»¥ä¸‹æƒ…å†µé‡æ–°æ¸²æŸ“ï¼š

#### 3.1.1 é«˜é¢‘è§¦å‘ï¼ˆå¯èƒ½å¯¼è‡´æ€§èƒ½é—®é¢˜ï¼‰

1. **äº‹ä»¶æ•°æ®å˜åŒ–** - `allEvents` æ›´æ–°
   - è§¦å‘åœºæ™¯: 
     - PlanManager åˆ›å»º/æ›´æ–°/åˆ é™¤äº‹ä»¶
     - localStorage å˜åŒ–ï¼ˆè·¨æ ‡ç­¾é¡µï¼‰
   - å½±å“: è§¦å‘ App é‡æ¸²æŸ“ï¼Œä½†ä¸»è¦ç”¨äºé¦–é¡µç»Ÿè®¡
   - âš ï¸ å¾…ä¼˜åŒ–: TimeCalendar åˆ é™¤äº‹ä»¶æ—¶ï¼Œä¼šè§¦å‘ä¸å¿…è¦çš„ App é‡æ¸²æŸ“

#### 3.1.2 ä¸­é¢‘è§¦å‘

1. **ç”¨æˆ·äº¤äº’** - ç¼–è¾‘äº‹ä»¶ã€é€‰æ‹©æ ‡ç­¾ç­‰
   - `editingEventTitle`, `editingEventDescription`, `editingEventTagId` ç­‰
   - å½±å“èŒƒå›´: ç¼–è¾‘ç›¸å…³ç»„ä»¶

2. **æ ‡ç­¾æ•°æ®æ›´æ–°** - `tagsVersion` å¢åŠ 
   - è§¦å‘åœºæ™¯:
     - FigmaTagManager ä¿®æ”¹æ ‡ç­¾
     - TagService.updateTags() è¢«è°ƒç”¨
   - å½±å“: `hierarchicalTags` é‡æ–°è®¡ç®—

#### 3.1.3 ä½é¢‘è§¦å‘

1. **é¡µé¢åˆ‡æ¢** - `currentPage` å˜åŒ–
2. **åŒæ­¥å®Œæˆ** - `lastSyncTime` æ›´æ–°
3. **è®¤è¯çŠ¶æ€å˜åŒ–** - `lastAuthState` å˜åŒ–
4. **è®¾ç½®ä¿®æ”¹** - `appSettings` å˜åŒ–

### 3.2 æ¸²æŸ“ä¼˜åŒ–ç­–ç•¥

#### 3.2.1 å·²å®æ–½çš„ä¼˜åŒ–

1. **useMemo ç¼“å­˜**
   - `hierarchicalTags`: ç¼“å­˜æ ‡ç­¾æ•°æ®
   - `availableCalendars`: ç¼“å­˜æ—¥å†åˆ—è¡¨
   - `renderContent`: ç¼“å­˜é¡µé¢å†…å®¹ï¼ˆä¾èµ–è¾ƒå¤š statesï¼‰

2. **ç¨³å®šå¼•ç”¨ä¿è¯**
   - TagService.getTags() è¿”å›å†…éƒ¨ `this.tags` å¼•ç”¨
   - TagService.getFlatTags() è¿”å›å†…éƒ¨ `this.flatTags` å¼•ç”¨

3. **ç‰ˆæœ¬å·æœºåˆ¶**
   - ç”¨ `tagsVersion` ä»£æ›¿ `appTags` state
   - é¿å…ä¸å¿…è¦çš„æ•°ç»„å¼•ç”¨å˜åŒ–

#### 3.2.2 å¾…ä¼˜åŒ–é¡¹

1. **allEvents å…¨å±€çŠ¶æ€**
   - é—®é¢˜: ä¸»è¦ç”¨äºé¦–é¡µç»Ÿè®¡ï¼Œä½†è§¦å‘å…¨å±€é‡æ¸²æŸ“
   - å»ºè®®: 
     - ä½¿ç”¨ Context éš”ç¦»çŠ¶æ€
     - åªåœ¨é¦–é¡µæ—¶ç›‘å¬æ›´æ–°
     - æŒ‰éœ€åŠ è½½ç­–ç•¥

---

## 4. æœåŠ¡ä¾èµ–

### 4.1 æœåŠ¡åˆå§‹åŒ–é¡ºåº

```
App Component Mount
  â†“
1. CacheManager.checkAndClearOldCache()
  â†“
2. TagService.initialize()
  â†“
3. MicrosoftCalendarService (å·²åœ¨ç»„ä»¶å¤–åˆ›å»º)
  â†“
4. ActionBasedSyncManager (setSyncManager)
  â†“
5. EventService (é™æ€æ–¹æ³•è°ƒç”¨)
```

### 4.2 æœåŠ¡é€šä¿¡æœºåˆ¶

#### 4.2.1 TagService â†” App

```
TagService.updateTags()
  â†“
notifyListeners()
  â†“
App: handleTagsUpdate()
  â†“
setTagsVersion(v => v + 1)
  â†“
hierarchicalTags useMemo é‡æ–°æ‰§è¡Œ
  â†“
EventEditModal æ”¶åˆ°æ–° prop
```

#### 4.2.2 FigmaTagManager â†” App â†” TagService

```
FigmaTagManager ç”¨æˆ·ä¿®æ”¹æ ‡ç­¾
  â†“
onTagsChange(newTags)
  â†“
App: handleTagsChange()
  â†“
TagService.updateTags(hierarchicalTags)
  â†“
setTagsVersion(v => v + 1)
  â†“
hierarchicalTags æ›´æ–°
```

#### 4.2.3 EventService â†” App

```
PlanManager äº‹ä»¶æ“ä½œ
  â†“
EventService.createEvent() / updateEvent() / deleteEvent()
  â†“
localStorage æ›´æ–°
  â†“
App: onEventCreated / onEventUpdated / onEventDeleted
  â†“
setAllEvents(EventService.getAllEvents())
  â†“
App é‡æ¸²æŸ“
```

---

## 5. æ€§èƒ½é—®é¢˜è¯Šæ–­ä¸ä¿®å¤

### 5.1 é—®é¢˜ï¼šåˆ é™¤äº‹ä»¶å EventEditModal æ— é™é‡æ¸²æŸ“

#### 5.1.1 é—®é¢˜ç°è±¡

- åˆ é™¤ TimeCalendar äº‹ä»¶åï¼Œæ‰“å¼€ Timer çš„ EditModal
- TagPicker æ— æ³•ç‚¹å‡»ï¼ŒæŒç»­é‡æ¸²æŸ“ï¼ˆ48+ æ¬¡/ç§’ï¼‰
- ä¸‹æ‹‰æ¡†å»¶è¿Ÿ 2 åˆ†é’Ÿæ‰èƒ½æ‰“å¼€

#### 5.1.2 æ ¹æœ¬åŸå› 

```
åˆ é™¤äº‹ä»¶
  â†“
PlanManager: onEventDeleted()
  â†“
setAllEvents(EventService.getAllEvents())  // è§¦å‘ App é‡æ¸²æŸ“
  â†“
App é‡æ¸²æŸ“
  â†“
hierarchicalTags = useMemo(() => TagService.getTags(), [appTags])
  â†“
âŒ TagService.getTags() è¿”å›æ–°æ•°ç»„ [...this.tags]
  â†“
EventEditModal æ”¶åˆ°æ–° hierarchicalTags prop
  â†“
flatTags useMemo é‡æ–°è®¡ç®—
  â†“
filteredTags useMemo é‡æ–°è®¡ç®—
  â†“
æ— é™å¾ªç¯...
```

#### 5.1.3 ä¿®å¤æ–¹æ¡ˆï¼ˆå·²å®æ–½ï¼‰

**ä¿®å¤ 1: TagService.getTags() è¿”å›ç¨³å®šå¼•ç”¨**
```typescript
// Before (âŒ):
getTags(): HierarchicalTag[] {
  return [...this.tags];  // æ¯æ¬¡åˆ›å»ºæ–°æ•°ç»„
}

// After (âœ…):
getTags(): HierarchicalTag[] {
  return this.tags;  // ç›´æ¥è¿”å›å†…éƒ¨å¼•ç”¨
}
```

**ä¿®å¤ 2: ç§»é™¤å†—ä½™çš„ appTags state**
```typescript
// Before (âŒ):
const [appTags, setAppTags] = useState<any[]>([]);
const hierarchicalTags = useMemo(() => {
  return TagService.getTags();
}, [appTags]);

// After (âœ…):
const [tagsVersion, setTagsVersion] = useState(0);
const hierarchicalTags = useMemo(() => {
  return TagService.getTags();
}, [tagsVersion]);
```

**ä¿®å¤ 3: ç¼“å­˜ availableCalendars**
```typescript
// Before (âŒ):
<EventEditModal
  availableCalendars={getAvailableCalendarsForSettings()}  // æ¯æ¬¡æ–°æ•°ç»„
/>

// After (âœ…):
const availableCalendars = useMemo(() => {
  return getAvailableCalendarsForSettings();
}, []);

<EventEditModal
  availableCalendars={availableCalendars}  // ç¨³å®šå¼•ç”¨
/>
```

#### 5.1.4 ä¿®å¤æ•ˆæœ

- âœ… EventEditModal ä¸å†æ— é™é‡æ¸²æŸ“
- âœ… TagPicker å“åº”æ­£å¸¸
- âœ… App é‡æ¸²æŸ“é¢‘ç‡é™ä½

---

## 6. æ•°æ®æµå›¾

### 6.1 æ ‡ç­¾æ•°æ®æµ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      TagService                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ private tags: HierarchicalTag[]                      â”‚   â”‚
â”‚  â”‚ private flatTags: FlatTag[]                          â”‚   â”‚
â”‚  â”‚ private listeners: Function[]                        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                         â†•                                    â”‚
â”‚         localStorage['remarkable-hierarchical-tags']        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
                    getTags() â† è¿”å›ç¨³å®šå¼•ç”¨ this.tags
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         App.tsx                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ tagsVersion: number (state)                          â”‚   â”‚
â”‚  â”‚    â†“                                                 â”‚   â”‚
â”‚  â”‚ hierarchicalTags = useMemo(() => {                   â”‚   â”‚
â”‚  â”‚   return TagService.getTags();                       â”‚   â”‚
â”‚  â”‚ }, [tagsVersion]);                                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“ (prop)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    EventEditModal                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ hierarchicalTags (prop)                              â”‚   â”‚
â”‚  â”‚    â†“                                                 â”‚   â”‚
â”‚  â”‚ flatTags = useMemo(() => {                           â”‚   â”‚
â”‚  â”‚   return flatten(hierarchicalTags);                  â”‚   â”‚
â”‚  â”‚ }, [hierarchicalTags, isOpen]);                      â”‚   â”‚
â”‚  â”‚    â†“                                                 â”‚   â”‚
â”‚  â”‚ filteredTags = useMemo(() => {                       â”‚   â”‚
â”‚  â”‚   return flatTags.filter(...);                       â”‚   â”‚
â”‚  â”‚ }, [flatTags, tagSearchQuery]);                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                         â†“                                    â”‚
â”‚                  TagPicker ä¸‹æ‹‰èœå•                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.2 äº‹ä»¶æ•°æ®æµ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      EventService                           â”‚
â”‚         localStorage['remarkable-events']                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
              getAllEvents() / createEvent() / updateEvent()
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      PlanManager                            â”‚
â”‚  onEventCreated / onEventUpdated / onEventDeleted           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“ (callback)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         App.tsx                             â”‚
â”‚  setAllEvents(EventService.getAllEvents())                  â”‚
â”‚        â†“                                                     â”‚
â”‚  allEvents: Event[] (state) â† è§¦å‘ App é‡æ¸²æŸ“               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“ (prop)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    DailyStatsCard                           â”‚
â”‚  è®¡ç®—ä»Šæ—¥ç»Ÿè®¡æ•°æ®                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 7. å·²çŸ¥é™åˆ¶ä¸å¾…ä¼˜åŒ–é¡¹

### 7.1 æ€§èƒ½ç“¶é¢ˆ

| é—®é¢˜ | å½±å“ | ä¼˜å…ˆçº§ | çŠ¶æ€ |
|------|------|--------|------|
| ~~è®¡æ—¶å™¨æ¯ç§’è§¦å‘ App é‡æ¸²æŸ“~~ | ~~é«˜~~ | ~~P1~~ | **âœ… å·²ä¿®å¤ v1.7.1** |
| allEvents è§¦å‘å…¨å±€é‡æ¸²æŸ“ | ä¸­ | P2 | ä½¿ç”¨ Context æˆ–æŒ‰éœ€åŠ è½½ |
| storage äº‹ä»¶ç›‘å¬æ— æ•ˆ | ä½ | P3 | æ”¹ç”¨è‡ªå®šä¹‰äº‹ä»¶é€šä¿¡ |

### 7.2 ä»£ç å¯ç»´æŠ¤æ€§

| é—®é¢˜ | å½±å“ | ä¼˜å…ˆçº§ | çŠ¶æ€ |
|------|------|--------|------|
| ~~21ä¸ª states åœ¨ä¸€ä¸ªç»„ä»¶~~ | ~~ä¸­~~ | ~~P2~~ | **âœ… å·²ä¼˜åŒ–è‡³18ä¸ª** |
| è¿‡å¤šçš„ useEffect ä¾èµ– | ä¸­ | P2 | ä½¿ç”¨ useReducer åˆå¹¶çŠ¶æ€ |
| æœåŠ¡è°ƒç”¨åˆ†æ•£ | ä½ | P3 | ç»Ÿä¸€æœåŠ¡ç®¡ç†å±‚ |

---

## 8. æœ€ä½³å®è·µ

### 8.1 æ·»åŠ æ–°åŠŸèƒ½æ—¶çš„æ³¨æ„äº‹é¡¹

1. **é¿å…åœ¨ App å±‚æ·»åŠ æ–° state**
   - ä¼˜å…ˆè€ƒè™‘ Context æˆ–ç»„ä»¶å†…éƒ¨çŠ¶æ€
   - åªæœ‰çœŸæ­£å…¨å±€å…±äº«çš„æ•°æ®æ‰æ”¾åœ¨ App

2. **ä½¿ç”¨ useMemo ç¼“å­˜è®¡ç®—å€¼**
   - ç¡®ä¿ä¾èµ–æ•°ç»„æ­£ç¡®
   - é¿å…åœ¨ä¾èµ–é¡¹ä¸­ä½¿ç”¨ä¸ç¨³å®šå¼•ç”¨

3. **æœåŠ¡å±‚è¿”å›ç¨³å®šå¼•ç”¨**
   - getTags() / getFlatTags() ç›´æ¥è¿”å›å†…éƒ¨æ•°ç»„
   - è°ƒç”¨æ–¹ä¸åº”ä¿®æ”¹è¿”å›å€¼

### 8.2 æ€§èƒ½ä¼˜åŒ–æŒ‡å—

1. **è¯†åˆ«é«˜é¢‘æ›´æ–°çš„ state**
   - ä½¿ç”¨ React DevTools Profiler
   - æ·»åŠ æ¸²æŸ“æ—¥å¿—ï¼ˆå¼€å‘ç¯å¢ƒï¼‰

2. **éš”ç¦»é¢‘ç¹å˜åŒ–çš„æ•°æ®**
   - ä½¿ç”¨ Context åˆ†ç¦»å…³æ³¨ç‚¹
   - React.memo åŒ…è£…å­ç»„ä»¶

3. **ä½¿ç”¨ç‰ˆæœ¬å·è§¦å‘æ›´æ–°**
   - é¿å…ä¼ é€’å¤§å¯¹è±¡/æ•°ç»„ä½œä¸ºä¾èµ–
   - ç”¨ç®€å•ç±»å‹ï¼ˆnumber/stringï¼‰è§¦å‘é‡æ–°è®¡ç®—

---

## 9. ç‰ˆæœ¬å†å²

### v1.7.2 (2025-11-10)

**æ€§èƒ½ä¼˜åŒ– - TagService æ ¸å¿ƒé€»è¾‘ä¿®å¤**:
- âœ… ä¿®å¤ `getFlatTags()` åŒæ­¥åŠ è½½é€»è¾‘
  - ç§»é™¤ `this.flatTags.length === 0` æ£€æŸ¥
  - åªåœ¨ `!this.initialized` æ—¶åŠ è½½å¹¶æ ‡è®°å®Œæˆ
  - é¿å…é‡å¤è°ƒç”¨ flattenTags()
  
- âœ… ä¿®å¤ `flattenTags()` æ•°æ®ç»“æ„æ··ä¹±
  - ç§»é™¤ `tag.parentId || parentId` é€»è¾‘
  - ç»Ÿä¸€ä½¿ç”¨é€’å½’å‚æ•° `parentId`
  - é¿å…å±‚çº§ç»“æ„å’Œæ‰å¹³ç»“æ„æ··æ·†
  
- âœ… ç§»é™¤ä¸å¿…è¦çš„ level é‡ç®—é€»è¾‘
  - åˆ é™¤ O(nÂ²) çš„ needsLevelRecalc æ£€æŸ¥
  - level å­—æ®µç”±é€’å½’å‚æ•°ç›´æ¥ç¡®å®š
  
- âœ… æ·»åŠ æ€§èƒ½ç›‘æ§ç³»ç»Ÿ
  - getFlatTags() è°ƒç”¨é¢‘ç‡ç›‘æ§
  - flattenTags() æ‰§è¡Œæ—¶é—´æµ‹é‡
  - EventEditModal é‡æ¸²æŸ“æ£€æµ‹
  - hierarchicalTags å¼•ç”¨å˜åŒ–è¿½è¸ª

**æ€§èƒ½æ”¹å–„**:
- ğŸ“ˆ flattenTags() æ‰§è¡Œæ—¶é—´æå‡ 73%ï¼ˆ0.3ms â†’ 0.08msï¼‰
- ğŸ“‰ ä¸å†å‡ºç° "æ£€æµ‹åˆ°éœ€è¦é‡ç®— level" è­¦å‘Š
- ğŸš€ é¦–æ¬¡æ‰“å¼€ TagPicker ä¸å†ä¸ºç©º

**è¯Šæ–­å·¥å…·**:
- ğŸ“ åˆ›å»º `PERFORMANCE_DIAGNOSIS_v1.7.2.md` å®Œæ•´è¯Šæ–­æŒ‡å—

### v1.7.1 (2025-11-10)

**æ€§èƒ½ä¼˜åŒ– - ç§»é™¤æ—§è®¡æ—¶å™¨ç³»ç»Ÿå’Œæ­»ä»£ç **:
- âœ… ç§»é™¤æ—§è®¡æ—¶å™¨ç³»ç»Ÿï¼ˆ6ä¸ªçŠ¶æ€: seconds, isActive, taskName, currentTask, timerSessions, intervalRefï¼‰
- âœ… åˆ é™¤æœªä½¿ç”¨å‡½æ•°ï¼ˆ6ä¸ª: startTimer, pauseTimer, handleStartTimer, stopTimer, formatTime, getTodayTotalTimeï¼‰
- âœ… åˆ é™¤æœªä½¿ç”¨å¯¼å…¥ï¼ˆTaskManagerï¼‰
- âœ… TimeCalendar ç§»é™¤ `onStartTimer` prop
- ğŸ§¹ æ¸…ç†çº¦ 40 è¡Œæ­»ä»£ç 

**ç»Ÿè®¡æ•°æ®**:
- ğŸ“‰ çŠ¶æ€æ•°é‡ï¼š21ä¸ª â†’ **18ä¸ª**ï¼ˆ-14%ï¼‰
- ğŸ“‰ è®¡æ—¶å™¨çŠ¶æ€ï¼š7ä¸ª â†’ **1ä¸ª**ï¼ˆ-86%ï¼‰
- ğŸ¯ æ€§èƒ½æ”¹å–„ï¼šTimer è¿è¡Œæ—¶ App ç»„ä»¶ 0 æ¬¡/ç§’é‡æ¸²æŸ“

**æ¶æ„ä¼˜åŒ–**:
- Timer å®Œå…¨ç”± `globalTimer` å¯¹è±¡ç®¡ç†
- TimerCard ç»„ä»¶è‡ªè¡Œç®¡ç† UI æ—¶é—´æ˜¾ç¤ºæ›´æ–°

### v1.7.0 (2025-01-xx)

**æ€§èƒ½ä¼˜åŒ– - TagService å¼•ç”¨ç¨³å®šæ€§**:
- âœ… ä¿®å¤ TagService.getTags() è¿”å›ç¨³å®šå¼•ç”¨
- âœ… ç§»é™¤å†—ä½™ appTags stateï¼Œæ”¹ç”¨ tagsVersion
- âœ… ç¼“å­˜ availableCalendars é¿å…é‡å¤åˆ›å»º
- âœ… è§£å†³åˆ é™¤äº‹ä»¶å EventEditModal æ— é™é‡æ¸²æŸ“é—®é¢˜

**æ–‡æ¡£**:
- âœ… åˆ›å»º APP_ARCHITECTURE_PRD.md
- âœ… è®°å½•å®Œæ•´çŠ¶æ€æ¸…å•å’Œæ¸²æŸ“æœºåˆ¶
- âœ… æ·»åŠ æ•°æ®æµå›¾å’Œæ€§èƒ½ä¼˜åŒ–æŒ‡å—

---

## 10. å‚è€ƒæ–‡æ¡£

- [SYNC_MECHANISM_PRD.md](./SYNC_MECHANISM_PRD.md) - åŒæ­¥æœºåˆ¶æ–‡æ¡£
- [TagService æºç ](../../src/services/TagService.ts)
- [EventService æºç ](../../src/services/EventService.ts)
- [App.tsx æºç ](../../src/App.tsx)
- [DIAGNOSIS.md](../../DIAGNOSIS.md) - æ€§èƒ½é—®é¢˜è¯Šæ–­æŠ¥å‘Š
