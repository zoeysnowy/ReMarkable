# v2.7.4: æˆªæ­¢æ—¶é—´å…³é”®è¯æ”¯æŒ + timeFieldState ä¼˜åŒ–

## åŠŸèƒ½æ¦‚è¿°

1. **æˆªæ­¢æ—¶é—´å…³é”®è¯æ”¯æŒ**ï¼šè¯†åˆ«"æˆªæ­¢"ã€"ddl"ã€"deadline"ç­‰å…³é”®è¯ï¼Œè‡ªåŠ¨å°†æ—¶é—´è®¾ç½®ä¸º**ç»“æŸæ—¶é—´**è€Œéå¼€å§‹æ—¶é—´
2. **timeFieldState ä¼˜åŒ–**ï¼šä»å¸ƒå°”æ ‡è®°æ”¹ä¸ºå­˜å‚¨å®é™…æ—¶é—´å€¼ï¼Œç¡®ä¿é‡æ–°æ‰“å¼€ Picker æ—¶ç²¾ç¡®æ¢å¤ç”¨æˆ·è®¾ç½®

## éœ€æ±‚æ¥æº

ç”¨æˆ·è¾“å…¥ï¼š
- "å‘¨äº”æ™šä¸Š10ç‚¹æˆªæ­¢" â†’ åº”è®¾ç½® `endTime=22:00`ï¼ˆè€Œé `startTime=22:00`ï¼‰
- "ä¸‹å‘¨äºŒä¸­åˆ12ç‚¹ddl" â†’ åº”è®¾ç½® `endTime=12:00`
- "æœ€æ™š10ç‚¹å‰å®Œæˆ" â†’ åº”è®¾ç½® `endTime=22:00`

ç—›ç‚¹ï¼š
- é‡æ–°æ‰“å¼€ Picker æ—¶ï¼Œå³ä½¿åªè®¾ç½®äº† `startTime`ï¼Œ`endTime` ä¹Ÿè¢«é”™è¯¯åœ°å¡«å……äº†ç›¸åŒçš„å€¼
- åŸå› ï¼šæ—§çš„ `timeFieldState=[1,0,0,0]` åªè®°å½•äº†"æ˜¯å¦è®¾ç½®"ï¼Œé‡æ–°åŠ è½½æ—¶éœ€è¦ä» ISO å­—ç¬¦ä¸²è§£æï¼Œå¯¼è‡´è¯¯åˆ¤

## æ ¸å¿ƒæ”¹åŠ¨

### 1. timeFieldState é‡æ–°è®¾è®¡

#### v2.5 æ—§è®¾è®¡ï¼ˆå·²åºŸå¼ƒï¼‰
```typescript
timeFieldState: [number, number, number, number]  // [startTime?, endTime?, dueDate?, allDay?]
// 1 = ç”¨æˆ·è®¾ç½®äº†ï¼Œ0 = æœªè®¾ç½®
// ä¾‹å¦‚ï¼š[1, 0, 0, 0] è¡¨ç¤ºåªè®¾ç½®äº† startTime
```

**é—®é¢˜**ï¼š
- é‡æ–°åŠ è½½æ—¶éœ€è¦ä» `start/end` ISO å­—ç¬¦ä¸²è§£ææ—¶é—´å€¼
- æ— æ³•åŒºåˆ†"å•ä¸€å¼€å§‹æ—¶é—´ï¼ˆstart=15:00, end=15:00ï¼‰"å’Œ"æ—¶é—´æ®µï¼ˆstart=13:00, end=18:00ï¼‰"
- å¯¼è‡´ `endTime` è¢«é”™è¯¯åœ°åˆå§‹åŒ–

#### v2.7.4 æ–°è®¾è®¡
```typescript
timeFieldState: [number | null, number | null, number | null, number | null]
// [startHour, startMinute, endHour, endMinute]
// null = æœªè®¾ç½®ï¼Œæ•°å­— = å®é™…å€¼
// ä¾‹å¦‚ï¼š[15, 0, null, null] è¡¨ç¤ºåªè®¾ç½®äº† startTime=15:00
```

**ä¼˜åŠ¿**ï¼š
- âœ… ç›´æ¥å­˜å‚¨å®é™…å€¼ï¼Œæ— éœ€è§£æ
- âœ… ç²¾ç¡®æ¢å¤ç”¨æˆ·è®¾ç½®ï¼Œ`null` æ˜ç¡®è¡¨ç¤ºæœªè®¾ç½®
- âœ… é™çº§å…¼å®¹ï¼šå¦‚æœæ²¡æœ‰ `timeFieldState`ï¼Œå›é€€åˆ°æ—¶é—´åˆ¤æ–­é€»è¾‘

### 2. æ¥å£æ‰©å±•

æ–°å¢ `TimeType` ç±»å‹å’Œ `timeType` å­—æ®µï¼š

```typescript
/**
 * æ—¶é—´ç±»å‹ï¼šå¼€å§‹æ—¶é—´ vs æˆªæ­¢æ—¶é—´
 */
export type TimeType = 'start' | 'due' | 'none';

export interface TimePeriod {
  name: string;
  startHour: number;
  startMinute: number;
  endHour: number;
  endMinute: number;
  isFuzzyTime: boolean;
  timeType?: TimeType;  // ğŸ†• æ–°å¢å­—æ®µ
}

export interface ParseResult {
  dateRange?: DateRange;
  timePeriod?: TimePeriod;
  pointInTime?: PointInTime;
  matched: boolean;
  timeType?: TimeType;  // ğŸ†• å…¨å±€æ—¶é—´ç±»å‹
}

// ğŸ†• v2.7.4: timeFieldState æ”¹ä¸ºå­˜å‚¨å®é™…å€¼
export interface TimeGetResult {
  timeSpec?: TimeSpec;
  start?: string;
  end?: string;
  displayHint?: string | null;
  isFuzzyDate?: boolean;
  timeFieldState?: [number | null, number | null, number | null, number | null];  // [startHour, startMinute, endHour, endMinute]
  isFuzzyTime?: boolean;
  fuzzyTimeName?: string;
}
```

### 3. æˆªæ­¢å…³é”®è¯åº“

æ”¯æŒä»¥ä¸‹å…³é”®è¯ï¼ˆå¤§å°å†™ä¸æ•æ„Ÿï¼‰ï¼š

#### ä¸­æ–‡æ ¸å¿ƒè¯
- **æˆªæ­¢**ã€**ç»“æŸ**ã€**ç»ˆæ­¢**ã€**å®Œæˆ**
- **æœ€æ™š**ã€**ä¸æ™šäº**

#### åœºæ™¯è¯
- **ddl**ã€**deadline**ã€**due**
- **é—­é¦†**ã€**æ•£ä¼š**ã€**ä¸‹ç­**

#### è‹±æ–‡è¯
- **before**ã€**by**ã€**until**
- **no later than**

#### ç‰¹æ®Šæ¨¡å¼
- **"Xå‰"** æ¨¡å¼ï¼šå¦‚"10ç‚¹å‰"ã€"22:00å‰"ï¼ˆé€šè¿‡æ­£åˆ™ `/\d+[ï¼š:ç‚¹]\s*å‰/` æ£€æµ‹ï¼‰

### 3. è§£æé€»è¾‘

åœ¨ `parseNaturalLanguage` å‡½æ•°å¼€å¤´ä¼˜å…ˆæ£€æµ‹ï¼š

```typescript
// ğŸ†• v2.7.4: æ£€æµ‹æˆªæ­¢å…³é”®è¯ï¼ˆä¼˜å…ˆçº§æœ€é«˜ï¼‰
const deadlineKeywords = [
  'æˆªæ­¢', 'ç»“æŸ', 'ç»ˆæ­¢', 'å®Œæˆ', 'æœ€æ™š', 'ä¸æ™šäº', 
  'ddl', 'deadline', 'due', 'é—­é¦†', 'æ•£ä¼š', 'ä¸‹ç­',
  'before', 'by', 'until', 'no later than',
];
const hasDueKeyword = deadlineKeywords.some(kw => trimmedInput.includes(kw));
const hasBeforePattern = /\d+[ï¼š:ç‚¹]\s*å‰/.test(trimmedInput);
const isDueTime = hasDueKeyword || hasBeforePattern;
```

è¿”å›ç»“æœæ—¶è®¾ç½® `timeType`ï¼š

```typescript
return {
  matched: true,
  timePeriod: {
    // ... å…¶ä»–å­—æ®µ
    timeType: isDueTime ? 'due' : 'start'
  },
  timeType: isDueTime ? 'due' : 'start'
};
```

### 4. åº”ç”¨é€»è¾‘

åœ¨ `UnifiedDateTimePicker` ä¸­æ ¹æ® `timeType` å†³å®šè®¾ç½®å“ªä¸ªæ—¶é—´å­—æ®µï¼š

```typescript
const timeType = customParsed.timePeriod.timeType || customParsed.timeType || 'start';

if (timeType === 'due') {
  // æˆªæ­¢æ—¶é—´ï¼šåªè®¾ç½®ç»“æŸæ—¶é—´
  setStartTime(null);
  setEndTime({
    hour: customParsed.timePeriod.startHour,
    minute: customParsed.timePeriod.startMinute
  });
  setFuzzyTimeName(null);
} else if (customParsed.timePeriod.isFuzzyTime) {
  // æ¨¡ç³Šæ—¶é—´æ®µï¼šè®¾ç½®å¼€å§‹å’Œç»“æŸæ—¶é—´
  setStartTime(...);
  setEndTime(...);
  setFuzzyTimeName(...);
} else {
  // ç²¾ç¡®å¼€å§‹æ—¶é—´ï¼šåªè®¾ç½®å¼€å§‹æ—¶é—´
  setStartTime(...);
  setEndTime(null);
  setFuzzyTimeName(null);
}
```

### 5. Picker ä¿å­˜å’Œè¯»å–é€»è¾‘

#### ä¿å­˜æ—¶ï¼ˆhandleApplyï¼‰

```typescript
// ğŸ†• v2.7.4: timeFieldState å­˜å‚¨å®é™…çš„æ—¶é—´å€¼
const timeFieldState: [number | null, number | null, number | null, number | null] = [
  startTime?.hour ?? null,    // startHour
  startTime?.minute ?? null,  // startMinute
  endTime?.hour ?? null,      // endHour
  endTime?.minute ?? null     // endMinute
];

await TimeHub.setEventTime(eventId, {
  start: startIso,
  end: endIso,
  allDay: allDaySelected,
  displayHint: finalDisplayHint,
  timeFieldState,  // ä¿å­˜å®é™…å€¼
  isFuzzyDate,
  isFuzzyTime,
  fuzzyTimeName
});
```

#### è¯»å–æ—¶ï¼ˆuseEffect åˆå§‹åŒ–ï¼‰

```typescript
// ğŸ†• v2.7.4: ä½¿ç”¨ç»Ÿä¸€çš„æ—¶é—´è§£æå‡½æ•°ï¼ˆç¬¦åˆ Time Architecture çº¦å®šï¼‰
const start = eventTime.start ? dayjs(parseLocalTimeString(eventTime.start)) : null;
const end = eventTime.end ? dayjs(parseLocalTimeString(eventTime.end)) : start;

// ğŸ†• v2.7.4: ç›´æ¥ä½¿ç”¨ timeFieldState ä¸­å­˜å‚¨çš„å®é™…å€¼ï¼ˆé¿å…ä» ISO è§£ææ—¶é—´ï¼‰
const savedFieldState = eventTime.timeFieldState;
if (savedFieldState) {
  const [startHour, startMinute, endHour, endMinute] = savedFieldState;
  setStartTime(startHour !== null && startMinute !== null 
    ? { hour: startHour, minute: startMinute } 
    : null);
  setEndTime(endHour !== null && endMinute !== null 
    ? { hour: endHour, minute: endMinute } 
    : null);
} else {
  // é™çº§ï¼šå¦‚æœæ²¡æœ‰ timeFieldStateï¼Œæ ¹æ®æ—¶é—´æ˜¯å¦ä¸º 00:00 åˆ¤æ–­ï¼ˆå…¼å®¹æ—§æ•°æ®ï¼‰
  const hasSpecificStart = start.hour() !== 0 || start.minute() !== 0;
  const hasSpecificEnd = end ? (end.hour() !== 0 || end.minute() !== 0) : false;
  setStartTime(hasSpecificStart ? { hour: start.hour(), minute: start.minute() } : null);
  setEndTime(end && hasSpecificEnd ? { hour: end.hour(), minute: end.minute() } : null);
}
```

**å…³é”®ä¼˜åŠ¿**ï¼š
- âœ… éµå¾ª Time Architecture çº¦å®šï¼Œä½¿ç”¨ `parseLocalTimeString` è§£ææ—¥æœŸ
- âœ… æ—¶é—´å€¼ï¼ˆhour/minuteï¼‰ä» `timeFieldState` ç›´æ¥è¯»å–ï¼Œæ— éœ€è§£æ
- âœ… `null` æ˜ç¡®è¡¨ç¤ºæœªè®¾ç½®ï¼Œé¿å…è¯¯åˆ¤
- âœ… å…¼å®¹æ—§æ•°æ®ï¼ˆæ—  `timeFieldState` æ—¶é™çº§ï¼‰

### 6. PlanManager æ˜¾ç¤ºé€»è¾‘

### 6. PlanManager æ˜¾ç¤ºé€»è¾‘

æ›´æ–°åˆ¤æ–­æ¡ä»¶ä»¥é€‚é…æ–°çš„ `timeFieldState` æ ¼å¼ï¼š

```typescript
// ğŸ†• v2.7.4: timeFieldState å­˜å‚¨å®é™…å€¼ï¼Œnull è¡¨ç¤ºæœªè®¾ç½®
const hasStartTimeField = timeFieldState && timeFieldState[0] !== null && timeFieldState[1] !== null;
const hasEndTimeField = timeFieldState && timeFieldState[2] !== null && timeFieldState[3] !== null;
```

PlanManager å·²æ”¯æŒæˆªæ­¢æ—¶é—´æ˜¾ç¤ºï¼ˆçº¢è‰²"æˆªæ­¢"æ ‡ç­¾ï¼‰ï¼Œå½“åªæœ‰ `endTime` æ—¶è‡ªåŠ¨è§¦å‘ï¼š

```tsx
{/* å•ä¸€ç»“æŸæ—¶é—´ï¼šçº¢è‰²æˆªæ­¢æ ‡ç­¾ */}
{hasEndTimeField && !hasStartTimeField && (
  <Tooltip title="æˆªæ­¢æ—¶é—´">
    <span className="time-label end-label">æˆªæ­¢</span>
  </Tooltip>
)}

{/* å•ä¸€å¼€å§‹æ—¶é—´ï¼šç»¿è‰²å¼€å§‹æ ‡ç­¾ */}
{hasStartTimeField && !hasEndTimeField && (
  <Tooltip title="å¼€å§‹æ—¶é—´">
    <span className="time-label start-label">å¼€å§‹</span>
  </Tooltip>
)}
```

## æµ‹è¯•æ¡ˆä¾‹

| è¾“å…¥ç¤ºä¾‹ | é¢„æœŸç»“æœ | timeFieldState | æ—¶é—´å­—æ®µ | æ˜¾ç¤º |
|---------|---------|---------------|---------|------|
| "å‘¨äº”æ™šä¸Š10ç‚¹æˆªæ­¢" | endTime=22:00 | `[null,null,22,0]` | endTime only | ğŸ”´ æˆªæ­¢ 22:00 |
| "ä¸‹å‘¨äºŒä¸­åˆ12ç‚¹ddl" | endTime=12:00 | `[null,null,12,0]` | endTime only | ğŸ”´ æˆªæ­¢ 12:00 |
| "æœ€æ™šæ˜å¤©10ç‚¹å‰å®Œæˆ" | endTime=10:00 | `[null,null,10,0]` | endTime only | ğŸ”´ æˆªæ­¢ 10:00 |
| "å‘¨äº”æ™šä¸Š10ç‚¹å¼€å§‹" | startTime=22:00 | `[22,0,null,null]` | startTime only | ğŸŸ¢ å¼€å§‹ 22:00 |
| "ä¸‹åˆ3ç‚¹" | startTime=15:00 | `[15,0,null,null]` | startTime only | ğŸŸ¢ å¼€å§‹ 15:00 |
| "ä¸‹åˆ" | startTime=13:00, endTime=18:00 | `[13,0,18,0]` | both | 13:00 â†’ 18:00 |

**é‡æ–°æ‰“å¼€ Picker éªŒè¯**ï¼š
- "ä¸‹åˆ3ç‚¹" â†’ Picker æ˜¾ç¤º startHour=15, startMinute=00, endHour=--, endMinute=-- âœ…
- "ä¸‹åˆ3ç‚¹æˆªæ­¢" â†’ Picker æ˜¾ç¤º startHour=--, startMinute=--, endHour=15, endMinute=00 âœ…

## ç‰ˆæœ¬å¯¹æ¯”

### v2.5ï¼ˆæ—§ç‰ˆï¼‰
- âŒ `timeFieldState=[1,0,0,0]` åªè®°å½•"æ˜¯å¦è®¾ç½®"
- âŒ é‡æ–°æ‰“å¼€ Picker æ—¶éœ€è¦ä» ISO è§£ææ—¶é—´
- âŒ æ— æ³•åŒºåˆ†å•ä¸€å¼€å§‹æ—¶é—´å’Œæ—¶é—´æ®µï¼ˆéƒ½æ˜¯ start=15:00, end=15:00ï¼‰
- âŒ å¯¼è‡´ `endTime` è¢«é”™è¯¯å¡«å……

### v2.7.3 ä¹‹å‰
- âŒ "å‘¨äº”æ™šä¸Š10ç‚¹æˆªæ­¢" â†’ startTime=22:00ï¼ˆé”™è¯¯ï¼‰
- âŒ æ— æ³•åŒºåˆ†å¼€å§‹æ—¶é—´å’Œæˆªæ­¢æ—¶é—´
- âŒ ç¼ºå°‘æˆªæ­¢å…³é”®è¯æ£€æµ‹

### v2.7.4 ä¹‹å
- âœ… **timeFieldState ä¼˜åŒ–**ï¼š`[15,0,null,null]` ç›´æ¥å­˜å‚¨å®é™…å€¼
- âœ… **ç²¾ç¡®æ¢å¤**ï¼šé‡æ–°æ‰“å¼€ Picker æ—¶ï¼Œ`null` å­—æ®µä¸ä¼šè¢«å¡«å……
- âœ… **æˆªæ­¢å…³é”®è¯**ï¼šæ”¯æŒ 15+ å…³é”®è¯ï¼ˆä¸­è‹±æ–‡ï¼‰
- âœ… **æ™ºèƒ½è®¾ç½®**ï¼š
  - "åå¤©ä¸‹åˆ3ç‚¹" â†’ `[15,0,null,null]` â†’ åªè®¾ç½® startTime
  - "åå¤©ä¸‹åˆ3ç‚¹æˆªæ­¢" â†’ `[null,null,15,0]` â†’ åªè®¾ç½® endTime
- âœ… **æ˜¾ç¤ºä¼˜åŒ–**ï¼šçº¢è‰²"æˆªæ­¢"æ ‡ç­¾ + ç»¿è‰²"å¼€å§‹"æ ‡ç­¾
- âœ… **é™çº§å…¼å®¹**ï¼šæ—  `timeFieldState` æ—¶å›é€€åˆ°æ—¶é—´åˆ¤æ–­

## è°ƒè¯•æ—¥å¿—

å¯ç”¨ `dict` å’Œ `picker` è°ƒè¯•æ—¥å¿—ï¼š

```
localStorage.setItem('DEBUG', 'dict,picker');
```

é¢„æœŸè¾“å‡ºï¼š
```
ğŸ” æ£€æµ‹æˆªæ­¢å…³é”®è¯ { isDueTime: true, hasDueKeyword: true, input: "å‘¨äº”æ™šä¸Š10ç‚¹æˆªæ­¢" }
â° è¯†åˆ«ä¸ºæˆªæ­¢æ—¶é—´ï¼ˆåªè®¾ç½®ç»“æŸæ—¶é—´ï¼‰ { timePeriod: "æ™šä¸Š10ç‚¹", endTime: "22:0", keywords: "æˆªæ­¢/ddl/deadline/due/æœ€æ™š/ä¸æ™šäº" }
```

## ç›¸å…³æ–‡ä»¶

- `src/utils/naturalLanguageTimeDictionary.ts` - æ¥å£å®šä¹‰ã€æˆªæ­¢å…³é”®è¯æ£€æµ‹
- `src/components/FloatingToolbar/pickers/UnifiedDateTimePicker.tsx` - æ—¶é—´å­—æ®µè®¾ç½®é€»è¾‘
- `src/components/PlanManager.tsx` - çº¢è‰²"æˆªæ­¢"æ ‡ç­¾æ˜¾ç¤º

## æŠ€æœ¯å€ºåŠ¡

1. **"Xå‰" æ¨¡å¼æ‰©å±•**ï¼šå½“å‰ä»…æ”¯æŒ `/\d+[ï¼š:ç‚¹]\s*å‰/`ï¼Œæœªæ¥å¯æ‰©å±•ä¸ºï¼š
   - "å‘¨äº”å‰" â†’ å‘¨äº”å…¨å¤©æˆªæ­¢
   - "æœ¬å‘¨å‰" â†’ æœ¬å‘¨æ—¥æˆªæ­¢
   - "æ˜å¹´å‰" â†’ æ˜å¹´ç¬¬ä¸€å¤©æˆªæ­¢

2. **æ¨¡ç³Šæ—¶é—´æ®µ+æˆªæ­¢**ï¼š
   - "ä¸‹åˆæˆªæ­¢" åº”è®¾ç½® endTime=18:00ï¼ˆä¸‹åˆç»“æŸæ—¶é—´ï¼‰
   - å½“å‰é€»è¾‘ä»…å¤„ç†ç²¾ç¡®æ—¶é—´+æˆªæ­¢å…³é”®è¯

3. **å¤šè¯­è¨€æ”¯æŒ**ï¼š
   - å½“å‰ä»…æ”¯æŒä¸­è‹±æ–‡
   - æœªæ¥å¯æ·»åŠ æ—¥æ–‡ï¼ˆç· åˆ‡ï¼‰ã€éŸ©æ–‡ï¼ˆë§ˆê°ï¼‰ç­‰

## æ›´æ–°æ—¥å¿—

- **2025-01-XX**: v2.7.4 åˆå§‹å‘å¸ƒ
  - æ–°å¢ `TimeType` ç±»å‹å’Œ `timeType` å­—æ®µ
  - æ”¯æŒ 15+ æˆªæ­¢å…³é”®è¯
  - æ ¹æ® `timeType` æ™ºèƒ½è®¾ç½®å¼€å§‹/ç»“æŸæ—¶é—´
  - å®Œå–„è°ƒè¯•æ—¥å¿—
