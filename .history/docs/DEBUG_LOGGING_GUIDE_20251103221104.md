# å®Œæ•´è°ƒè¯•æ—¥å¿—æŒ‡å—

## ğŸ¯ ç›®æ ‡

é€šè¿‡è¯¦ç»†çš„ä¸­æ–‡è°ƒè¯•æ—¥å¿—ï¼Œè¿½è¸ªä»**ç”¨æˆ·æ“ä½œ â†’ æ•°æ®æ›´æ–° â†’ UIæ˜¾ç¤º**çš„å®Œæ•´æ•°æ®æµã€‚

---

## ğŸ“‹ å·²å¢å¼ºçš„æ—¥å¿—æ¨¡å—

### 1. **UnifiedDateTimePickerï¼ˆæ—¶é—´é€‰æ‹©å™¨ï¼‰**

#### è®°å½•å†…å®¹ï¼š
- âœ… ç”¨æˆ·ç‚¹å‡»çš„å¿«æ·æŒ‰é’®ï¼ˆæ˜å¤©ã€æœ¬å‘¨ã€ä¸‹å‘¨ã€ä¸Šåˆã€ä¸‹åˆã€æ™šä¸Šï¼‰
- âœ… ç”¨æˆ·ç‚¹å‡»æ—¥å†é€‰æ‹©çš„æ—¥æœŸèŒƒå›´
- âœ… æœ€ç»ˆæäº¤æ—¶çš„æ—¥æœŸã€æ—¶é—´ã€å¿«æ·æŒ‰é’®çŠ¶æ€
- âœ… TimeHub å†™å…¥çš„å‚æ•°ï¼ˆeventId, startIso, endIso, allDayï¼‰
- âœ… å†™å…¥æˆåŠŸ/å¤±è´¥çŠ¶æ€

#### æ—¥å¿—ç¤ºä¾‹ï¼š
```
[picker] ğŸ‘† ç”¨æˆ·ç‚¹å‡»å¿«æ·æŒ‰é’®: ä¸‹åˆ
  { ç›®æ ‡æ—¥æœŸ: '2025-11-06', æ—¶é—´èŒƒå›´: '12:00 - 18:00' }

[picker] ğŸ¯ UnifiedDateTimePicker ç‚¹å‡»ç¡®å®š
  { 
    é€‰æ‹©çš„æ—¥æœŸ: { start: '2025-11-06', end: '2025-11-06' },
    é€‰æ‹©çš„æ—¶é—´: { startTime: {hour: 12, minute: 0}, endTime: {hour: 18, minute: 0} },
    å¿«æ·æŒ‰é’®: 'afternoon',
    è®¡ç®—åçš„DateTime: { start: '2025-11-06 12:00', end: '2025-11-06 18:00' }
  }

[picker] ğŸ“ å‡†å¤‡å†™å…¥ TimeHub
  { eventId: 'event-xxx', startIso: '2025-11-06 12:00', endIso: '2025-11-06 18:00', allDaySelected: false }

[picker] âœ… TimeHub å†™å…¥æˆåŠŸï¼Œå‡†å¤‡è°ƒç”¨ onApplied
  { eventId: 'event-xxx' }
```

---

### 2. **TimeHubï¼ˆæ—¶é—´æ•°æ®ä¸­å¿ƒï¼‰**

#### è®°å½•å†…å®¹ï¼š
- âœ… setEventTime çš„è¾“å…¥å‚æ•°ï¼ˆstart, end, kind, allDay, sourceï¼‰
- âœ… æ ‡å‡†åŒ–åçš„æ—¶é—´å€¼
- âœ… æŒä¹…åŒ–åˆ° EventService çš„æ•°æ®
- âœ… ç¼“å­˜æ›´æ–°çŠ¶æ€
- âœ… è®¢é˜…è€…æ•°é‡
- âœ… timeChanged äº‹ä»¶å¹¿æ’­

#### æ—¥å¿—ç¤ºä¾‹ï¼š
```
[timehub] ğŸ“¥ æ”¶åˆ° setEventTime è°ƒç”¨
  { 
    eventId: 'event-xxx',
    è¾“å…¥start: '2025-11-06T12:00',
    è¾“å…¥end: '2025-11-06T18:00',
    kind: 'range',
    allDay: false,
    source: 'picker'
  }

[timehub] ğŸ”„ æ ‡å‡†åŒ–åçš„æ—¶é—´
  { æ ‡å‡†åŒ–start: '2025-11-06 12:00', æ ‡å‡†åŒ–end: '2025-11-06 18:00' }

[timehub] ğŸ’¾ å‡†å¤‡æŒä¹…åŒ–åˆ° EventService
  { 
    eventId: 'event-xxx',
    æ›´æ–°çš„startTime: '2025-11-06 12:00',
    æ›´æ–°çš„endTime: '2025-11-06 18:00',
    isAllDay: false
  }

[timehub] âœ… æŒä¹…åŒ–æˆåŠŸï¼Œç¼“å­˜å·²æ›´æ–°ï¼Œå‡†å¤‡é€šçŸ¥è®¢é˜…è€…
  { 
    eventId: 'event-xxx',
    å¿«ç…§start: '2025-11-06 12:00',
    å¿«ç…§end: '2025-11-06 18:00',
    allDay: false,
    è®¢é˜…è€…æ•°é‡: 1
  }

[timehub] ğŸ“¡ å·²å¹¿æ’­ timeChanged äº‹ä»¶
  { eventId: 'event-xxx' }
```

---

### 3. **PlanManagerï¼ˆè®¡åˆ’ç®¡ç†å™¨ UIï¼‰**

#### è®°å½•å†…å®¹ï¼š
- âœ… PlanItemTimeDisplay æ¥æ”¶çš„å¿«ç…§æ•°æ®
- âœ… TimeHub å¿«ç…§ vs PlanItem æœ¬åœ°æ—¶é—´
- âœ… æœ€ç»ˆæ¸²æŸ“åˆ°å³ä¾§çš„æ—¶é—´å€¼
- âœ… onTimeApplied å›è°ƒçš„å‚æ•°å’Œæ‰§è¡Œè·¯å¾„
- âœ… å¯¹åº”çš„ itemId å’Œ eventId

#### æ—¥å¿—ç¤ºä¾‹ï¼š
```
[ui] ğŸ–¼ï¸ PlanItemTimeDisplay å¿«ç…§æ›´æ–°
  {
    itemId: 'plan-xxx',
    eventId: 'event-xxx',
    TimeHubå¿«ç…§start: '2025-11-06 12:00',
    TimeHubå¿«ç…§end: '2025-11-06 18:00',
    TimeHubå¿«ç…§allDay: false,
    itemæœ¬åœ°startTime: null,
    itemæœ¬åœ°endTime: null,
    æœ€ç»ˆæ¸²æŸ“çš„start: '2025-11-06T12:00:00.000Z',
    æœ€ç»ˆæ¸²æŸ“çš„end: '2025-11-06T18:00:00.000Z'
  }

[picker] ğŸ“Œ HeadlessFloatingToolbar.onTimeApplied è¢«è°ƒç”¨ (TimeHubå·²æ›´æ–°)
  {
    startIso: '2025-11-06 12:00',
    endIso: '2025-11-06 18:00',
    focusedLineId: 'plan-xxx',
    å¯¹åº”çš„eventId: 'event-xxx'
  }

[picker] ğŸ’¾ onTimeApplied: ä¿å­˜ item (ä»…éæ—¶é—´å­—æ®µ)
  { itemId: 'plan-xxx', eventId: 'event-xxx', isDescriptionMode: false, å†…å®¹é•¿åº¦: 120 }

[picker] âœ… Event æ›´æ–°æˆåŠŸ
  { eventId: 'event-xxx' }
```

---

### 4. **EventServiceï¼ˆäº‹ä»¶æŒä¹…åŒ–æœåŠ¡ï¼‰**

#### è®°å½•å†…å®¹ï¼š
- âœ… åˆ›å»º/æ›´æ–° Event çš„å‚æ•°
- âœ… æ›´æ–°çš„å­—æ®µåˆ—è¡¨
- âœ… æœ€ç»ˆä¿å­˜çš„æ—¶é—´å€¼
- âœ… äº‹ä»¶æ€»æ•°
- âœ… æˆåŠŸ/å¤±è´¥çŠ¶æ€

#### æ—¥å¿—ç¤ºä¾‹ï¼š
```
[EventService] âœï¸ Updating event: event-xxx

[EventService] ğŸ“‹ æ›´æ–°å­—æ®µ:
  {
    eventId: 'event-xxx',
    æ›´æ–°çš„å­—æ®µ: ['startTime', 'endTime', 'updatedAt'],
    startTime: '2025-11-06 12:00',
    endTime: '2025-11-06 18:00',
    title: 'æµ‹è¯•ä»»åŠ¡',
    isAllDay: false
  }

[EventService] ğŸ’¾ Event updated in localStorage

[EventService] âœ… æ›´æ–°æˆåŠŸ:
  {
    eventId: 'event-xxx',
    title: 'æµ‹è¯•ä»»åŠ¡',
    startTime: '2025-11-06 12:00',
    endTime: '2025-11-06 18:00',
    isAllDay: false
  }
```

---

## ğŸ” å¦‚ä½•ä½¿ç”¨è°ƒè¯•æ—¥å¿—

### æ­¥éª¤ 1: å¯ç”¨è°ƒè¯•æ—¥å¿—

åœ¨æµè§ˆå™¨æ§åˆ¶å°è¾“å…¥ï¼š

```javascript
localStorage.RE_DEBUG = '1'
```

ç„¶ååˆ·æ–°é¡µé¢ã€‚

### æ­¥éª¤ 2: é‡ç°é—®é¢˜

1. åœ¨è®¡åˆ’é¡¹ä¸­ç‚¹å‡»å³ä¾§æ—¶é—´åŒºåŸŸï¼Œæ‰“å¼€é€‰æ‹©å™¨
2. ç‚¹å‡»å¿«æ·æŒ‰é’®ï¼ˆå¦‚"ä¸‹åˆ"ï¼‰æˆ–æ‰‹åŠ¨é€‰æ‹©æ—¥æœŸæ—¶é—´
3. ç‚¹å‡»"ç¡®å®š"

### æ­¥éª¤ 3: æŸ¥çœ‹å®Œæ•´æ—¥å¿—é“¾è·¯

åœ¨æ§åˆ¶å°ä¸­æŒ‰æ—¶é—´é¡ºåºæŸ¥çœ‹ï¼š

1. **ç”¨æˆ·æ“ä½œæ—¥å¿—**ï¼ˆè“è‰²ï¼‰
   - `[picker] ğŸ‘† ç”¨æˆ·ç‚¹å‡»å¿«æ·æŒ‰é’®`
   - `[picker] ğŸ‘† ç”¨æˆ·ç‚¹å‡»æ—¥å†`

2. **æ•°æ®å†™å…¥æ—¥å¿—**ï¼ˆè“è‰²ï¼‰
   - `[picker] ğŸ¯ ç‚¹å‡»ç¡®å®š`
   - `[picker] ğŸ“ å‡†å¤‡å†™å…¥ TimeHub`
   - `[timehub] ğŸ“¥ æ”¶åˆ° setEventTime è°ƒç”¨`
   - `[timehub] ğŸ”„ æ ‡å‡†åŒ–åçš„æ—¶é—´`
   - `[timehub] ğŸ’¾ å‡†å¤‡æŒä¹…åŒ–`

3. **æŒä¹…åŒ–æ—¥å¿—**
   - `[EventService] âœï¸ Updating event`
   - `[EventService] âœ… æ›´æ–°æˆåŠŸ`

4. **UI æ›´æ–°æ—¥å¿—**ï¼ˆè“è‰²ï¼‰
   - `[timehub] âœ… æŒä¹…åŒ–æˆåŠŸï¼Œå‡†å¤‡é€šçŸ¥è®¢é˜…è€…`
   - `[timehub] ğŸ“¡ å·²å¹¿æ’­ timeChanged äº‹ä»¶`
   - `[ui] ğŸ–¼ï¸ PlanItemTimeDisplay å¿«ç…§æ›´æ–°`

5. **å›è°ƒæ‰§è¡Œæ—¥å¿—**ï¼ˆè“è‰²ï¼‰
   - `[picker] ğŸ“Œ HeadlessFloatingToolbar.onTimeApplied è¢«è°ƒç”¨`
   - `[picker] ğŸ’¾ onTimeApplied: ä¿å­˜ item`
   - `[picker] âœ… Event æ›´æ–°æˆåŠŸ`

---

## âš ï¸ å¸¸è§é—®é¢˜è¯Šæ–­

### é—®é¢˜ 1: ç‚¹å‡»"ä¸‹åˆ"åå‡ºç° ğŸ“… mention

**æŸ¥çœ‹æ—¥å¿—ä¸­æ˜¯å¦æœ‰ï¼š**
```
[picker] âš ï¸ onDateRangeSelect è¢«è°ƒç”¨ (æ—§çš„éTimeHubè·¯å¾„!)
```

**åŸå› ï¼š** èµ°äº†é”™è¯¯çš„ä»£ç è·¯å¾„ï¼ˆlegacy è·¯å¾„ï¼‰ï¼Œåº”è¯¥èµ° TimeHub è·¯å¾„ã€‚

**æ£€æŸ¥ï¼š**
- eventId æ˜¯å¦ä¸º undefinedï¼Ÿ
- useTimeHub æ˜¯å¦ä¸º trueï¼Ÿ

---

### é—®é¢˜ 2: å³ä¾§æ—¶é—´æ˜¾ç¤ºä¸º 12:00â†’12:00ï¼ˆåº”è¯¥æ˜¯ 12:00â†’18:00ï¼‰

**æŸ¥çœ‹æ—¥å¿—é“¾è·¯ï¼š**
1. Picker æäº¤çš„æ•°æ®ï¼š
   ```
   [picker] ğŸ“ å‡†å¤‡å†™å…¥ TimeHub
     { endIso: '2025-11-06 18:00' }  â† æ£€æŸ¥è¿™é‡Œæ˜¯å¦æ­£ç¡®
   ```

2. TimeHub æ ‡å‡†åŒ–åçš„æ•°æ®ï¼š
   ```
   [timehub] ğŸ”„ æ ‡å‡†åŒ–åçš„æ—¶é—´
     { æ ‡å‡†åŒ–end: '2025-11-06 18:00' }  â† æ£€æŸ¥è¿™é‡Œæ˜¯å¦æ­£ç¡®
   ```

3. EventService æŒä¹…åŒ–çš„æ•°æ®ï¼š
   ```
   [EventService] âœ… æ›´æ–°æˆåŠŸ:
     { endTime: '2025-11-06 18:00' }  â† æ£€æŸ¥è¿™é‡Œæ˜¯å¦æ­£ç¡®
   ```

4. UI æ¸²æŸ“çš„æ•°æ®ï¼š
   ```
   [ui] ğŸ–¼ï¸ PlanItemTimeDisplay å¿«ç…§æ›´æ–°
     { æœ€ç»ˆæ¸²æŸ“çš„end: '2025-11-06T18:00:00.000Z' }  â† æ£€æŸ¥è¿™é‡Œæ˜¯å¦æ­£ç¡®
   ```

---

### é—®é¢˜ 3: ç‚¹å‡»ç¡®å®šåå³ä¾§æ—¶é—´æ²¡æœ‰æ›´æ–°

**æ£€æŸ¥è®¢é˜…è€…é€šçŸ¥ï¼š**
```
[timehub] âœ… æŒä¹…åŒ–æˆåŠŸï¼Œå‡†å¤‡é€šçŸ¥è®¢é˜…è€…
  { è®¢é˜…è€…æ•°é‡: 0 }  â† å¦‚æœæ˜¯ 0ï¼Œè¯´æ˜æ²¡æœ‰è®¢é˜…è€…
```

**åŸå› ï¼š** PlanItemTimeDisplay æ²¡æœ‰è®¢é˜… TimeHubã€‚

**æ£€æŸ¥ï¼š** itemId å’Œ eventId æ˜¯å¦æ­£ç¡®å…³è”ï¼Ÿ

---

## ğŸ“Š æ—¥å¿—åˆ†ç±»

| åˆ†ç±» | æ ‡ç­¾ | é¢œè‰² | ç”¨é€” |
|------|------|------|------|
| ç”¨æˆ·æ“ä½œ | `[picker]` | è“è‰² | è¿½è¸ªç”¨æˆ·ç‚¹å‡»äº†ä»€ä¹ˆ |
| æ•°æ®æµè½¬ | `[timehub]` | è“è‰² | è¿½è¸ª TimeHub çš„æ•°æ®å¤„ç† |
| UI æ›´æ–° | `[ui]` | è“è‰² | è¿½è¸ªç•Œé¢å¦‚ä½•å“åº”æ•°æ®å˜åŒ– |
| æŒä¹…åŒ– | `[EventService]` | é»˜è®¤ | è¿½è¸ª localStorage å­˜å‚¨ |
| è­¦å‘Š | `âš ï¸` | æ©™è‰² | ä¸åº”è¯¥å‡ºç°çš„ä»£ç è·¯å¾„ |
| é”™è¯¯ | `âŒ` | çº¢è‰² | å¤±è´¥/å¼‚å¸¸æƒ…å†µ |

---

## ğŸ¨ æ—¥å¿—æ ¼å¼è¯´æ˜

æ‰€æœ‰è°ƒè¯•æ—¥å¿—åŒ…å«**ä¸­æ–‡æ—¶é—´æˆ³**ï¼Œæ ¼å¼ä¸ºï¼š`[HH:mm:ss.SSS]`

ç¤ºä¾‹ï¼š
```
[14:23:15.123] [picker] ğŸ‘† ç”¨æˆ·ç‚¹å‡»å¿«æ·æŒ‰é’®: ä¸‹åˆ
```

è¿™æ ·ä½ å¯ä»¥ç²¾ç¡®è¿½è¸ªæ¯ä¸ªæ“ä½œçš„æ—¶é—´é¡ºåºã€‚

---

## ğŸš€ ä¸‹ä¸€æ­¥

ç°åœ¨æ—¥å¿—å·²ç»éå¸¸è¯¦ç»†ï¼Œä½ å¯ä»¥ï¼š

1. å¯ç”¨ `localStorage.RE_DEBUG = '1'`
2. é‡ç°é—®é¢˜
3. å¤åˆ¶æ§åˆ¶å°æ—¥å¿—
4. åˆ†æå®Œæ•´çš„æ•°æ®æµ

å¦‚æœä»æœ‰é—®é¢˜ï¼Œè¯·æä¾›å®Œæ•´çš„æ§åˆ¶å°æ—¥å¿—ï¼Œæˆ‘å¯ä»¥å¸®ä½ è¯Šæ–­ï¼
