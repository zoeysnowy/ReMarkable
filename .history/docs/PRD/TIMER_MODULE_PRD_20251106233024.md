# ReMarkable Timer æ¨¡å—äº§å“éœ€æ±‚æ–‡æ¡£ (PRD)

> **AI ç”Ÿæˆæ—¶é—´**: 2025-11-05  
> **å…³è”ä»£ç ç‰ˆæœ¬**: master  
> **æ–‡æ¡£ç±»å‹**: åŠŸèƒ½æ¨¡å— PRD  
> **ä¾èµ–æ¨¡å—**: åŒæ­¥æœºåˆ¶, TagService, EventService  
> **å…³è”æ–‡æ¡£**: [åŒæ­¥æœºåˆ¶ PRD](./SYNC_MECHANISM_PRD.md)

---

## âš ï¸ æ—¶é—´å­—æ®µè§„èŒƒ

**ä¸¥ç¦ä½¿ç”¨ ISO 8601 æ ‡å‡†æ—¶é—´æ ¼å¼ï¼ˆå¸¦ Z æˆ–æ—¶åŒºåç§»ï¼‰ï¼**

æ‰€æœ‰æ—¶é—´å­—æ®µå¿…é¡»ä½¿ç”¨ `timeUtils.ts` ä¸­çš„å·¥å…·å‡½æ•°å¤„ç†ï¼š
- âœ… **å­˜å‚¨æ—¶é—´**: ä½¿ç”¨ `formatTimeForStorage(date)` - è¿”å›æœ¬åœ°æ—¶é—´å­—ç¬¦ä¸²ï¼ˆå¦‚ `2025-11-06T14:30:00`ï¼‰
- âœ… **è§£ææ—¶é—´**: ä½¿ç”¨ `parseLocalTimeString(timeString)` - å°†å­—ç¬¦ä¸²è§£æä¸º Date å¯¹è±¡
- âŒ **ç¦æ­¢**: ç›´æ¥ä½¿ç”¨ `new Date().toISOString()` æˆ– `date.toISOString()`
- âŒ **ç¦æ­¢**: æ—¶é—´å­—ç¬¦ä¸²åŒ…å« `Z` åç¼€æˆ– `+08:00` ç­‰æ—¶åŒºæ ‡è®°

**åŸå› **: ISO æ ¼å¼ä¼šå¯¼è‡´æ—¶åŒºè½¬æ¢é—®é¢˜ï¼Œ18:06 çš„äº‹ä»¶å¯èƒ½åœ¨åŒæ­¥åæ˜¾ç¤ºä¸º 10:06ï¼ˆUTC æ—¶é—´ï¼‰ã€‚

**å‚è€ƒæ–‡ä»¶**: `src/utils/timeUtils.ts`

---

## ğŸ“‹ ç›®å½•

1. [æ¨¡å—æ¦‚è¿°](#1-æ¨¡å—æ¦‚è¿°)
2. [ç”¨æˆ·åœºæ™¯](#2-ç”¨æˆ·åœºæ™¯)
3. [åŠŸèƒ½æ¶æ„](#3-åŠŸèƒ½æ¶æ„)
4. [çŠ¶æ€ç®¡ç†](#4-çŠ¶æ€ç®¡ç†)
5. [ç”Ÿå‘½å‘¨æœŸ](#5-ç”Ÿå‘½å‘¨æœŸ)
6. [UI äº¤äº’](#6-ui-äº¤äº’)
7. [åŒæ­¥é›†æˆ](#7-åŒæ­¥é›†æˆ)
8. [æ•°æ®æŒä¹…åŒ–](#8-æ•°æ®æŒä¹…åŒ–)

---

## 1. æ¨¡å—æ¦‚è¿°

### 1.1 æ ¸å¿ƒç›®æ ‡

Timer æ¨¡å—æ˜¯ ReMarkable çš„æ ¸å¿ƒåŠŸèƒ½ä¹‹ä¸€ï¼Œä¸ºç”¨æˆ·æä¾›**è‡ªä¸»æ—¶é—´è®°å½•**èƒ½åŠ›ï¼š
- âœ… å¸®åŠ©ç”¨æˆ·è¿½è¸ªä»»åŠ¡çš„å®é™…è€—æ—¶ï¼Œ**ä¸æ‰“æ–­å¿ƒæµçŠ¶æ€**
- âœ… è‡ªåŠ¨åˆ›å»ºæ—¶é—´äº‹ä»¶ï¼Œæ— éœ€æ‰‹åŠ¨è®°å½•
- âœ… æ”¯æŒæš‚åœ/æ¢å¤/å–æ¶ˆï¼Œçµæ´»åº”å¯¹å·¥ä½œä¸­æ–­
- âœ… ä¸æ ‡ç­¾ç³»ç»Ÿæ·±åº¦é›†æˆï¼Œå®ç°åˆ†ç±»è®¡æ—¶
- âœ… **æ— å®šæ—¶æé†’ã€æ— å¼ºåˆ¶ä¼‘æ¯**ï¼Œç”¨æˆ·å®Œå…¨è‡ªä¸»å†³å®šè®¡æ—¶èŠ‚å¥
- âœ… **æ—¶é—´å³ç´¢å¼•ï¼Œäº‹ä»¶å³å®¹å™¨**ï¼šæ”¯æŒåœ¨è®¡æ—¶äº‹ä»¶ä¸­è®°å½•è¯¦ç»†æ—¥å¿—ã€ä¼šè®®çºªè¦ã€èµ„æ–™æ”¶é›†ç­‰

### 1.2 æ ¸å¿ƒä»·å€¼

| ç”¨æˆ·ä»·å€¼ | å®ç°æ–¹å¼ | ä¸šåŠ¡ä»·å€¼ |
|---------|---------|---------|
| **æ— æ„Ÿè®°å½•** | è‡ªåŠ¨ä¿å­˜ä¸ºæ—¥å†äº‹ä»¶ | æå‡æ•°æ®å®Œæ•´æ€§ |
| **è‡ªä¸»æŒæ§** | ç”¨æˆ·å®Œå…¨æ§åˆ¶å¼€å§‹/åœæ­¢æ—¶æœºï¼Œæ— æé†’æ‰“æ–­ | å°Šé‡å¿ƒæµçŠ¶æ€ |
| **çµæ´»è°ƒæ•´** | æ”¯æŒä¿®æ”¹å¼€å§‹æ—¶é—´ã€æ ‡é¢˜ã€æ ‡ç­¾ | é€‚åº”çœŸå®å·¥ä½œåœºæ™¯ |
| **æŒä¹…åŒ–** | localStorage + Widget è¯»å– | è·¨çª—å£çŠ¶æ€åŒæ­¥ |
| **å¯è§†åŒ–** | å®æ—¶æ—¶é•¿æ˜¾ç¤º + è„‰å†²åŠ¨æ•ˆ | è½»é‡çº§åé¦ˆï¼Œä¸å¹²æ‰°ä¸“æ³¨ |
| **æ—¥å¿—å®¹å™¨** | äº‹ä»¶ description å­—æ®µæ‰¿è½½ä¼šè®®çºªè¦ã€èµ„æ–™æ”¶é›†ç­‰å†…å®¹ | æ—¶é—´è½´å³ä¿¡æ¯æ£€ç´¢å…¥å£ |
| **è·¨å¹³å°åŒæ­¥** | description å†…å®¹åŒæ­¥åˆ° Outlook | ä¿¡æ¯ä¸å—è®¾å¤‡é™åˆ¶ |

### 1.3 è®¾è®¡ç†å¿µ

**"å¼€å§‹å³åˆ›å»ºï¼Œåœæ­¢å³åŒæ­¥"**

```mermaid
graph LR
    A[ç”¨æˆ·ç‚¹å‡»å¼€å§‹] --> B[åˆ›å»º local-only äº‹ä»¶]
    B --> C[æ¯ 30 ç§’ä¿å­˜è¿›åº¦]
    C --> D{ç”¨æˆ·æ“ä½œ?}
    D -->|åœæ­¢| E[è½¬ä¸º pending çŠ¶æ€]
    D -->|å–æ¶ˆ| F[åˆ é™¤äº‹ä»¶]
    D -->|ç»§ç»­è®¡æ—¶| C
    E --> G[5ç§’ååŒæ­¥åˆ° Outlook]
    F --> H[ä¸åŒæ­¥]
```

---

## 2. ç”¨æˆ·åœºæ™¯

### 2.1 å…¸å‹ç”¨æˆ·æ•…äº‹

#### æ•…äº‹ 1: è‡ªä¸»ä¸“æ³¨è®¡æ—¶

> **ä½œä¸º** éœ€è¦è®°å½•å·¥ä½œæ—¶é—´çš„çŸ¥è¯†å·¥ä½œè€…  
> **æˆ‘å¸Œæœ›** èƒ½å¤Ÿè‡ªç”±åœ°å¼€å§‹å’Œç»“æŸè®¡æ—¶  
> **ä»¥ä¾¿** è¿½è¸ªæˆ‘çš„å®é™…ä¸“æ³¨æ—¶é•¿ï¼Œå¹¶åœ¨æ—¥å†ä¸­å›é¡¾æˆ‘çš„æ—¶é—´åˆ†å¸ƒ

**æµç¨‹**:
1. æ‰“å¼€ ReMarkable é¦–é¡µ
2. ç‚¹å‡» TimerCard çš„"å¼€å§‹"æŒ‰é’®
3. é€‰æ‹©æ ‡ç­¾"#å·¥ä½œ/#äº§å“è®¾è®¡"
4. è¾“å…¥ä»»åŠ¡æ ‡é¢˜"è®¾è®¡ç”¨æˆ·æµç¨‹å›¾"
5. å¼€å§‹è®¡æ—¶ï¼Œè¿›å…¥å¿ƒæµçŠ¶æ€
6. å½“ä»»åŠ¡å®Œæˆæˆ–éœ€è¦ä¼‘æ¯æ—¶ï¼Œç‚¹å‡»"åœæ­¢"
7. è‡ªåŠ¨åˆ›å»ºæ—¥å†äº‹ä»¶ï¼ŒåŒæ­¥åˆ° Outlook

**è®¾è®¡ç†å¿µ**: 
- âœ… **ä¸æ‰“æ–­ç”¨æˆ·**: æ²¡æœ‰ä»»ä½•å®šæ—¶æé†’æˆ–å¼ºåˆ¶ä¼‘æ¯é€šçŸ¥
- âœ… **å°Šé‡å¿ƒæµ**: è®©ç”¨æˆ·è‡ªå·±å†³å®šä½•æ—¶å¼€å§‹ã€ä½•æ—¶åœæ­¢
- âœ… **æ— æ„Ÿè®°å½•**: ä¸“æ³¨æ—¶ä¸éœ€è¦å…³æ³¨æ—¶é—´ï¼Œåœæ­¢æ—¶è‡ªåŠ¨ç”Ÿæˆå®Œæ•´è®°å½•

#### æ•…äº‹ 2: éœ€è¦ä¸­æ–­çš„ä»»åŠ¡

> **ä½œä¸º** éœ€è¦å¤„ç†ä¸´æ—¶äº‹åŠ¡çš„å·¥ä½œè€…  
> **æˆ‘å¸Œæœ›** èƒ½å¤Ÿæš‚åœ/æ¢å¤è®¡æ—¶  
> **ä»¥ä¾¿** å‡†ç¡®è®°å½•å®é™…ä¸“æ³¨æ—¶é•¿ï¼Œæ’é™¤ä¸­æ–­æ—¶é—´

**æµç¨‹**:
1. å¼€å§‹è®¡æ—¶"#å¼€å‘/#Bugä¿®å¤"
2. 10 åˆ†é’Ÿåæ”¶åˆ°ä¼šè®®é€šçŸ¥æˆ–éœ€è¦å¤„ç†ä¸´æ—¶ä»»åŠ¡
3. ç‚¹å‡»"æš‚åœ"ï¼Œç¦»å¼€å½“å‰ä»»åŠ¡
4. å¤„ç†å®Œä¸´æ—¶äº‹åŠ¡åï¼Œç‚¹å‡»"ç»§ç»­"
5. å†å·¥ä½œ 15 åˆ†é’Ÿåï¼Œæ„Ÿè§‰ä»»åŠ¡å‘Šä¸€æ®µè½ï¼Œç‚¹å‡»"åœæ­¢"
6. æœ€ç»ˆäº‹ä»¶æ˜¾ç¤º"ä¸“æ³¨ 25 åˆ†é’Ÿ"ï¼ˆè‡ªåŠ¨æ’é™¤äº†ä¸­æ–­æ—¶é—´ï¼‰

**è®¾è®¡ç†å¿µ**: 
- âœ… **çœŸå®åæ˜ ä¸“æ³¨æ—¶é•¿**: åªè®°å½•ç”¨æˆ·å®é™…å·¥ä½œçš„æ—¶é—´
- âœ… **æ— å¿ƒç†è´Ÿæ‹…**: æš‚åœ/ç»§ç»­éšæ—¶å¯ç”¨ï¼Œä¸ä¼šå½±å“è®°å½•å®Œæ•´æ€§

#### æ•…äº‹ 3: éœ€è¦è°ƒæ•´å¼€å§‹æ—¶é—´

> **ä½œä¸º** æ²‰æµ¸åœ¨å·¥ä½œä¸­å¿˜è®°å¼€å¯è®¡æ—¶çš„ç”¨æˆ·  
> **æˆ‘å¸Œæœ›** èƒ½å¤Ÿå›æº¯å¼€å§‹æ—¶é—´  
> **ä»¥ä¾¿** å‡†ç¡®è®°å½•çœŸå®çš„ä»»åŠ¡æ—¶é•¿

**æµç¨‹**:
1. 9:00 å¼€å§‹å·¥ä½œï¼Œå®Œå…¨æ²‰æµ¸åœ¨ä»»åŠ¡ä¸­ï¼Œå¿˜è®°å¼€ Timer
2. 9:30 æƒ³èµ·æ¥è¦è®°å½•æ—¶é—´ï¼Œç‚¹å‡»"å¼€å§‹"
3. ç‚¹å‡»"å¼€å§‹æ—¶é—´ 09:30"ï¼Œå¼¹å‡ºç¼–è¾‘æ¡†
4. ä¿®æ”¹ä¸º 9:00ï¼ˆå›æº¯çœŸå®å¼€å§‹æ—¶é—´ï¼‰
5. Timer æ˜¾ç¤ºå·²ç»è¿è¡Œ 30 åˆ†é’Ÿ
6. ç»§ç»­å·¥ä½œç›´åˆ°ä»»åŠ¡å®Œæˆ...

**è®¾è®¡ç†å¿µ**: 
- âœ… **å¼¥è¡¥é—å¿˜**: æ²‰æµ¸å·¥ä½œæ—¶å¿˜è®°å¼€ Timer æ˜¯æ­£å¸¸çš„ï¼Œå…è®¸äº‹åè¡¥æ•‘
- âœ… **æ•°æ®å‡†ç¡®**: å›æº¯åŠŸèƒ½ç¡®ä¿æ—¶é—´è®°å½•åæ˜ çœŸå®æƒ…å†µ
- âœ… **æ— æƒ©ç½šæœºåˆ¶**: å¿˜è®°å¼€ Timer ä¸ä¼šæŸå¤±ä»»ä½•æ•°æ®

#### æ•…äº‹ 4: éšæ‰‹è®°å½•æ—¥å¿—

> **ä½œä¸º** éœ€è¦è®°å½•ä¼šè®®çºªè¦ã€èµ„æ–™æ”¶é›†ç­‰ç¢ç‰‡ä¿¡æ¯çš„ç”¨æˆ·  
> **æˆ‘å¸Œæœ›** èƒ½å¤Ÿåœ¨è®¡æ—¶çš„åŒæ—¶è®°å½•è¯¦ç»†å†…å®¹  
> **ä»¥ä¾¿** æ‰€æœ‰ä¿¡æ¯éƒ½æŒ‰æ—¶é—´è‡ªåŠ¨å½’æ¡£ï¼Œæ— éœ€é¢å¤–æ€è€ƒ"è®°åœ¨å“ªé‡Œ"

**åœºæ™¯ A - ä¼šè®®çºªè¦è®°å½•**:
1. æ—¥å†ä¸­å·²æœ‰ä¸‹åˆ 2:00 çš„"äº§å“è¯„å®¡ä¼šè®®"äº‹ä»¶
2. ä¼šè®®å¼€å§‹æ—¶ï¼Œæ‰“å¼€ TimeCalendar çš„è¯¥äº‹ä»¶
3. ç‚¹å‡»ç¼–è¾‘ï¼Œåœ¨ description å­—æ®µç›´æ¥è¾“å…¥ä¼šè®®çºªè¦ï¼š
   ```
   å‚ä¼šäººå‘˜ï¼šå¼ ä¸‰ã€æå››ã€ç‹äº”
   è®¨è®ºè¦ç‚¹ï¼š
   1. æ–°åŠŸèƒ½ A çš„æŠ€æœ¯æ–¹æ¡ˆç¡®è®¤
   2. UI è®¾è®¡ç¨¿ç¬¬äºŒç‰ˆåé¦ˆ
   3. ä¸‹å‘¨å‘å¸ƒæ—¶é—´è¡¨
   
   å¾…åŠäº‹é¡¹ï¼š
   - @å¼ ä¸‰ å®ŒæˆæŠ€æœ¯æ–‡æ¡£
   - @æå›› ä¿®æ”¹è®¾è®¡ç¨¿
   ```
4. ä¿å­˜åè‡ªåŠ¨åŒæ­¥åˆ° Outlook
5. **ä»·å€¼ä½“ç°**: 
   - âœ… å†ä¹Ÿä¸éœ€è¦å›å¿†"æŸä¸ªä¼šè®®åœ¨ä»€ä¹ˆæ—¶é—´å¼€"
   - âœ… ä¼šè®®çºªè¦ä¸ä¼šæ•£è½åœ¨ä¸åŒçš„ç¬”è®°æœ¬ä¸­
   - âœ… æ—¶é—´ã€åœ°ç‚¹ã€äººç‰©å·²ç»åœ¨æ—¥ç¨‹ä¸­ï¼Œçºªè¦åªéœ€è®°å½•å†…å®¹æœ¬èº«

**åœºæ™¯ B - èµ„æ–™æ”¶é›†å½’æ¡£**:
1. å‘¨äºŒä¸Šåˆ 10:00 å¼€å§‹æœé›†ç«å“åˆ†æèµ„æ–™
2. ç‚¹å‡» Timer å¼€å§‹è®¡æ—¶"#å·¥ä½œ/#ç«å“åˆ†æ"
3. è¾¹æœç´¢è¾¹åœ¨ description ä¸­ç²˜è´´ï¼š
   ```
   ç«å“ Aï¼šhttps://example.com/product-a
   - æ ¸å¿ƒåŠŸèƒ½ï¼šXXX
   - å®šä»·ç­–ç•¥ï¼š$99/æœˆ
   - ç”¨æˆ·è¯„ä»·ï¼š4.5æ˜Ÿ
   
   ç«å“ Bï¼šhttps://example.com/product-b
   - æ ¸å¿ƒåŠŸèƒ½ï¼šYYY
   - æˆªå›¾ï¼š[å›¾ç‰‡é“¾æ¥]
   ```
4. æœé›†å®Œæˆååœæ­¢ Timer
5. **ä»·å€¼ä½“ç°**: 
   - âœ… ä¸éœ€è¦æ€è€ƒ"è¿™äº›èµ„æ–™è®°åœ¨å“ªä¸ªç¬”è®°ä¸Š"
   - âœ… é€šè¿‡æ—¶é—´è½´å¿«é€Ÿå®šä½ï¼š"ä¸Šå‘¨äºŒæˆ‘æœäº†ä»€ä¹ˆèµ„æ–™"
   - âœ… èµ„æ–™ä¸è®¡æ—¶è‡ªåŠ¨å…³è”ï¼Œæ¸…æ™°è®°å½•ä»»åŠ¡æŠ•å…¥æ—¶é•¿

**åœºæ™¯ C - å®æ—¶æƒ³æ³•æ•æ‰**:
1. Timer æ­£åœ¨è¿è¡Œ"#å†™ä½œ/#åšå®¢æ–‡ç« "
2. å†™ä½œè¿‡ç¨‹ä¸­çªç„¶æœ‰çµæ„Ÿæˆ–éœ€è¦è®°å½•çš„æƒ³æ³•
3. ä¸åœæ­¢ Timerï¼Œç›´æ¥ç‚¹å‡»ç¼–è¾‘æŒ‰é’®
4. åœ¨ description ä¸­è¿½åŠ å†…å®¹ï¼š
   ```
   11:30 - æƒ³åˆ°ä¸€ä¸ªæ›´å¥½çš„å¼€å¤´
   11:45 - éœ€è¦è¡¥å……çš„æ•°æ®æ¥æºï¼š[é“¾æ¥]
   12:00 - æ–‡ç« ç»“æ„è°ƒæ•´ï¼šå…ˆè®²æ¡ˆä¾‹å†è®²åŸç†
   ```
5. ç»§ç»­è®¡æ—¶ï¼Œæ‰€æœ‰æƒ³æ³•éƒ½å®æ—¶è¿½åŠ åˆ°åŒä¸€ä¸ªäº‹ä»¶ä¸­

**è®¾è®¡ç†å¿µ**: 
- âœ… **æ—¶é—´å³ç´¢å¼•**: ç”¨æˆ·ä¸éœ€è¦æ€è€ƒ"è®°åœ¨å“ªé‡Œ"ï¼Œæ—¶é—´è½´å°±æ˜¯å¤©ç„¶çš„ç´¢å¼•
- âœ… **äº‹ä»¶å³å®¹å™¨**: æ¯ä¸ªäº‹ä»¶éƒ½æ˜¯ä¸€ä¸ªä¿¡æ¯å®¹å™¨ï¼Œæ‰¿è½½æ—¶é•¿ã€æ ‡ç­¾ã€å†…å®¹ã€é™„ä»¶
- âœ… **æ— ç¼åŒæ­¥**: description å†…å®¹è‡ªåŠ¨åŒæ­¥åˆ° Outlookï¼Œè·¨è®¾å¤‡å¯è®¿é—®
- âœ… **æœªæ¥æ‰©å±•**: å½“å‰æ”¯æŒçº¯æ–‡æœ¬ï¼Œæœªæ¥å‡çº§ä¸ºå¯Œæ–‡æœ¬"æ—¥å¿—"ï¼š
  - æ”¯æŒ Markdown æ ¼å¼
  - æ”¯æŒå›¾ç‰‡ã€é™„ä»¶ä¸Šä¼ 
  - æ”¯æŒè¯­éŸ³è®°å½•
  - ä¸ Outlook description å­—æ®µçš„å¯Œæ–‡æœ¬äº’é€šï¼ˆéœ€è€ƒè™‘æ ¼å¼å…¼å®¹æ€§ï¼‰

**æŠ€æœ¯æŒ‘æˆ˜** (æœªæ¥è€ƒè™‘):
- ğŸ“ **å¯Œæ–‡æœ¬åŒæ­¥**: Outlook çš„ description å­—æ®µæ”¯æŒ HTMLï¼Œä½†éœ€è¦å¤„ç†ï¼š
  - æœ¬åœ°å¯Œæ–‡æœ¬ â†’ HTML çš„è½¬æ¢
  - å›¾ç‰‡/é™„ä»¶çš„äº‘ç«¯å­˜å‚¨ä¸å¼•ç”¨
  - ä¸åŒå®¢æˆ·ç«¯ï¼ˆOutlook Web/Desktop/Mobileï¼‰çš„æ˜¾ç¤ºä¸€è‡´æ€§
- ğŸ“ **å¤§æ–‡æœ¬æ€§èƒ½**: description å¯èƒ½åŒ…å«å¤§é‡å†…å®¹ï¼Œéœ€è¦ä¼˜åŒ–ï¼š
  - åˆ†é¡µåŠ è½½æˆ–æ‡’åŠ è½½
  - æœç´¢æ€§èƒ½ä¼˜åŒ–
  - åŒæ­¥æ—¶çš„å·®å¼‚æ£€æµ‹ï¼ˆé¿å…å…¨é‡ä¸Šä¼ ï¼‰

---

## 3. åŠŸèƒ½æ¶æ„

### 3.1 ç»„ä»¶ç»“æ„

```mermaid
graph TB
    subgraph "UI Layer"
        A[TimerCard.tsx]
        B[EventEditModal.tsx]
    end
    
    subgraph "Logic Layer - App.tsx"
        C[globalTimer State]
        D[handleTimerStart]
        E[handleTimerPause]
        F[handleTimerResume]
        G[handleTimerStop]
        H[handleTimerCancel]
        I[handleTimerEdit]
        J[handleStartTimeChange]
    end
    
    subgraph "Service Layer"
        K[EventService]
        L[TagService]
    end
    
    subgraph "Storage Layer"
        M[localStorage events]
        N[localStorage timer state]
    end
    
    A --> C
    A --> D
    A --> E
    A --> F
    A --> G
    A --> H
    A --> I
    A --> J
    
    B --> I
    
    D --> K
    G --> K
    H --> K
    
    D --> L
    
    K --> M
    C --> N
    
    style C fill:#ff9,stroke:#f66,stroke-width:3px
```

### 3.2 æ–‡ä»¶æ¸…å•

| æ–‡ä»¶è·¯å¾„ | èŒè´£ | ä»£ç è¡Œæ•° |
|---------|------|---------|
| `src/components/TimerCard.tsx` | Timer UI ç»„ä»¶ | 244 è¡Œ |
| `src/components/EventEditModal.tsx` | äº‹ä»¶ç¼–è¾‘æ¨¡æ€æ¡† | ~800 è¡Œ |
| `src/App.tsx` (Timer éƒ¨åˆ†) | Timer é€»è¾‘æ§åˆ¶ | ~600 è¡Œ |
| `src/services/EventService.ts` | äº‹ä»¶ CRUD å…¥å£ | ~200 è¡Œ |
| `src/services/TagService.ts` | æ ‡ç­¾ç®¡ç†æœåŠ¡ | ~300 è¡Œ |

---

## 4. çŠ¶æ€ç®¡ç†

### 4.1 å¤š Timer æ¶æ„

**æ ¸å¿ƒç†å¿µ**: æ”¯æŒå¤šä¸ªäº‹ä»¶åŒæ—¶è®¡æ—¶ï¼ŒTimer çŠ¶æ€ç‹¬ç«‹äº UI ç»„ä»¶å­˜åœ¨

**æ¶æ„å˜æ›´**:
- âŒ ~~å•ä¸€ `globalTimer` å¯¹è±¡~~
- âœ… **`activeTimers: Map<eventId, TimerState>`** - æ”¯æŒå¤šä¸ª Timer åŒæ—¶è¿è¡Œ
- âœ… Timer ç”Ÿå‘½å‘¨æœŸç‹¬ç«‹äº Modal æ‰“å¼€/å…³é—­
- âœ… ç”¨æˆ·å¯ä»¥ä¸ºä¸åŒäº‹ä»¶åŒæ—¶è®¡æ—¶ï¼Œäº’ä¸å¹²æ‰°

### 4.2 TimerState æ•°æ®ç»“æ„

**ä»£ç ä½ç½®**: `src/App.tsx` L147-161

```typescript
interface TimerState {
  eventId: string;             // å…³è”çš„äº‹ä»¶ IDï¼ˆå”¯ä¸€æ ‡è¯†ï¼‰
  isRunning: boolean;          // æ˜¯å¦æ­£åœ¨è¿è¡Œ
  isPaused: boolean;           // æ˜¯å¦æš‚åœ
  tagId: string;               // å…³è”çš„æ ‡ç­¾ ID
  tagName: string;             // æ ‡ç­¾åç§°
  tagEmoji?: string;           // æ ‡ç­¾ emoji
  tagColor?: string;           // æ ‡ç­¾é¢œè‰²
  startTime: number;           // å½“å‰è®¡æ—¶å‘¨æœŸçš„å¼€å§‹æ—¶é—´æˆ³ï¼ˆç”¨äºè®¡ç®—è¿è¡Œæ—¶é•¿ï¼‰
  originalStartTime: number;   // ç”¨æˆ·è®¾å®šçš„çœŸå®å¼€å§‹æ—¶é—´æˆ³ï¼ˆå¯å›æº¯ä¿®æ”¹ï¼‰
  elapsedTime: number;         // å·²ç´¯ç§¯çš„æ—¶é•¿ï¼ˆæ¯«ç§’ï¼‰ï¼ŒåŒ…å«æš‚åœå‰çš„æ—¶é•¿
  eventEmoji?: string;         // ç”¨æˆ·è‡ªå®šä¹‰äº‹ä»¶ emojiï¼ˆè¦†ç›–æ ‡ç­¾ emojiï¼‰
  eventTitle?: string;         // ç”¨æˆ·è‡ªå®šä¹‰äº‹ä»¶æ ‡é¢˜ï¼ˆè¦†ç›–æ ‡ç­¾åç§°ï¼‰
  segments: TimerSegment[];    // æ—¶é—´ç‰‡æ®µæ•°ç»„
}

interface TimerSegment {
  start: number;               // ç‰‡æ®µå¼€å§‹æ—¶é—´æˆ³
  end: number;                 // ç‰‡æ®µç»“æŸæ—¶é—´æˆ³ï¼ˆæš‚åœ/åœæ­¢æ—¶è®°å½•ï¼‰
  duration: number;            // ç‰‡æ®µæ—¶é•¿ï¼ˆæ¯«ç§’ï¼‰
}
```

**å­˜å‚¨ä½ç½®**: 
- å†…å­˜: `useState<Map<string, TimerState>>(new Map())`
- æŒä¹…åŒ–: `localStorage['remarkable-active-timers']` - å­˜å‚¨ä¸º `{ [eventId]: TimerState }`

### 4.3 çŠ¶æ€è½¬æ¢å›¾

```mermaid
stateDiagram-v2
    [*] --> Idle: åº”ç”¨å¯åŠ¨
    Idle --> Running: ç”¨æˆ·å¯åŠ¨ Timer
    Running --> Paused: ç”¨æˆ·ç‚¹å‡»"æš‚åœ"
    Paused --> Running: ç”¨æˆ·ç‚¹å‡»"ç»§ç»­"
    Running --> Stopped: ç”¨æˆ·ç‚¹å‡»"åœæ­¢"
    Paused --> Stopped: ç”¨æˆ·ç‚¹å‡»"åœæ­¢"
    Running --> Cancelled: ç”¨æˆ·ç‚¹å‡»"å–æ¶ˆ"
    Paused --> Cancelled: ç”¨æˆ·ç‚¹å‡»"å–æ¶ˆ"
    Stopped --> Idle: ä» Map ä¸­ç§»é™¤
    Cancelled --> Idle: ä» Map ä¸­ç§»é™¤
    
    Idle: activeTimers.size = 0
    Running: timer.isRunning=true, timer.isPaused=false
    Paused: timer.isRunning=false, timer.isPaused=true
    Stopped: ä¿å­˜äº‹ä»¶, syncStatus=pending, ç§»é™¤ timer
    Cancelled: åˆ é™¤äº‹ä»¶, skipSync=true, ç§»é™¤ timer
```

**å¤š Timer å¹¶å‘çŠ¶æ€**:
- âœ… å¤šä¸ª Timer å¯ä»¥åŒæ—¶å¤„äº Running çŠ¶æ€
- âœ… æ¯ä¸ª Timer ç‹¬ç«‹ç®¡ç†è‡ªå·±çš„çŠ¶æ€ï¼ˆè¿è¡Œ/æš‚åœ/åœæ­¢ï¼‰
- âœ… Timer çŠ¶æ€ä¸ UI è§£è€¦ï¼ŒModal å…³é—­ä¸å½±å“ Timer è¿è¡Œ
- âœ… `activeTimers.get(eventId)` æŸ¥è¯¢ç‰¹å®š Timer çŠ¶æ€

### 4.4 æ—¶é•¿è®¡ç®—é€»è¾‘

**æ ¸å¿ƒå…¬å¼**: 

```typescript
// è·å–æŒ‡å®šäº‹ä»¶çš„ Timer çŠ¶æ€
const timer = activeTimers.get(eventId);
if (!timer) return 0;

// è¿è¡Œä¸­
if (timer.isRunning && !timer.isPaused) {
  totalElapsed = timer.elapsedTime + (Date.now() - timer.startTime);
}

// æš‚åœæ—¶
if (timer.isPaused) {
  totalElapsed = timer.elapsedTime;
}
```

**å­—æ®µå«ä¹‰**:
- `elapsedTime`: ä¹‹å‰æ‰€æœ‰è®¡æ—¶å‘¨æœŸç´¯ç§¯çš„æ—¶é•¿ï¼ˆåŒ…å«æš‚åœå‰çš„ï¼‰
- `startTime`: å½“å‰è¿™è½®è®¡æ—¶çš„å¼€å§‹æ—¶é—´ï¼ˆæ¯æ¬¡æ¢å¤éƒ½ä¼šé‡ç½®ï¼‰
- `Date.now() - startTime`: å½“å‰è¿™è½®è¿è¡Œçš„æ—¶é•¿

**ç¤ºä¾‹**:

| æ“ä½œ | elapsedTime | startTime | Date.now() | totalElapsed |
|------|------------|-----------|-----------|-------------|
| å¼€å§‹è®¡æ—¶ | 0 | 9:00:00 | 9:10:00 | 10 åˆ†é’Ÿ |
| æš‚åœ | 10 åˆ†é’Ÿ | - | - | 10 åˆ†é’Ÿ |
| ç»§ç»­ | 10 åˆ†é’Ÿ | 9:15:00 | 9:25:00 | 20 åˆ†é’Ÿ |
| å†æ¬¡æš‚åœ | 20 åˆ†é’Ÿ | - | - | 20 åˆ†é’Ÿ |
| ç»§ç»­ | 20 åˆ†é’Ÿ | 9:30:00 | 9:35:00 | 25 åˆ†é’Ÿ |
| åœæ­¢ | 25 åˆ†é’Ÿ | - | - | 25 åˆ†é’Ÿ |

---

## 5. ç”Ÿå‘½å‘¨æœŸ

### 5.1 å¯åŠ¨æµç¨‹ (handleTimerStart)

**ä»£ç ä½ç½®**: `src/App.tsx` L322-345 + L667-736

```mermaid
sequenceDiagram
    participant User as ç”¨æˆ·
    participant UI as TimerCard
    participant Logic as App.tsx
    participant Tag as TagService
    participant ES as EventService
    participant LS as localStorage
    
    User->>UI: ç‚¹å‡»"å¼€å§‹"æŒ‰é’®
    UI->>Logic: è§¦å‘ onStart
    Logic->>Logic: æ‰“å¼€ EventEditModal
    User->>Logic: é€‰æ‹©æ ‡ç­¾ + è¾“å…¥æ ‡é¢˜
    Logic->>Tag: æŸ¥æ‰¾æ ‡ç­¾ä¿¡æ¯
    Tag-->>Logic: è¿”å› tag å¯¹è±¡
    
    Logic->>Logic: åˆ›å»º globalTimer çŠ¶æ€
    Note over Logic: isRunning=true<br/>startTime=Date.now()<br/>elapsedTime=0
    
    Logic->>LS: æŒä¹…åŒ– timer çŠ¶æ€
    
    Logic->>ES: createEvent(timerEvent, skipSync=true)
    Note over ES: syncStatus='local-only'
    ES->>LS: ä¿å­˜äº‹ä»¶åˆ° localStorage
    
    ES-->>Logic: è¿”å›æˆåŠŸ
    Logic-->>UI: æ›´æ–° UI æ˜¾ç¤º
```

**å…³é”®ä»£ç **:

```typescript
// App.tsx L667-736
const handleTimerEditSave = async (updatedEvent) => {
  if (!globalTimer) {
    // æ–°å»º Timer
    const tagId = updatedEvent.tags[0];
    const tag = TagService.getFlatTags().find(t => t.id === tagId);
    
    const timerStartTime = eventStartTime.getTime();
    const realTimerEventId = `timer-${tagId}-${eventStartTime.getTime()}`;
    
    const timerEvent: Event = {
      id: realTimerEventId,
      title: eventTitle,
      startTime: formatTimeForStorage(eventStartTime),
      endTime: formatTimeForStorage(now),
      tags: [tagId],
      tagId: tagId,
      syncStatus: 'local-only', // âœ… å…³é”®ï¼šä¸åŠ å…¥åŒæ­¥é˜Ÿåˆ—
      remarkableSource: true,
      isTimer: true,
      // ...
    };
    
    // skipSync=trueï¼šé¿å…é¢‘ç¹åŒæ­¥è¿è¡Œä¸­çš„äº‹ä»¶
    await EventService.createEvent(timerEvent, true);
    
    // è®¾ç½® globalTimer çŠ¶æ€
    setGlobalTimer({
      isRunning: true,
      tagId: tagId,
      tagName: tag.name,
      startTime: Date.now(),
      originalStartTime: timerStartTime,
      elapsedTime: 0,
      isPaused: false,
      eventId: realTimerEventId
    });
    
    // æŒä¹…åŒ–
    localStorage.setItem('remarkable-global-timer', JSON.stringify(timerState));
  }
};
```

### 5.2 è¿è¡Œä¸­ä¿å­˜æµç¨‹ï¼ˆæ¯ 30 ç§’ï¼‰

**ä»£ç ä½ç½®**: `src/App.tsx` L774-853 (useEffect)

```typescript
useEffect(() => {
  if (!globalTimer || !globalTimer.isRunning || globalTimer.isPaused) {
    return;
  }

  const saveTimerEvent = async () => {
    const now = Date.now();
    const totalElapsed = globalTimer.elapsedTime + (now - globalTimer.startTime);
    const startTime = new Date(globalTimer.originalStartTime || globalTimer.startTime);
    const endTime = new Date(startTime.getTime() + totalElapsed);
    
    const timerEventId = `timer-${globalTimer.tagId}-${startTime.getTime()}`;
    
    // ğŸ”§ [BUG FIX] è¯»å–ç°æœ‰äº‹ä»¶ï¼Œä¿ç•™ç”¨æˆ·çš„ description å’Œ location
    const saved = localStorage.getItem(STORAGE_KEYS.EVENTS);
    const existingEvents: Event[] = saved ? JSON.parse(saved) : [];
    const existingEvent = existingEvents.find(e => e.id === timerEventId);
    
    const timerEvent: Event = {
      id: timerEventId,
      title: eventTitle,
      startTime: formatTimeForStorage(startTime),
      endTime: formatTimeForStorage(endTime),
      description: existingEvent?.description || 'è®¡æ—¶ä¸­çš„äº‹ä»¶', // ğŸ”§ ä¿ç•™ç”¨æˆ·è¾“å…¥
      location: existingEvent?.location || '',
      syncStatus: 'local-only', // âœ… ä»ç„¶æ˜¯ local-only
      // ...
    };
    
    // ğŸ”§ ç›´æ¥æ›´æ–° localStorageï¼Œä¸è°ƒç”¨ EventServiceï¼ˆé¿å…è§¦å‘åŒæ­¥ï¼‰
    const updatedEvents = existingEvents.map(e => 
      e.id === timerEventId ? timerEvent : e
    );
    if (!existingEvents.some(e => e.id === timerEventId)) {
      updatedEvents.push(timerEvent);
    }
    
    localStorage.setItem(STORAGE_KEYS.EVENTS, JSON.stringify(updatedEvents));
    
    // è§¦å‘ UI æ›´æ–°
    window.dispatchEvent(new CustomEvent('eventsUpdated', {
      detail: { isTimerEvent: true }
    }));
  };

  // ç«‹å³ä¿å­˜ä¸€æ¬¡
  saveTimerEvent();
  
  // æ¯ 30 ç§’ä¿å­˜ä¸€æ¬¡
  const interval = setInterval(saveTimerEvent, 30000);
  
  return () => clearInterval(interval);
}, [globalTimer, /* ... */]);
```

**è®¾è®¡è€ƒé‡**:
- âœ… **ä¸è§¦å‘åŒæ­¥**: ç›´æ¥æ“ä½œ localStorageï¼Œé¿å… EventService è§¦å‘ `recordLocalAction`
- âœ… **ä¿ç•™ç”¨æˆ·è¾“å…¥**: ä» localStorage è¯»å–ç°æœ‰äº‹ä»¶çš„ description å’Œ location
  - **å…³é”®**: é…åˆ `handleTimerEditSave` çš„å³æ—¶ä¿å­˜æœºåˆ¶
  - ç”¨æˆ·é€šè¿‡ EventEditModal ç¼–è¾‘ description â†’ `handleTimerEditSave` ç«‹å³å†™å…¥ localStorage
  - 30 ç§’å `saveTimerEvent` è¯»å– â†’ è·å¾—æœ€æ–°çš„ç”¨æˆ·è¾“å…¥ â†’ ä¸è¦†ç›–
  - è¯¦è§ [6.2 EventEditModal é›†æˆ - å·²ä¿®å¤çš„ Bug](#62-eventeditmodal-é›†æˆ)
- âœ… **30ç§’é—´éš”**: å¹³è¡¡æ•°æ®å®‰å…¨å’Œæ€§èƒ½ï¼ˆé¿å…è¿‡äºé¢‘ç¹çš„ I/Oï¼‰
- âœ… **å®æ—¶ endTime æ›´æ–°**: æ¯æ¬¡ä¿å­˜éƒ½é‡æ–°è®¡ç®— `endTime = startTime + totalElapsed`ï¼Œç¡®ä¿æ—¥å†æ˜¾ç¤ºå‡†ç¡®çš„æ—¶é•¿

**æ•°æ®è¦†ç›–ç­–ç•¥**:

```typescript
// ä¿ç•™çš„å­—æ®µï¼ˆä» existingEvent è¯»å–ï¼‰:
- description  // ğŸ”§ ç”¨æˆ·å¯ç¼–è¾‘ï¼Œå¿…é¡»ä¿ç•™
- location     // ğŸ”§ ç”¨æˆ·å¯ç¼–è¾‘ï¼Œå¿…é¡»ä¿ç•™
- createdAt    // é¦–æ¬¡åˆ›å»ºæ—¶é—´ï¼Œä¸å˜

// è¦†ç›–çš„å­—æ®µï¼ˆTimer è‡ªåŠ¨ç®¡ç†ï¼‰:
- title        // ä» globalTimer.eventTitle è·å–ï¼ˆå¯èƒ½è¢«ç”¨æˆ·ä¿®æ”¹è¿‡ï¼‰
- startTime    // ä» globalTimer.originalStartTime è·å–ï¼ˆå›ºå®šï¼‰
- endTime      // å®æ—¶è®¡ç®— = startTime + totalElapsed
- syncStatus   // å§‹ç»ˆä¸º 'local-only'ï¼ˆè¿è¡Œä¸­ä¸åŒæ­¥ï¼‰
- updatedAt    // æ¯æ¬¡ä¿å­˜éƒ½æ›´æ–°ä¸ºå½“å‰æ—¶é—´
```

### 5.3 åœæ­¢æµç¨‹ (handleTimerStop)

**ä»£ç ä½ç½®**: `src/App.tsx` L510-575

```mermaid
sequenceDiagram
    participant User as ç”¨æˆ·
    participant UI as TimerCard
    participant Logic as App.tsx
    participant ES as EventService
    participant SM as SyncManager
    participant LS as localStorage
    
    User->>UI: ç‚¹å‡»"åœæ­¢"æŒ‰é’®
    UI->>Logic: è§¦å‘ onStop
    
    Logic->>Logic: è®¡ç®— totalElapsed
    Logic->>LS: è¯»å–ç°æœ‰äº‹ä»¶
    LS-->>Logic: è¿”å› existingEvent
    
    Logic->>Logic: ç”Ÿæˆè®¡æ—¶ç­¾å [â±ï¸ è®¡æ—¶ X åˆ†é’Ÿ]
    Logic->>Logic: ä¿ç•™ç”¨æˆ· description + è¿½åŠ ç­¾å
    
    Logic->>Logic: æ„é€  finalEvent
    Note over Logic: syncStatus='pending'<br/>ä» local-only æ”¹ä¸º pending
    
    Logic->>ES: updateEvent(timerEventId, finalEvent)
    Note over ES: skipSync=false<br/>è§¦å‘åŒæ­¥
    
    ES->>LS: æ›´æ–°æœ¬åœ°äº‹ä»¶
    ES->>SM: recordLocalAction('update', ...)
    Note over SM: åŠ å…¥åŒæ­¥é˜Ÿåˆ—
    
    ES-->>Logic: è¿”å›æˆåŠŸ
    
    Logic->>Logic: æ¸…ç©º globalTimer
    Logic->>LS: åˆ é™¤ timer çŠ¶æ€
    Logic->>UI: åˆ‡æ¢åˆ°"æ—¶å…‰"é¡µé¢
```

**å…³é”®ä»£ç **:

```typescript
// App.tsx L510-575
const handleTimerStop = async () => {
  const totalElapsed = globalTimer.elapsedTime + 
    (globalTimer.isRunning ? (Date.now() - globalTimer.startTime) : 0);
  
  const startTime = new Date(globalTimer.originalStartTime || globalTimer.startTime);
  const timerEventId = `timer-${globalTimer.tagId}-${startTime.getTime()}`;
  
  // è¯»å–ç°æœ‰äº‹ä»¶
  const existingEvent = existingEvents.find(e => e.id === timerEventId);
  
  // ç”Ÿæˆè®¡æ—¶ç­¾å
  const timerSignature = `[â±ï¸ è®¡æ—¶ ${Math.floor(totalElapsed / 60000)} åˆ†é’Ÿ]`;
  
  // ğŸ”§ æ™ºèƒ½åˆå¹¶ description
  let finalDescription = existingEvent?.description || '';
  if (finalDescription.includes('[â±ï¸ è®¡æ—¶')) {
    // æ›¿æ¢æ—§ç­¾å
    finalDescription = finalDescription.replace(/\[â±ï¸ è®¡æ—¶ \d+ åˆ†é’Ÿ\]/, timerSignature);
  } else if (finalDescription && finalDescription !== 'è®¡æ—¶ä¸­çš„äº‹ä»¶') {
    // è¿½åŠ ç­¾å
    finalDescription = finalDescription + '\n' + timerSignature;
  } else {
    // ä½¿ç”¨ç­¾åä½œä¸ºé»˜è®¤å†…å®¹
    finalDescription = timerSignature;
  }
  
  const finalEvent: Event = {
    id: timerEventId,
    title: globalTimer.eventTitle || tagName,
    description: finalDescription,
    syncStatus: 'pending', // âœ… ä» local-only æ”¹ä¸º pending
    // ...
  };
  
  // ä½¿ç”¨ EventService æ›´æ–°äº‹ä»¶ï¼ˆskipSync=falseï¼‰
  const result = await EventService.updateEvent(timerEventId, finalEvent);
  
  if (result.success) {
    // æ¸…ç©º Timer çŠ¶æ€
    setGlobalTimer(null);
    localStorage.removeItem('remarkable-global-timer');
    
    // è·³è½¬åˆ°æ—¶å…‰é¡µé¢
    setCurrentPage('time');
  }
};
```

**åŒæ­¥æ—¶æœº**: 
- âœ… ç«‹å³åŠ å…¥é˜Ÿåˆ—: `recordLocalAction('update', 'event', ...)`
- âœ… 5 ç§’åé¦–æ¬¡åŒæ­¥ï¼ˆç”± SyncManager çš„å»¶è¿Ÿæœºåˆ¶ä¿è¯ï¼‰
- âœ… åŒæ­¥æˆåŠŸåè·å¾— `externalId`

### 5.4 å–æ¶ˆæµç¨‹ (handleTimerCancel)

**ä»£ç ä½ç½®**: `src/App.tsx` L384-415

```typescript
const handleTimerCancel = () => {
  if (!globalTimer) return;
  
  if (window.confirm('ç¡®å®šè¦å–æ¶ˆè®¡æ—¶å—ï¼Ÿå½“å‰è®¡æ—¶å°†ä¸ä¼šè¢«ä¿å­˜')) {
    const startTime = new Date(globalTimer.originalStartTime || globalTimer.startTime);
    const timerEventId = `timer-${globalTimer.tagId}-${startTime.getTime()}`;
    
    // ä½¿ç”¨ EventService åˆ é™¤äº‹ä»¶ï¼ˆskipSync=trueï¼‰
    EventService.deleteEvent(timerEventId, true).then(result => {
      if (result.success) {
        console.log('âŒ Timer cancelled, event deleted:', timerEventId);
      }
    });
    
    // æ¸…ç©ºçŠ¶æ€
    setGlobalTimer(null);
    localStorage.removeItem('remarkable-global-timer');
  }
};
```

**è®¾è®¡å†³ç­–**: `skipSync=true` ä¸åŒæ­¥åˆ é™¤æ“ä½œï¼Œå› ä¸ºï¼š
1. å–æ¶ˆçš„äº‹ä»¶ä»æœªåŒæ­¥åˆ° Outlookï¼ˆsyncStatus='local-only'ï¼‰
2. å³ä½¿æœ‰ externalIdï¼Œç”¨æˆ·ä¸»åŠ¨å–æ¶ˆæ„å‘³ç€ä¸å¸Œæœ›ä¿ç•™è®°å½•
3. é¿å…äº§ç”Ÿ"åˆ›å»º â†’ ç«‹å³åˆ é™¤"çš„åƒåœ¾æ•°æ®

---

## 6. UI äº¤äº’

### 6.1 TimerCard ç»„ä»¶

**ä»£ç ä½ç½®**: `src/components/TimerCard.tsx`

**Props æ¥å£**:

```typescript
interface TimerCardProps {
  tagId?: string;              // æ ‡ç­¾ ID
  tagName?: string;            // æ ‡ç­¾åç§°
  tagEmoji?: string;           // æ ‡ç­¾ emoji
  tagPath?: string;            // å®Œæ•´æ ‡ç­¾è·¯å¾„ï¼ˆå±‚çº§æ˜¾ç¤ºï¼‰
  tagColor?: string;           // æ ‡ç­¾é¢œè‰²ï¼ˆæœ€åº•å±‚æ ‡ç­¾çš„é¢œè‰²ï¼‰
  startTime?: number;          // å½“å‰è®¡æ—¶å‘¨æœŸå¼€å§‹æ—¶é—´
  originalStartTime?: number;  // çœŸå®å¼€å§‹æ—¶é—´ï¼ˆå¯ä¿®æ”¹ï¼‰
  elapsedTime?: number;        // å·²ç´¯ç§¯æ—¶é•¿
  isRunning?: boolean;         // æ˜¯å¦è¿è¡Œä¸­
  eventEmoji?: string;         // ç”¨æˆ·è‡ªå®šä¹‰ emoji
  eventTitle?: string;         // ç”¨æˆ·è‡ªå®šä¹‰æ ‡é¢˜
  onPause?: () => void;        // æš‚åœå›è°ƒ
  onStop?: () => void;         // åœæ­¢å›è°ƒ
  onCancel?: () => void;       // å–æ¶ˆå›è°ƒ
  onEdit: () => void;          // ç¼–è¾‘å›è°ƒ
  onStart?: () => void;        // å¼€å§‹å›è°ƒ
  onStartTimeChange?: (newStartTime: number) => void; // ä¿®æ”¹å¼€å§‹æ—¶é—´
}
```

**UI å¸ƒå±€**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      [Emoji å›¾æ ‡]       â”‚ â† å¯ç‚¹å‡»ç¼–è¾‘
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚     [äº‹ä»¶æ ‡é¢˜]          â”‚ â† å¯ç‚¹å‡»ç¼–è¾‘
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   [#æ ‡ç­¾/è·¯å¾„/æ˜¾ç¤º]     â”‚ â† å¯ç‚¹å‡»ç¼–è¾‘ï¼Œæ˜¾ç¤ºé¢œè‰²
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [æš‚åœ] [åœæ­¢] [å–æ¶ˆ]   â”‚ â† æŒ‰é’®ç»„ï¼ˆè¿è¡Œæ—¶ï¼‰
â”‚      [å¼€å§‹]             â”‚ â† åˆå§‹çŠ¶æ€
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚       01:25:36          â”‚ â† å®æ—¶æ—¶é•¿ï¼ˆè„‰å†²åŠ¨æ•ˆï¼‰
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  å¼€å§‹æ—¶é—´ 09:30         â”‚ â† å¯ç‚¹å‡»ä¿®æ”¹
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**äº¤äº’ç»†èŠ‚**:

1. **è„‰å†²åŠ¨æ•ˆ**: æ¯åˆ°æ•´åˆ†é’Ÿï¼ˆseconds === 0ï¼‰è§¦å‘ 0.6s è„‰å†²åŠ¨ç”»
   ```typescript
   useEffect(() => {
     if (isRunning && seconds === 0 && minutes > 0) {
       setIsPulsing(true);
       const timeout = setTimeout(() => setIsPulsing(false), 600);
       return () => clearTimeout(timeout);
     }
   }, [seconds, minutes, isRunning]);
   ```

2. **æ—¶é•¿æ ¼å¼åŒ–**:
   - å°äº 1 å°æ—¶: `MM:SS` (å¦‚ `25:36`)
   - å¤§äº 1 å°æ—¶: `HH:MM:SS` (å¦‚ `01:25:36`)
   - å¼‚å¸¸æ•°æ®: æ˜¾ç¤º `--:--` å¹¶æ‰“å°é”™è¯¯æ—¥å¿—

3. **å®‰å…¨æ£€æŸ¥**: é˜²æ­¢å¼‚å¸¸æ•°æ®å¯¼è‡´ UI å´©æºƒ
   ```typescript
   const safeElapsedTime = (elapsedTime && !isNaN(elapsedTime) && elapsedTime >= 0) ? elapsedTime : 0;
   const safeStartTime = (startTime && !isNaN(startTime) && startTime > 0) ? startTime : now;
   ```

### 6.2 EventEditModal é›†æˆ

**æ‰“å¼€æ—¶æœº**: ç‚¹å‡» TimerCard çš„ä»»æ„å¯ç¼–è¾‘åŒºåŸŸ

**ç¼–è¾‘å­—æ®µ**:
- äº‹ä»¶æ ‡é¢˜ (eventTitle)
- Emoji (eventEmoji)
- æ ‡ç­¾é€‰æ‹© (tagId)
- å¼€å§‹æ—¶é—´ (startTime)
- **æè¿° (description)**: 
  - å½“å‰æ”¯æŒçº¯æ–‡æœ¬ï¼ˆå¤šè¡Œ textareaï¼‰
  - å¯åœ¨è®¡æ—¶è¿‡ç¨‹ä¸­éšæ—¶ç¼–è¾‘ï¼Œå®æ—¶ä¿å­˜
  - ç”¨äºè®°å½•ä¼šè®®çºªè¦ã€èµ„æ–™é“¾æ¥ã€æƒ³æ³•æ•æ‰ç­‰
  - è‡ªåŠ¨åŒæ­¥åˆ° Outlook çš„ description å­—æ®µ
  - **æœªæ¥è§„åˆ’**: å‡çº§ä¸ºå¯Œæ–‡æœ¬ç¼–è¾‘å™¨ï¼Œæ”¯æŒ Markdownã€å›¾ç‰‡ã€é™„ä»¶ã€è¯­éŸ³
- åœ°ç‚¹ (location)

**ä¿å­˜é€»è¾‘**: `App.tsx L651-780 handleTimerEditSave`

**å…³é”®ç‰¹æ€§**:
1. **åŒºåˆ†æ–°å»ºä¸ç¼–è¾‘**: é€šè¿‡ `globalTimer` æ˜¯å¦ä¸º null åˆ¤æ–­
2. **ä¿ç•™ç”¨æˆ·è¾“å…¥**: ä» localStorage è¯»å–ç°æœ‰äº‹ä»¶ï¼Œä¿ç•™ description å’Œ location
3. **å®æ—¶åé¦ˆ**: ä¿®æ”¹åç«‹å³æ›´æ–° globalTimer çŠ¶æ€ï¼ŒUI å®æ—¶å“åº”

**ğŸ› å·²ä¿®å¤çš„ Bug**: **Timer è¿è¡Œä¸­ç¼–è¾‘ description è¢«è¦†ç›–**

**é—®é¢˜æè¿°**:
- ç”¨æˆ·åœ¨ Timer è¿è¡Œæ—¶é€šè¿‡ EventEditModal ç¼–è¾‘ description
- ä¿å­˜åï¼Œ`handleTimerEditSave` åªæ›´æ–°äº† `globalTimer` çš„ `eventTitle` å’Œ `eventEmoji`
- **ä½†æ²¡æœ‰å°† description å’Œ location ä¿å­˜åˆ° localStorage ä¸­çš„äº‹ä»¶å¯¹è±¡**
- 30 ç§’å `saveTimerEvent` è‡ªåŠ¨è¿è¡Œï¼Œä» localStorage è¯»å–äº‹ä»¶
- è¯»å–åˆ°çš„ä»ç„¶æ˜¯æ—§çš„ descriptionï¼Œä»è€Œè¦†ç›–äº†ç”¨æˆ·çš„ç¼–è¾‘

**ä¿®å¤æ–¹æ¡ˆ** (`App.tsx` L748-780):

```typescript
// æ›´æ–°ç°æœ‰è®¡æ—¶å™¨ä¸­çš„è‡ªå®šä¹‰å†…å®¹
setGlobalTimer({
  ...globalTimer,
  eventTitle: updatedEvent.title,
  eventEmoji: possibleEmoji,
  // ... æ›´æ–°æ ‡ç­¾ä¿¡æ¯
});

// ğŸ”§ [BUG FIX] ç«‹å³ä¿å­˜ç”¨æˆ·ç¼–è¾‘çš„ description å’Œ location åˆ° localStorage
// è¿™æ · saveTimerEvent æ¯30ç§’è¿è¡Œæ—¶ä¼šè¯»å–åˆ°æœ€æ–°çš„ç”¨æˆ·è¾“å…¥
if (globalTimer.eventId) {
  try {
    const saved = localStorage.getItem(STORAGE_KEYS.EVENTS);
    const existingEvents: Event[] = saved ? JSON.parse(saved) : [];
    const eventIndex = existingEvents.findIndex((e: Event) => e.id === globalTimer.eventId);
    
    if (eventIndex !== -1) {
      // åªæ›´æ–°ç”¨æˆ·å¯ç¼–è¾‘çš„å­—æ®µï¼Œä¿æŒå…¶ä»–å­—æ®µä¸å˜
      existingEvents[eventIndex] = {
        ...existingEvents[eventIndex],
        description: updatedEvent.description,
        location: updatedEvent.location,
        title: updatedEvent.title,
        updatedAt: formatTimeForStorage(new Date())
      };
      
      localStorage.setItem(STORAGE_KEYS.EVENTS, JSON.stringify(existingEvents));
      AppLogger.log('ğŸ’¾ [Timer Edit] Saved user edits to localStorage');
    }
  } catch (error) {
    AppLogger.error('ğŸ’¾ [Timer Edit] Failed to save user edits:', error);
  }
}
```

**æ•°æ®æµå¯¹æ¯”**:

**ä¿®å¤å‰ï¼ˆé”™è¯¯ï¼‰**:
```
ç”¨æˆ·ç¼–è¾‘ description
  â†“
handleTimerEditSave åªæ›´æ–° globalTimer.eventTitle
  â†“
localStorage ä¸­çš„äº‹ä»¶å¯¹è±¡ä»ç„¶æ˜¯æ—§çš„ description
  â†“
30ç§’å saveTimerEvent è¯»å– localStorage
  â†“
è¦†ç›–äº‹ä»¶å¯¹è±¡ï¼ˆåŒ…æ‹¬æ—§çš„ descriptionï¼‰
  â†“
ç”¨æˆ·çš„ç¼–è¾‘ä¸¢å¤± âŒ
```

**ä¿®å¤åï¼ˆæ­£ç¡®ï¼‰**:
```
ç”¨æˆ·ç¼–è¾‘ description
  â†“
handleTimerEditSave æ›´æ–° globalTimer + ç«‹å³ä¿å­˜åˆ° localStorage
  â†“
localStorage ä¸­çš„äº‹ä»¶å¯¹è±¡å·²æ›´æ–°ä¸ºæ–°çš„ description
  â†“
30ç§’å saveTimerEvent è¯»å– localStorage
  â†“
è¯»å–åˆ°æœ€æ–°çš„ descriptionï¼Œä¸è¦†ç›–
  â†“
ç”¨æˆ·çš„ç¼–è¾‘ä¿ç•™ âœ…
```

**è®¾è®¡è¦ç‚¹**:
- âœ… **åŒé‡æ›´æ–°**: æ—¢æ›´æ–° `globalTimer` çŠ¶æ€ï¼ˆUI ç«‹å³å“åº”ï¼‰ï¼Œåˆæ›´æ–° `localStorage`ï¼ˆæ•°æ®æŒä¹…åŒ–ï¼‰
- âœ… **éƒ¨åˆ†æ›´æ–°**: åªæ›´æ–°ç”¨æˆ·ç¼–è¾‘çš„å­—æ®µï¼ˆdescriptionã€locationã€titleï¼‰ï¼Œä¸å½±å“ startTimeã€endTime ç­‰ Timer è‡ªåŠ¨ç®¡ç†çš„å­—æ®µ
- âœ… **é”™è¯¯å®¹å¿**: ä½¿ç”¨ try-catch åŒ…è£¹ï¼Œé¿å… localStorage å¼‚å¸¸å¯¼è‡´ Timer å´©æºƒ

---

## 7. åŒæ­¥é›†æˆ

### 7.1 ä¸åŒæ­¥æœºåˆ¶çš„åä½œ

**æ ¸å¿ƒåŸåˆ™**: **å¼€å§‹å³åˆ›å»ºï¼ˆlocal-onlyï¼‰ï¼Œåœæ­¢å³åŒæ­¥ï¼ˆpendingï¼‰**

| Timer çŠ¶æ€ | äº‹ä»¶ syncStatus | æ˜¯å¦åŒæ­¥ | åŸå›  |
|-----------|----------------|---------|------|
| å¯åŠ¨ | `local-only` | âŒ | é¿å…é¢‘ç¹åŒæ­¥è¿è¡Œä¸­çš„äº‹ä»¶ |
| è¿è¡Œä¸­ä¿å­˜ï¼ˆ30ç§’ï¼‰ | `local-only` | âŒ | åŒä¸Šï¼Œç›´æ¥æ“ä½œ localStorage |
| åœæ­¢ | `pending` | âœ… | æœ€ç»ˆç»“æœéœ€è¦åŒæ­¥åˆ°äº‘ç«¯ |
| å–æ¶ˆ | - | âŒ | ç”¨æˆ·ä¸»åŠ¨å–æ¶ˆï¼Œä¸éœ€è¦åŒæ­¥ |

### 7.2 äº‹ä»¶ ID ç”Ÿæˆè§„åˆ™

**æ ¼å¼**: `timer-{tagId}-{originalStartTime}`

**ç¤ºä¾‹**: `timer-tag-123-1699887600000`

**ä¼˜åŠ¿**:
1. **å…¨å±€å”¯ä¸€**: åŒä¸€æ ‡ç­¾ã€åŒä¸€æ—¶é—´åªä¼šæœ‰ä¸€ä¸ª Timer äº‹ä»¶
2. **å¯è¿½æº¯**: ä» ID å¯ä»¥è§£æå‡ºæ ‡ç­¾å’Œå¼€å§‹æ—¶é—´
3. **IndexMap å‹å¥½**: ä¾¿äºé€šè¿‡ externalId åŒ¹é…

### 7.3 Timer äº‹ä»¶å»é‡é€»è¾‘

**é—®é¢˜**: Timer åœæ­¢ååŒæ­¥åˆ° Outlookï¼Œ20ç§’åè¿œç¨‹åŒæ­¥å›å†™æ—¶ï¼Œå¦‚ä½•é¿å…åˆ›å»ºé‡å¤äº‹ä»¶ï¼Ÿ

**è§£å†³æ–¹æ¡ˆ**: å‚è€ƒ [åŒæ­¥æœºåˆ¶ PRD - 7.4 Timer äº‹ä»¶å»é‡](./SYNC_MECHANISM_PRD.md#74-timer-äº‹ä»¶å»é‡)

**æ ¸å¿ƒæ­¥éª¤**:
1. Timer åœæ­¢ â†’ åŒæ­¥åˆ° Outlook â†’ è·å¾— `externalId` â†’ æ›´æ–°æœ¬åœ°äº‹ä»¶
2. ç«‹å³æ›´æ–° IndexMap: `eventIndexMap.set(externalId, timerEvent)`
3. è¿œç¨‹åŒæ­¥å›å†™æ—¶: é€šè¿‡ `externalId` æ‰¾åˆ° Timer äº‹ä»¶ â†’ æ›´æ–°è€Œä¸æ˜¯åˆ›å»º
4. Timer ä¼˜å…ˆçº§: Timer äº‹ä»¶çš„ `externalId` ç´¢å¼•ä¸ä¼šè¢«å…¶ä»–äº‹ä»¶è¦†ç›–

---

## 8. æ•°æ®æŒä¹…åŒ–

### 8.1 localStorage å­˜å‚¨

**Timer çŠ¶æ€**: `localStorage['remarkable-global-timer']`

```typescript
interface StoredTimerState {
  isRunning: boolean;
  tagId: string;
  tagName: string;
  tagEmoji?: string;
  tagColor?: string;
  startTime: number;
  originalStartTime: number;
  elapsedTime: number;
  isPaused: boolean;
  eventEmoji?: string;
  eventTitle?: string;
  eventId?: string;
}
```

**ç”¨é€”**:
- âœ… é¡µé¢åˆ·æ–°åæ¢å¤ Timer çŠ¶æ€
- âœ… Widget è¯»å–å½“å‰ Timer ä¿¡æ¯
- âœ… å¤šçª—å£çŠ¶æ€åŒæ­¥ï¼ˆé€šè¿‡ storage äº‹ä»¶ï¼‰

**Timer äº‹ä»¶**: `localStorage['events']`

```typescript
{
  id: "timer-tag-123-1699887600000",
  title: "äº§å“è®¾è®¡",
  startTime: "2024-11-13T09:00:00",
  endTime: "2024-11-13T09:25:36",
  tags: ["tag-123"],
  tagId: "tag-123",
  syncStatus: "local-only", // è¿è¡Œä¸­
  isTimer: true,
  remarkableSource: true,
  // ...
}
```

### 8.2 é¡µé¢åˆ·æ–°æ¢å¤

**ä»£ç ä½ç½®**: `src/App.tsx` L854-950

```typescript
useEffect(() => {
  const savedTimer = localStorage.getItem('remarkable-global-timer');
  if (savedTimer) {
    try {
      const timerState = JSON.parse(savedTimer);
      
      // éªŒè¯æ•°æ®æœ‰æ•ˆæ€§
      if (timerState.tagId && timerState.startTime) {
        setGlobalTimer(timerState);
        console.log('ğŸ”„ Restored timer state from localStorage:', timerState);
      }
    } catch (error) {
      console.error('âŒ Failed to restore timer:', error);
      localStorage.removeItem('remarkable-global-timer');
    }
  }
}, []);
```

**å¤„ç†è¾¹ç¼˜æƒ…å†µ**:
- âœ… æ•°æ®æ ¼å¼é”™è¯¯: åˆ é™¤æŸåçš„æ•°æ®ï¼Œé¿å…åº”ç”¨å´©æºƒ
- âœ… æ ‡ç­¾è¢«åˆ é™¤: æ˜¾ç¤º"æœªæ‰¾åˆ°æ ‡ç­¾"ï¼Œå…è®¸ç”¨æˆ·é‡æ–°é€‰æ‹©
- âœ… æ—¶é—´æˆ³å¼‚å¸¸: éªŒè¯ startTime å’Œ originalStartTime çš„æœ‰æ•ˆæ€§

### 8.3 è·¨çª—å£åŒæ­¥ï¼ˆWidget é›†æˆï¼‰

**Widget è¯»å–é€»è¾‘**:

```typescript
// DesktopCalendarWidget.tsx
const [timerState, setTimerState] = useState(() => {
  const saved = localStorage.getItem('remarkable-global-timer');
  return saved ? JSON.parse(saved) : null;
});

// ç›‘å¬ storage å˜åŒ–
useEffect(() => {
  const handleStorageChange = (e: StorageEvent) => {
    if (e.key === 'remarkable-global-timer') {
      setTimerState(e.newValue ? JSON.parse(e.newValue) : null);
    }
  };
  
  window.addEventListener('storage', handleStorageChange);
  return () => window.removeEventListener('storage', handleStorageChange);
}, []);
```

**å®ç°æ•ˆæœ**:
- âœ… ä¸»çª—å£å¯åŠ¨ Timer â†’ Widget å®æ—¶æ˜¾ç¤º
- âœ… ä¸»çª—å£åœæ­¢ Timer â†’ Widget æ¸…ç©ºæ˜¾ç¤º
- âœ… è·¨çª—å£æ—¶é•¿åŒæ­¥æ›´æ–°

---

## 9. è¾¹ç¼˜æƒ…å†µå¤„ç†

### 9.1 æ—¶é—´æˆ³å¼‚å¸¸

**é—®é¢˜**: `startTime` æˆ– `elapsedTime` å‡ºç°è´Ÿæ•°ã€NaN æˆ–è¶…å¤§æ•°å€¼

**è§£å†³æ–¹æ¡ˆ**:

```typescript
// TimerCard.tsx L74-82
const safeElapsedTime = (elapsedTime && !isNaN(elapsedTime) && elapsedTime >= 0) 
  ? elapsedTime 
  : 0;

const safeStartTime = (startTime && !isNaN(startTime) && startTime > 0) 
  ? startTime 
  : Date.now();
```

**UI é™çº§**:
- æ˜¾ç¤º `--:--`
- æ‰“å°é”™è¯¯æ—¥å¿—åˆ°æ§åˆ¶å°
- å…è®¸ç”¨æˆ·ç‚¹å‡»"å–æ¶ˆ"æ¸…é™¤çŠ¶æ€

### 9.2 æ ‡ç­¾è¢«åˆ é™¤

**åœºæ™¯**: Timer è¿è¡Œä¸­ï¼Œç”¨æˆ·åœ¨ TagManager ä¸­åˆ é™¤äº†è¯¥æ ‡ç­¾

**å¤„ç†æ–¹æ¡ˆ**:

```typescript
const tag = TagService.getFlatTags().find(t => t.id === globalTimer.tagId);
if (!tag) {
  console.warn('âš ï¸ Tag not found for timer:', globalTimer.tagId);
  // æ˜¾ç¤ºå ä½ç¬¦
  displayTagName = '(å·²åˆ é™¤çš„æ ‡ç­¾)';
  displayTagPath = 'æœªé€‰æ‹©æ ‡ç­¾';
  // å…è®¸ç”¨æˆ·é‡æ–°ç¼–è¾‘é€‰æ‹©æ–°æ ‡ç­¾
}
```

### 9.3 é¡µé¢åˆ·æ–°ä¸­ Timer ä¸¢å¤±

**é—®é¢˜**: ç”¨æˆ·åœ¨ Timer è¿è¡Œä¸­åˆ·æ–°é¡µé¢ï¼Œ`useEffect` æ¯ 30 ç§’ä¿å­˜å¯èƒ½åˆšå¥½åœ¨åˆ·æ–°å‰

**è§£å†³æ–¹æ¡ˆ**: `handleBeforeUnload` é’©å­

**ä»£ç ä½ç½®**: `src/App.tsx` L827-876

```typescript
useEffect(() => {
  const handleBeforeUnload = (event: BeforeUnloadEvent) => {
    if (globalTimer && globalTimer.isRunning) {
      // ç«‹å³ä¿å­˜ Timer çŠ¶æ€
      const now = Date.now();
      const totalElapsed = globalTimer.elapsedTime + (now - globalTimer.startTime);
      const startTime = new Date(globalTimer.originalStartTime || globalTimer.startTime);
      const endTime = new Date(startTime.getTime() + totalElapsed);
      
      const timerEventId = `timer-${globalTimer.tagId}-${startTime.getTime()}`;
      
      // è¯»å–ç°æœ‰äº‹ä»¶ï¼Œä¿ç•™ç”¨æˆ·è¾“å…¥
      const saved = localStorage.getItem(STORAGE_KEYS.EVENTS);
      const existingEvents: Event[] = saved ? JSON.parse(saved) : [];
      const existingEvent = existingEvents.find(e => e.id === timerEventId);
      
      const timerEvent: Event = {
        id: timerEventId,
        description: existingEvent?.description || 'è®¡æ—¶äº‹ä»¶ï¼ˆå·²è‡ªåŠ¨ä¿å­˜ï¼‰',
        syncStatus: 'local-only',
        // ...
      };
      
      // åŒæ­¥ä¿å­˜ï¼ˆä¸èƒ½ä½¿ç”¨ asyncï¼‰
      const updatedEvents = existingEvents.map(e => 
        e.id === timerEventId ? timerEvent : e
      );
      localStorage.setItem(STORAGE_KEYS.EVENTS, JSON.stringify(updatedEvents));
      
      // æç¤ºç”¨æˆ·
      event.preventDefault();
      event.returnValue = 'è®¡æ—¶å™¨æ­£åœ¨è¿è¡Œä¸­ï¼Œç¡®å®šè¦ç¦»å¼€å—ï¼Ÿ';
    }
  };

  window.addEventListener('beforeunload', handleBeforeUnload);
  return () => window.removeEventListener('beforeunload', handleBeforeUnload);
}, [globalTimer]);
```

**æ•ˆæœ**:
- âœ… åˆ·æ–°å‰å¼¹çª—æç¤ºç”¨æˆ·
- âœ… åŒæ­¥ä¿å­˜æœ€æ–°çš„ Timer äº‹ä»¶æ•°æ®
- âœ… åˆ·æ–°åé€šè¿‡ localStorage æ¢å¤çŠ¶æ€

---

## 10. æ€§èƒ½ä¼˜åŒ–

### 10.1 UI æ›´æ–°é¢‘ç‡æ§åˆ¶

**é—®é¢˜**: Timer è¿è¡Œæ—¶æ¯ç§’è§¦å‘ re-renderï¼Œå¯èƒ½å½±å“æ€§èƒ½

**ä¼˜åŒ–æ–¹æ¡ˆ**:

1. **ä½¿ç”¨ currentTime çŠ¶æ€**: åªæ›´æ–°æ—¶é—´æˆ³ï¼Œä¸é‡æ–°æ¸²æŸ“æ•´ä¸ªç»„ä»¶æ ‘
   ```typescript
   const [currentTime, setCurrentTime] = useState(Date.now());
   
   useEffect(() => {
     if (isRunning) {
       const interval = setInterval(() => {
         setCurrentTime(Date.now());
       }, 1000);
       return () => clearInterval(interval);
     }
   }, [isRunning]);
   ```

2. **é¿å…çˆ¶ç»„ä»¶ re-render**: App.tsx æ¯ç§’å¼ºåˆ¶æ›´æ–° globalTimer è§¦å‘å­ç»„ä»¶æ›´æ–°
   ```typescript
   // App.tsx L1157-1172
   useEffect(() => {
     if (globalTimer?.isRunning) {
       const updateInterval = setInterval(() => {
         // è§¦å‘ globalTimer å¼•ç”¨å˜åŒ–ï¼Œä½†ä¸æ”¹å˜æ•°æ®
         setGlobalTimer(prev => prev ? { ...prev } : null);
       }, 1000);
       return () => clearInterval(updateInterval);
     }
   }, [globalTimer?.isRunning]);
   ```

**æ€§èƒ½æ•°æ®**:
- Timer è¿è¡Œæ—¶ CPU å ç”¨: ~1-2%
- æ¯ç§’ re-render æ¬¡æ•°: 1 æ¬¡ï¼ˆä»… TimerCard ç»„ä»¶ï¼‰

### 10.2 å­˜å‚¨å†™å…¥é¢‘ç‡ä¼˜åŒ–

**ç­–ç•¥**:
- âœ… è¿è¡Œä¸­: æ¯ 30 ç§’å†™å…¥ä¸€æ¬¡ localStorage
- âœ… çŠ¶æ€å˜æ›´ï¼ˆæš‚åœ/ç»§ç»­ï¼‰: ç«‹å³å†™å…¥
- âœ… é¡µé¢åˆ·æ–°: `beforeunload` é’©å­ç«‹å³å†™å…¥

**é¿å…è¿‡åº¦å†™å…¥**:
```typescript
// é”™è¯¯åšæ³•ï¼šæ¯ç§’å†™å…¥
setInterval(() => {
  localStorage.setItem('events', JSON.stringify(events)); // âŒ æ€§èƒ½æµªè´¹
}, 1000);

// æ­£ç¡®åšæ³•ï¼š30ç§’å†™å…¥
setInterval(() => {
  localStorage.setItem('events', JSON.stringify(events)); // âœ… å¹³è¡¡æ€§èƒ½å’Œå®‰å…¨
}, 30000);
```

---

## 11. å·²çŸ¥é—®é¢˜ä¸ä¿®å¤å†å²

### 11.1 å·²ä¿®å¤: Timer è¿è¡Œä¸­ç¼–è¾‘ description è¢«è¦†ç›–

**ä¿®å¤æ—¥æœŸ**: 2025-11-05  
**å½±å“ç‰ˆæœ¬**: v1.0 (ä¿®å¤å‰)  
**ä¿®å¤ç‰ˆæœ¬**: v1.1 (ä¿®å¤å)

**é—®é¢˜ç°è±¡**:
- ç”¨æˆ·åœ¨ Timer è¿è¡Œæ—¶æ‰“å¼€ EventEditModal ç¼–è¾‘ description
- ä¿å­˜åï¼Œdescription æ˜¾ç¤ºå·²æ›´æ–°
- 30 ç§’åï¼ˆæˆ–ä¸‹æ¬¡è‡ªåŠ¨ä¿å­˜è§¦å‘æ—¶ï¼‰ï¼Œç”¨æˆ·çš„ç¼–è¾‘å†…å®¹è¢«è¦†ç›–ä¸ºæ—§å†…å®¹

**æ ¹æœ¬åŸå› **:

Timer æ¨¡å—æœ‰ä¸¤ä¸ªä¿å­˜é€»è¾‘ï¼š

1. **`handleTimerEditSave`** (ç”¨æˆ·ä¸»åŠ¨ç¼–è¾‘): åªæ›´æ–°äº† `globalTimer` çŠ¶æ€å’Œ `eventTitle/eventEmoji`ï¼Œ**ä½†æ²¡æœ‰å°† description/location ä¿å­˜åˆ° localStorage çš„äº‹ä»¶å¯¹è±¡ä¸­**

2. **`saveTimerEvent`** (æ¯ 30 ç§’è‡ªåŠ¨æ‰§è¡Œ): ä» localStorage è¯»å–ç°æœ‰äº‹ä»¶çš„ description â†’ ä»ç„¶æ˜¯æ—§å€¼ â†’ è¦†ç›–æ•´ä¸ªäº‹ä»¶å¯¹è±¡

**æ•°æ®æµåˆ†æ**:

```
T=0s:  ç”¨æˆ·ç¼–è¾‘ description = "æ–°å†…å®¹"
        â†“
       handleTimerEditSave æ‰§è¡Œ
        â†“
       åªæ›´æ–°: globalTimer.eventTitle
       æœªæ›´æ–°: localStorage ä¸­çš„äº‹ä»¶.description (ä»æ˜¯ "æ—§å†…å®¹")
        â†“
T=30s: saveTimerEvent è‡ªåŠ¨æ‰§è¡Œ
        â†“
       ä» localStorage è¯»å–äº‹ä»¶ â†’ description = "æ—§å†…å®¹"
        â†“
       æ„é€ æ–°äº‹ä»¶å¯¹è±¡ â†’ description = existingEvent.description = "æ—§å†…å®¹"
        â†“
       å†™å› localStorage â†’ è¦†ç›–
        â†“
       ç”¨æˆ·çš„ç¼–è¾‘ä¸¢å¤± âŒ
```

**ä¿®å¤æ–¹æ¡ˆ**:

åœ¨ `handleTimerEditSave` ä¸­ï¼Œå½“æ›´æ–°è¿è¡Œä¸­çš„ Timer æ—¶ï¼Œç«‹å³å°† descriptionã€locationã€title åŒæ­¥åˆ° localStorage çš„äº‹ä»¶å¯¹è±¡ï¼š

```typescript
// App.tsx L748-780
if (globalTimer.eventId) {
  try {
    const saved = localStorage.getItem(STORAGE_KEYS.EVENTS);
    const existingEvents: Event[] = saved ? JSON.parse(saved) : [];
    const eventIndex = existingEvents.findIndex((e: Event) => e.id === globalTimer.eventId);
    
    if (eventIndex !== -1) {
      existingEvents[eventIndex] = {
        ...existingEvents[eventIndex],
        description: updatedEvent.description,  // ğŸ”§ ç«‹å³ä¿å­˜
        location: updatedEvent.location,        // ğŸ”§ ç«‹å³ä¿å­˜
        title: updatedEvent.title,              // ğŸ”§ ç«‹å³ä¿å­˜
        updatedAt: formatTimeForStorage(new Date())
      };
      
      localStorage.setItem(STORAGE_KEYS.EVENTS, JSON.stringify(existingEvents));
    }
  } catch (error) {
    AppLogger.error('ğŸ’¾ [Timer Edit] Failed to save user edits:', error);
  }
}
```

**ä¿®å¤åçš„æ•°æ®æµ**:

```
T=0s:  ç”¨æˆ·ç¼–è¾‘ description = "æ–°å†…å®¹"
        â†“
       handleTimerEditSave æ‰§è¡Œ
        â†“
       æ›´æ–°: globalTimer.eventTitle
       æ›´æ–°: localStorage ä¸­çš„äº‹ä»¶.description = "æ–°å†…å®¹" âœ…
        â†“
T=30s: saveTimerEvent è‡ªåŠ¨æ‰§è¡Œ
        â†“
       ä» localStorage è¯»å–äº‹ä»¶ â†’ description = "æ–°å†…å®¹" âœ…
        â†“
       æ„é€ æ–°äº‹ä»¶å¯¹è±¡ â†’ description = existingEvent.description = "æ–°å†…å®¹"
        â†“
       å†™å› localStorage â†’ ä¸è¦†ç›–ç”¨æˆ·å†…å®¹
        â†“
       ç”¨æˆ·çš„ç¼–è¾‘ä¿ç•™ âœ…
```

**æµ‹è¯•éªŒè¯**:

1. å¯åŠ¨ Timer
2. ç‚¹å‡»ç¼–è¾‘ï¼Œä¿®æ”¹ description ä¸º"æµ‹è¯•å†…å®¹"
3. ä¿å­˜å¹¶å…³é—­æ¨¡æ€æ¡†
4. ç­‰å¾… 30 ç§’ï¼ˆæˆ–è§¦å‘è‡ªåŠ¨ä¿å­˜ï¼‰
5. å†æ¬¡æ‰“å¼€ç¼–è¾‘æ¨¡æ€æ¡†
6. **é¢„æœŸ**: description ä»ç„¶æ˜¯"æµ‹è¯•å†…å®¹" âœ…
7. **ä¿®å¤å‰**: description è¢«è¦†ç›–ä¸º"è®¡æ—¶ä¸­çš„äº‹ä»¶" âŒ

**ç›¸å…³ä»£ç ä½ç½®**:
- ä¿®å¤ä»£ç : `src/App.tsx` L748-780 (handleTimerEditSave)
- è‡ªåŠ¨ä¿å­˜: `src/App.tsx` L782-850 (saveTimerEvent useEffect)
- PRD è¯´æ˜: [6.2 EventEditModal é›†æˆ](#62-eventeditmodal-é›†æˆ)

---

## ğŸ“Š æ€»ç»“

### æ ¸å¿ƒç‰¹æ€§

| ç‰¹æ€§ | å®ç°æ–¹å¼ | ç”¨æˆ·ä»·å€¼ |
|------|---------|---------|
| **æ— æ„Ÿè®°å½•** | è‡ªåŠ¨åˆ›å»ºæ—¥å†äº‹ä»¶ | æ— éœ€æ‰‹åŠ¨è®°å½•æ—¶é—´ |
| **çµæ´»è°ƒæ•´** | æ”¯æŒä¿®æ”¹å¼€å§‹æ—¶é—´ã€æ ‡é¢˜ã€æ ‡ç­¾ | é€‚åº”çœŸå®å·¥ä½œåœºæ™¯ |
| **æ•°æ®å®‰å…¨** | 30ç§’ä¿å­˜ + é¡µé¢åˆ·æ–°é’©å­ | é˜²æ­¢æ•°æ®ä¸¢å¤± |
| **è·¨çª—å£åŒæ­¥** | localStorage + storage äº‹ä»¶ | Widget å®æ—¶æ˜¾ç¤º |
| **æ™ºèƒ½åŒæ­¥** | åœæ­¢æ—¶è½¬ä¸º pendingï¼Œè¿è¡Œä¸­ä¸åŒæ­¥ | é¿å…é¢‘ç¹ API è°ƒç”¨ |
| **å®æ—¶ç¼–è¾‘ä¿æŠ¤** | ç”¨æˆ·ç¼–è¾‘ç«‹å³æŒä¹…åŒ– | description/location ä¸è¢«è‡ªåŠ¨ä¿å­˜è¦†ç›– |

### å…³é”®æ•°æ®æµ

```
ç”¨æˆ·å¯åŠ¨ Timer
    â†“
åˆ›å»º local-only äº‹ä»¶
    â†“
æ¯ 30 ç§’ä¿å­˜è¿›åº¦ï¼ˆç›´æ¥å†™ localStorageï¼‰
    â†“
ç”¨æˆ·åœæ­¢ Timer
    â†“
syncStatus: local-only â†’ pending
    â†“
EventService.updateEvent (skipSync=false)
    â†“
åŠ å…¥åŒæ­¥é˜Ÿåˆ—
    â†“
5 ç§’ååŒæ­¥åˆ° Outlook
    â†“
è·å¾— externalId â†’ æ›´æ–° IndexMap
    â†“
è¿œç¨‹åŒæ­¥å›å†™æ—¶é€šè¿‡ externalId åŒ¹é…
    â†“
é¿å…é‡å¤äº‹ä»¶
```

### ä¸å…¶ä»–æ¨¡å—çš„å…³è”

| æ¨¡å— | å…³è”ç‚¹ | æ•°æ®æµå‘ |
|------|-------|---------|
| **åŒæ­¥æœºåˆ¶** | Timer åœæ­¢è§¦å‘åŒæ­¥ | Timer â†’ EventService â†’ SyncManager |
| **TagService** | æ ‡ç­¾é€‰æ‹©ã€æ—¥å†æ˜ å°„ | Timer â†’ TagService â†’ è·å–æ ‡ç­¾ä¿¡æ¯ |
| **TimeCalendar** | Timer äº‹ä»¶æ˜¾ç¤ºã€æ—¥å¿—ç¼–è¾‘ | Timer ä¿å­˜äº‹ä»¶ â†’ TimeCalendar æ¸²æŸ“<br/>TimeCalendar ç¼–è¾‘ description â†’ æ›´æ–° Timer äº‹ä»¶ |
| **EventEditModal** | Timer ç¼–è¾‘å…¥å£ã€æ—¥å¿—ç¼–è¾‘ç•Œé¢ | Timer â†’ æ‰“å¼€ Modal â†’ ç¼–è¾‘ description/å…¶ä»–å­—æ®µ â†’ ä¿å­˜å› Timer |
| **Outlook åŒæ­¥** | description å­—æ®µåŒæ­¥ | Timer description â†’ Graph API body.content (çº¯æ–‡æœ¬)<br/>æœªæ¥: å¯Œæ–‡æœ¬ â†’ HTML æ ¼å¼è½¬æ¢ |

---

## 9. ä¸ PlanManager çš„é›†æˆ

### 9.1 Plan Item å¯åŠ¨ Timer

**åœºæ™¯**: ç”¨æˆ·åœ¨ PlanManager ä¸­ç‚¹å‡» Plan Item çš„"å¼€å§‹è®¡æ—¶"æŒ‰é’®

**æ•°æ®æµ**:
```
ç”¨æˆ·ç‚¹å‡» Plan Item çš„"å¼€å§‹è®¡æ—¶"æŒ‰é’®
    â†“
PlanManager è°ƒç”¨ TimerService.startTimer(planItemId)
    â†“
Timer æŸ¥æ‰¾å¯¹åº”çš„ Eventï¼ˆé€šè¿‡ planItemIdï¼‰
    â†“
åˆ›å»º Timer äº‹ä»¶ï¼š
  - eventId: planItemIdï¼ˆå…³è”åŸ Plan Itemï¼‰
  - title: Plan Item çš„ content/title
  - tags: Plan Item çš„ tags
  - startTime: Date.now()
    â†“
ä¿å­˜åˆ° localStorage.currentTimer
    â†“
è§¦å‘ EventHub 'timer-updated' äº‹ä»¶
    â†“
PlanManager å’Œ TimeCalendar ç›‘å¬å¹¶æ›´æ–° UI
```

**å…³é”®ä»£ç ä½ç½®**ï¼ˆæ¨æµ‹ï¼Œéœ€è¦åœ¨ PlanManager ä¸­å®ç°ï¼‰:
```typescript
// PlanManager.tsxï¼ˆå¾…å®ç°ï¼‰
const handleStartTimer = (planItem: Event) => {
  TimerService.startTimer(planItem.id);
};
```

**Timer ç«¯å¤„ç†**ï¼ˆTimerService.tsï¼‰:
```typescript
// æ”¯æŒä¼ å…¥ eventId å‚æ•°
static startTimer(eventId?: string) {
  if (this.isRunning) {
    throw new Error('Timer is already running');
  }
  
  // å¦‚æœä¼ å…¥ eventIdï¼ŒæŸ¥æ‰¾å¯¹åº”çš„ Event
  let initialTitle = '';
  let initialTags: string[] = [];
  if (eventId) {
    const event = EventService.getEventById(eventId);
    if (event) {
      initialTitle = event.title || event.content || '';
      initialTags = event.tags || [];
    }
  }
  
  const timer: Timer = {
    eventId: eventId || `timer-${Date.now()}`,
    title: initialTitle,
    tags: initialTags,
    startTime: Date.now(),
    duration: 0,
    status: 'running'
  };
  
  this.saveTimer(timer);
  this.startInterval();
  EventHub.emit('timer-updated', timer);
}
```

### 9.2 Timer ç»“æŸåæ›´æ–° Plan Item

**åœºæ™¯**: ç”¨æˆ·åœæ­¢ Timer åï¼Œéœ€è¦æ›´æ–°åŸ Plan Item çš„ `duration` å­—æ®µ

**æ•°æ®æµ**:
```
ç”¨æˆ·åœæ­¢ Timer
    â†“
TimerService.stopTimer()
    â†“
è®¡ç®—æ€»æ—¶é•¿ï¼šcurrentDuration + (Date.now() - startTime)
    â†“
æ›´æ–° Event çš„ duration å­—æ®µ
    â†“
å¦‚æœ eventId æ˜¯ Plan Item IDï¼ŒåŒæ—¶æ›´æ–° Plan Item
    â†“
è§¦å‘ 'local-events-changed' äº‹ä»¶
    â†“
PlanManager é‡æ–°åŠ è½½æ•°æ®ï¼Œæ˜¾ç¤ºæ›´æ–°åçš„ duration
```

**å…³é”®å®ç°**ï¼ˆTimerService.tsï¼‰:
```typescript
static stopTimer() {
  if (!this.isRunning) return;
  
  const timer = this.getCurrentTimer();
  if (!timer) return;
  
  // è®¡ç®—æ€»æ—¶é•¿
  const finalDuration = timer.duration + Math.floor((Date.now() - timer.startTime) / 1000);
  
  // æ›´æ–°äº‹ä»¶
  const event = EventService.getEventById(timer.eventId);
  if (event) {
    EventService.updateEvent(timer.eventId, {
      ...event,
      duration: finalDuration,
      syncStatus: 'pending' // æ ‡è®°ä¸ºå¾…åŒæ­¥
    });
  }
  
  // è§¦å‘äº‹ä»¶å˜æ›´é€šçŸ¥
  EventHub.emit('local-events-changed');
  
  // æ¸…é™¤ Timer
  localStorage.removeItem('currentTimer');
  this.stopInterval();
  EventHub.emit('timer-updated', null);
}
```

### 9.3 Plan Item ä¸ Timer äº‹ä»¶çš„å…³ç³»

**æ•°æ®ç»“æ„å¯¹æ¯”**:

| å­—æ®µ | Plan Item | Timer äº‹ä»¶ | è¯´æ˜ |
|------|-----------|-----------|------|
| `id` | `line-{timestamp}` | `line-{timestamp}` | ç›¸åŒï¼ˆTimer ä½¿ç”¨ Plan Item çš„ IDï¼‰ |
| `title/content` | Plan å†…å®¹ | Timer æ ‡é¢˜ | Timer ç»§æ‰¿è‡ª Plan |
| `tags` | Plan æ ‡ç­¾ | Timer æ ‡ç­¾ | Timer ç»§æ‰¿è‡ª Plan |
| `duration` | ç´¯è®¡æ—¶é•¿ | å®æ—¶æ—¶é•¿ | Timer åœæ­¢åæ›´æ–° Plan çš„ duration |
| `startTime` | Plan çš„è®¡åˆ’å¼€å§‹æ—¶é—´ | Timer çš„å®é™…å¼€å§‹æ—¶é—´ | **ä¸åŒ**ï¼šTimer è®°å½•å®é™…è®¡æ—¶å¼€å§‹æ—¶é—´ |
| `endTime` | Plan çš„è®¡åˆ’ç»“æŸæ—¶é—´ | Timer çš„å®é™…ç»“æŸæ—¶é—´ | **ä¸åŒ**ï¼šTimer è®°å½•å®é™…è®¡æ—¶ç»“æŸæ—¶é—´ |
| `mode` | `'title'` or `'description'` | N/A | Plan ç‰¹æœ‰å­—æ®µ |
| `level` | å±‚çº§æ·±åº¦ | N/A | Plan ç‰¹æœ‰å­—æ®µ |

**å…³é”®åŒºåˆ«**:
- **Plan Item çš„ `startTime`/`endTime`**: ç”¨æˆ·è®¡åˆ’çš„æ—¶é—´
- **Timer äº‹ä»¶çš„ `startTime`/`endTime`**: å®é™…è®¡æ—¶çš„æ—¶é—´
- **`duration` å­—æ®µ**: Timer åœæ­¢åï¼Œç´¯åŠ åˆ° Plan Item çš„ duration

### 9.4 åŒå‘æ•°æ®æµ

```mermaid
graph LR
    A[PlanManager] -->|1. å¯åŠ¨ Timer| B[TimerService]
    B -->|2. åˆ›å»º Timer äº‹ä»¶| C[localStorage]
    C -->|3. è§¦å‘ timer-updated| D[TimeCalendar]
    D -->|4. æ˜¾ç¤ºå®æ—¶æ—¶é•¿| E[ç”¨æˆ·]
    E -->|5. åœæ­¢ Timer| B
    B -->|6. æ›´æ–° duration| F[Plan Item]
    F -->|7. è§¦å‘ local-events-changed| A
    A -->|8. é‡æ–°æ¸²æŸ“| E
```

**å…³é”®äº‹ä»¶**:
1. `timer-updated`: Timer å¯åŠ¨/åœæ­¢æ—¶è§¦å‘ï¼ŒTimeCalendar ç›‘å¬å¹¶æ›´æ–° UI
2. `local-events-changed`: Plan Item çš„ duration æ›´æ–°åè§¦å‘ï¼ŒPlanManager ç›‘å¬å¹¶é‡æ–°åŠ è½½

### 9.5 å·²çŸ¥é—®é¢˜ä¸æ³¨æ„äº‹é¡¹

#### Issue #1: Plan Item ä¸ Timer äº‹ä»¶çš„ ID å†²çª

**é—®é¢˜**: å¦‚æœ Timer ä½¿ç”¨ Plan Item çš„ IDï¼Œå¯èƒ½å¯¼è‡´ä»¥ä¸‹é—®é¢˜ï¼š
- TimeCalendar ä¸­åŒæ—¶æ˜¾ç¤º Plan Item å’Œ Timer äº‹ä»¶ï¼Œå¯¼è‡´é‡å¤
- Timer äº‹ä»¶è¦†ç›– Plan Item çš„åŸå§‹æ•°æ®

**è§£å†³æ–¹æ¡ˆ**ï¼ˆæ¨èï¼‰:
```typescript
// æ–¹æ¡ˆ A: Timer ä½¿ç”¨ç‹¬ç«‹ ID
const timerId = `timer-${planItemId}-${Date.now()}`;

// æ–¹æ¡ˆ B: Timer äº‹ä»¶æ·»åŠ  sourceType å­—æ®µ
const timerEvent = {
  id: planItemId,
  sourceType: 'timer', // ğŸ†• æ ‡è¯†æ¥æº
  originalPlanItem: planItemId, // ğŸ†• å…³è”åŸå§‹ Plan Item
  // ...
};

// TimeCalendar è¿‡æ»¤é€»è¾‘
const events = allEvents.filter(e => {
  // å¦‚æœæ˜¯ Timer äº‹ä»¶ï¼Œä¸”å¯¹åº”çš„ Plan Item å­˜åœ¨ï¼Œåˆ™éšè— Plan Item
  if (e.sourceType === 'plan') {
    const hasRunningTimer = allEvents.some(t => 
      t.sourceType === 'timer' && t.originalPlanItem === e.id
    );
    return !hasRunningTimer;
  }
  return true;
});
```

#### Issue #2: Timer åœæ­¢å Plan Item çš„ startTime è¢«è¦†ç›–

**é—®é¢˜**: Timer åœæ­¢æ—¶ï¼Œå¦‚æœç›´æ¥æ›´æ–° Eventï¼Œå¯èƒ½è¦†ç›– Plan Item çš„è®¡åˆ’æ—¶é—´

**è§£å†³æ–¹æ¡ˆ**:
```typescript
// Timer åœæ­¢æ—¶ï¼Œåªæ›´æ–°ç‰¹å®šå­—æ®µ
EventService.updateEvent(timer.eventId, {
  duration: finalDuration, // âœ… æ›´æ–°æ—¶é•¿
  // âŒ ä¸æ›´æ–° startTime/endTimeï¼Œä¿ç•™ Plan Item çš„è®¡åˆ’æ—¶é—´
});
```

---

## 10. EventHub API è§„èŒƒè¡¥å……

### 10.1 EventHub.saveEvent() è¿”å›å€¼

**ç±»å‹å®šä¹‰**:
```typescript
/**
 * ä¿å­˜äº‹ä»¶ï¼ˆåˆ›å»ºæˆ–æ›´æ–°ï¼‰
 * @param eventData äº‹ä»¶æ•°æ®
 * @returns ä¿å­˜åçš„å®Œæ•´ Event å¯¹è±¡ï¼ˆåŒ…å«ç”Ÿæˆçš„ IDï¼‰
 */
async saveEvent(eventData: Event): Promise<Event>
```

**è¿”å›å€¼è¯´æ˜**:
- å¦‚æœ `eventData.id` ä»¥ `temp-` æˆ– `timer-` å¼€å¤´ï¼Œè°ƒç”¨ `EventService.createEvent()`ï¼Œè¿”å›ç”Ÿæˆçš„ UUID
- å¦åˆ™è°ƒç”¨ `EventService.updateEvent()`ï¼Œè¿”å›æ›´æ–°åçš„ Event å¯¹è±¡
- è¿”å›å€¼åŒ…å«æ‰€æœ‰å­—æ®µï¼ŒåŒ…æ‹¬ `outlookEventId`ã€`outlookCalendarId`ï¼ˆå¦‚æœå·²åŒæ­¥ï¼‰

**ä½¿ç”¨ç¤ºä¾‹**ï¼ˆTimeCalendar PRD L1645ï¼‰:
```typescript
const savedEvent = await EventHub.saveEvent(eventData);

// å¦‚æœæ˜¯ Outlook äº‹ä»¶ï¼Œè§¦å‘åŒæ­¥
if (savedEvent.outlookCalendarId) {
  await ActionBasedSyncManager.getInstance().syncSpecificCalendar(
    savedEvent.outlookCalendarId
  );
}
```

### 10.2 syncStatus æšä¸¾å®šä¹‰

**ç±»å‹å®šä¹‰**:
```typescript
type SyncStatus = 
  | 'local-only'    // æœ¬åœ°åˆ›å»ºï¼ŒæœªåŒæ­¥
  | 'synced'        // å·²åŒæ­¥åˆ° Outlook
  | 'pending'       // ç­‰å¾…åŒæ­¥
  | 'conflict'      // åŒæ­¥å†²çª
  | 'error';        // åŒæ­¥å¤±è´¥
```

**çŠ¶æ€è½¬æ¢**:
```mermaid
graph LR
    A[local-only] -->|ç”¨æˆ·è¯·æ±‚åŒæ­¥| B[pending]
    B -->|åŒæ­¥æˆåŠŸ| C[synced]
    B -->|åŒæ­¥å¤±è´¥| D[error]
    B -->|æ£€æµ‹åˆ°å†²çª| E[conflict]
    C -->|æœ¬åœ°ä¿®æ”¹| B
    D -->|é‡è¯•| B
    E -->|ç”¨æˆ·è§£å†³å†²çª| B
```

**å„çŠ¶æ€è¯´æ˜**:

| çŠ¶æ€ | è§¦å‘æ—¶æœº | UI æ˜¾ç¤º | ç”¨æˆ·æ“ä½œ |
|------|----------|---------|---------|
| `local-only` | åˆ›å»ºäº‹ä»¶ã€Timer å¯åŠ¨ | æ— åŒæ­¥å›¾æ ‡ | å¯ç‚¹å‡»"åŒæ­¥åˆ° Outlook" |
| `pending` | Timer åœæ­¢ã€ç”¨æˆ·ä¿®æ”¹äº‹ä»¶ | åŒæ­¥ä¸­å›¾æ ‡ï¼ˆæ—‹è½¬ï¼‰ | ç­‰å¾…åŒæ­¥å®Œæˆ |
| `synced` | åŒæ­¥æˆåŠŸ | å¯¹å‹¾å›¾æ ‡ | å¯ç»§ç»­ç¼–è¾‘ï¼ˆä¼šé‡æ–°è¿›å…¥ pendingï¼‰ |
| `error` | ç½‘ç»œé”™è¯¯ã€API é™æµ | é”™è¯¯å›¾æ ‡ | ç‚¹å‡»é‡è¯• |
| `conflict` | æœ¬åœ°å’Œè¿œç¨‹ç‰ˆæœ¬ä¸ä¸€è‡´ | è­¦å‘Šå›¾æ ‡ | æ‰“å¼€å†²çªè§£å†³ç•Œé¢ |

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.2  
**æœ€åæ›´æ–°**: 2025-11-05  
**ç»´æŠ¤è€…**: GitHub Copilot  
**æ›´æ–°æ—¥å¿—**:
- v1.2 (2025-11-05): **æ–°å¢ Section 9**ï¼ˆä¸ PlanManager çš„é›†æˆï¼‰å’Œ **Section 10**ï¼ˆEventHub API è§„èŒƒè¡¥å……ï¼‰
- v1.2 (2025-11-05): è¡¥å…… `EventHub.saveEvent()` è¿”å›å€¼å®šä¹‰å’Œ `syncStatus` æšä¸¾
- v1.1 (2025-11-05): æ·»åŠ "å·²çŸ¥é—®é¢˜ä¸ä¿®å¤å†å²"ç« èŠ‚ï¼Œè®°å½• description è¦†ç›– bug çš„ä¿®å¤
- v1.1 (2025-11-05): å®Œå–„ 6.2 èŠ‚ï¼Œè¯¦ç»†è¯´æ˜ `handleTimerEditSave` çš„åŒé‡æ›´æ–°æœºåˆ¶
- v1.1 (2025-11-05): æ›´æ–° 5.2 èŠ‚ï¼Œè¯´æ˜ `saveTimerEvent` å¦‚ä½•é…åˆç”¨æˆ·ç¼–è¾‘ä¿å­˜
- v1.0 (2025-11-05): åˆå§‹ç‰ˆæœ¬ï¼Œå®Œæ•´è®°å½• Timer æ¨¡å—çš„è®¾è®¡ä¸å®ç°

**ç›¸å…³æ–‡æ¡£**:
- [PlanManager PRD](./PLANMANAGER_MODULE_PRD.md)
- [TimeCalendar PRD](./TIMECALENDAR_MODULE_PRD.md)
- [EventEditModal PRD](./EVENTEDITMODAL_MODULE_PRD.md)
