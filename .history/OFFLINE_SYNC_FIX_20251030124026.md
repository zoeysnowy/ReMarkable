# ç¦»çº¿äº‹ä»¶åŒæ­¥é—®é¢˜ä¿®å¤æ–¹æ¡ˆ

## é—®é¢˜åˆ†æ

### å‘ç°çš„é—®é¢˜

åœ¨æ–­ç½‘çŠ¶æ€ä¸‹åˆ›å»ºçš„æœ¬åœ°äº‹ä»¶ï¼ˆå¦‚Timeräº‹ä»¶ï¼‰ï¼Œåœ¨è”ç½‘å**æ²¡æœ‰åŠæ—¶åŒæ­¥åˆ°è¿œç¨‹Outlookæ—¥å†**ã€‚

### æ ¹æœ¬åŸå› 

é€šè¿‡æ£€æŸ¥ä»£ç ï¼Œå‘ç°ä»¥ä¸‹å‡ ä¸ªé—®é¢˜ï¼š

1. **âŒ ç¼ºå°‘ç½‘ç»œçŠ¶æ€ç›‘å¬**
   - ä»£ç ä¸­æ²¡æœ‰ç›‘å¬ `window.addEventListener('online')` äº‹ä»¶
   - ç½‘ç»œæ¢å¤åä¸ä¼šä¸»åŠ¨è§¦å‘åŒæ­¥ï¼Œåªèƒ½ç­‰å¾…å®šæ—¶å™¨ï¼ˆ20ç§’ï¼‰

2. **âš ï¸ é‡è¯•æ¬¡æ•°é™åˆ¶è¿‡ä¸¥æ ¼**
   - `syncSingleAction` ä¸­è®¾ç½®äº† `retryCount >= 3` çš„é™åˆ¶
   - å¦‚æœç½‘ç»œé•¿æ—¶é—´æ–­å¼€ï¼ˆ>60ç§’ï¼‰ï¼Œ3æ¬¡é‡è¯•ä¼šå¾ˆå¿«ç”¨å®Œ
   - ä¹‹åå³ä½¿ç½‘ç»œæ¢å¤ä¹Ÿä¸ä¼šå†å°è¯•åŒæ­¥

3. **â±ï¸ ä¾èµ–å®šæ—¶åŒæ­¥**
   - ä¸»è¦ä¾èµ–20ç§’çš„ `performSync()` å®šæ—¶å™¨æ¥é‡è¯•å¤±è´¥çš„actions
   - å¦‚æœç”¨æˆ·åœ¨æ–­ç½‘æœŸé—´åˆ›å»ºäº‹ä»¶åç«‹å³å…³é—­åº”ç”¨ï¼Œå®šæ—¶å™¨æ¥ä¸åŠè¿è¡Œ

4. **ğŸ“Š åŒæ­¥æ¡ä»¶æ£€æŸ¥ä¸å®Œæ•´**
   - `recordLocalAction` ä¸­åªæ£€æŸ¥ `isSignedIn()`ï¼Œæ²¡æœ‰æ£€æŸ¥å®é™…ç½‘ç»œè¿æ¥
   - å³ä½¿ `isSignedIn()` è¿”å›trueï¼Œç½‘ç»œå¯èƒ½å·²æ–­å¼€

## å½“å‰åŒæ­¥æµç¨‹

```
1. ç”¨æˆ·åœæ­¢Timer
   â†“
2. App.tsx: handleTimerStop()
   â†’ åˆ›å»ºæœ¬åœ°äº‹ä»¶ (syncStatus: 'pending')
   â†’ ä¿å­˜åˆ° localStorage
   â†“
3. å»¶è¿Ÿ5ç§’åè°ƒç”¨ syncManager.recordLocalAction()
   â†“
4. ActionBasedSyncManager: recordLocalAction()
   â†’ åˆ›å»º SyncAction
   â†’ ä¿å­˜åˆ° actionQueue (localStorage)
   â†’ æ£€æŸ¥ isRunning && isSignedIn()
   â†“
5. å¦‚æœæ¡ä»¶æ»¡è¶³ï¼šsetTimeout(() => syncSingleAction(action), 0)
   å¦‚æœæ¡ä»¶ä¸æ»¡è¶³ï¼šâš ï¸ ç­‰å¾…ä¸‹æ¬¡å®šæ—¶åŒæ­¥ï¼ˆ20ç§’åï¼‰
   â†“
6. syncSingleAction()
   â†’ å°è¯•åŒæ­¥åˆ°è¿œç¨‹
   â†’ å¦‚æœå¤±è´¥ï¼šretryCount++
   â†’ å¦‚æœ retryCount >= 3ï¼šâŒ ä¸å†é‡è¯•
   â†“
7. å®šæ—¶åŒæ­¥ (æ¯20ç§’)
   â†’ performSync()
   â†’ syncPendingLocalActions()
   â†’ é‡è¯•æœªåŒæ­¥çš„ actions
```

**é—®é¢˜ç‚¹ï¼š**
- âŒ æ­¥éª¤5ï¼šç½‘ç»œæ–­å¼€æ—¶æ¡ä»¶å¯èƒ½æ»¡è¶³ï¼Œä½†åŒæ­¥ä¼šå¤±è´¥
- âŒ æ­¥éª¤6ï¼š3æ¬¡é‡è¯•ç”¨å®Œåä¸å†å°è¯•
- âŒ æ²¡æœ‰åœ¨ç½‘ç»œæ¢å¤æ—¶ç«‹å³é‡è¯•

## ä¿®å¤æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šæ·»åŠ ç½‘ç»œçŠ¶æ€ç›‘å¬ï¼ˆæ¨èï¼‰âœ…

**ä¼˜ç‚¹ï¼š**
- ç½‘ç»œæ¢å¤æ—¶ç«‹å³åŒæ­¥ï¼Œå“åº”è¿…é€Ÿ
- ä¸ä¾èµ–å®šæ—¶å™¨ï¼Œæ›´å¯é 
- å®ç°ç®€å•

**å®ç°ï¼š**

```typescript
// åœ¨ ActionBasedSyncManager.ts çš„ constructor æˆ– start() ä¸­æ·»åŠ 

constructor(microsoftService: any) {
  // ... ç°æœ‰ä»£ç  ...
  
  // ğŸ”§ [NEW] ç›‘å¬ç½‘ç»œçŠ¶æ€å˜åŒ–
  this.setupNetworkListeners();
}

private setupNetworkListeners() {
  // ç›‘å¬ç½‘ç»œæ¢å¤
  window.addEventListener('online', () => {
    console.log('ğŸŒ [Network] Network is back online, triggering sync...');
    
    // ç­‰å¾…1ç§’è®©ç½‘ç»œç¨³å®š
    setTimeout(() => {
      if (this.isRunning && !this.syncInProgress) {
        console.log('ğŸ”„ [Network] Executing sync after network recovery');
        this.performSync();
      }
    }, 1000);
  });
  
  // ç›‘å¬ç½‘ç»œæ–­å¼€ï¼ˆå¯é€‰ï¼Œç”¨äºæ—¥å¿—ï¼‰
  window.addEventListener('offline', () => {
    console.log('ğŸ“´ [Network] Network is offline, sync will be queued');
  });
}

public stop() {
  this.isRunning = false;
  if (this.syncInterval) {
    clearInterval(this.syncInterval);
    this.syncInterval = null;
  }
  
  // ğŸ”§ [NEW] æ¸…ç†ç½‘ç»œç›‘å¬å™¨
  // æ³¨æ„ï¼šå¦‚æœéœ€è¦æ¸…ç†ï¼Œåº”è¯¥ä¿å­˜ç›‘å¬å‡½æ•°çš„å¼•ç”¨
}
```

### æ–¹æ¡ˆ2ï¼šå¢åŠ é‡è¯•æ¬¡æ•°å’Œæ™ºèƒ½é€€é¿

**ä¼˜ç‚¹ï¼š**
- é•¿æ—¶é—´æ–­ç½‘ä¹Ÿèƒ½ä¿æŒé‡è¯•
- æŒ‡æ•°é€€é¿é¿å…é¢‘ç¹å¤±è´¥

**å®ç°ï¼š**

```typescript
// ä¿®æ”¹ syncSingleAction æ–¹æ³•

private async syncSingleAction(action: SyncAction) {
  // ... ç°æœ‰ä»£ç  ...
  
  // ğŸ”§ [MODIFIED] å¢åŠ æœ€å¤§é‡è¯•æ¬¡æ•°åˆ° 10 æ¬¡ï¼Œå¹¶æ·»åŠ æ™ºèƒ½åˆ¤æ–­
  const MAX_RETRIES = 10;
  
  // ğŸ”§ [NEW] å¦‚æœæ˜¯ç½‘ç»œé”™è¯¯ï¼Œä¸è®¡å…¥é‡è¯•æ¬¡æ•°é™åˆ¶
  if (action.synchronized || action.retryCount >= MAX_RETRIES) {
    // æ£€æŸ¥æ˜¯å¦æ˜¯ç½‘ç»œé”™è¯¯
    if (action.lastError && this.isNetworkError(action.lastError)) {
      console.log('âš ï¸ [SYNC] Max retries reached but it\'s a network error, will retry on next sync');
      // ä¸è¿”å›ï¼Œç»§ç»­å°è¯•ï¼ˆç”±å®šæ—¶åŒæ­¥è§¦å‘ï¼‰
    } else {
      console.log('ğŸ” [SYNC SINGLE ACTION] Skipping action - already synchronized or max retries reached');
      return;
    }
  }

  try {
    // ... åŒæ­¥é€»è¾‘ ...
  } catch (error) {
    console.error('âŒ [SYNC SINGLE ACTION] Failed to sync action:', error);
    
    // ğŸ”§ [NEW] è®°å½•é”™è¯¯ç±»å‹
    action.lastError = error instanceof Error ? error.message : 'Unknown error';
    action.retryCount++;
    
    // ğŸ”§ [NEW] æŒ‡æ•°é€€é¿
    const backoffDelay = Math.min(1000 * Math.pow(2, action.retryCount), 30000);
    console.log(`â° [SYNC] Will retry after ${backoffDelay}ms`);
    
    this.saveActionQueue();
  }
}

// ğŸ”§ [NEW] åˆ¤æ–­æ˜¯å¦æ˜¯ç½‘ç»œé”™è¯¯
private isNetworkError(errorMessage: string): boolean {
  const networkErrorPatterns = [
    'network',
    'fetch',
    'timeout',
    'connection',
    'offline',
    'ENOTFOUND',
    'ECONNREFUSED'
  ];
  
  return networkErrorPatterns.some(pattern => 
    errorMessage.toLowerCase().includes(pattern)
  );
}
```

### æ–¹æ¡ˆ3ï¼šæ”¹è¿› recordLocalAction çš„ç½‘ç»œæ£€æŸ¥

**ä¼˜ç‚¹ï¼š**
- é¿å…åœ¨ç½‘ç»œæ–­å¼€æ—¶æµªè´¹é‡è¯•æ¬¡æ•°
- æ›´æ—©å‘ç°ç½‘ç»œé—®é¢˜

**å®ç°ï¼š**

```typescript
public recordLocalAction(type: 'create' | 'update' | 'delete', entityType: 'event' | 'task', entityId: string, data?: any, oldData?: any) {
  // ... åˆ›å»º action ä»£ç  ...
  
  this.actionQueue.push(action);
  this.saveActionQueue();
  
  // ğŸ”§ [MODIFIED] æ·»åŠ ç½‘ç»œçŠ¶æ€æ£€æŸ¥
  const isOnline = navigator.onLine;
  
  console.log('ğŸ” [RECORD LOCAL ACTION] Sync conditions:', {
    isRunning: this.isRunning,
    isSignedIn: this.microsoftService?.isSignedIn(),
    isOnline: isOnline,  // ğŸ”§ [NEW]
    willTriggerSync: this.isRunning && this.microsoftService?.isSignedIn() && isOnline
  });
  
  if (this.isRunning && this.microsoftService.isSignedIn() && isOnline) {
    console.log('ğŸ” [RECORD LOCAL ACTION] Scheduling async syncSingleAction...');
    setTimeout(() => {
      this.syncSingleAction(action);
    }, 0);
  } else {
    if (!isOnline) {
      console.log('ğŸ“´ [RECORD LOCAL ACTION] Network is offline, action will be synced when online');
    } else {
      console.log('âš ï¸ [RECORD LOCAL ACTION] Sync conditions not met, action will be queued for later sync');
    }
  }
}
```

## æ¨èçš„å®Œæ•´è§£å†³æ–¹æ¡ˆ

ç»“åˆä»¥ä¸Šä¸‰ä¸ªæ–¹æ¡ˆï¼š

1. âœ… **æ·»åŠ ç½‘ç»œçŠ¶æ€ç›‘å¬**ï¼ˆæ–¹æ¡ˆ1ï¼‰- æœ€é‡è¦
2. âœ… **å¢åŠ é‡è¯•æ¬¡æ•°å’Œæ™ºèƒ½åˆ¤æ–­**ï¼ˆæ–¹æ¡ˆ2ï¼‰
3. âœ… **æ”¹è¿›ç½‘ç»œçŠ¶æ€æ£€æŸ¥**ï¼ˆæ–¹æ¡ˆ3ï¼‰

### é¢å¤–ä¼˜åŒ–

```typescript
// ğŸ”§ [NEW] åœ¨ SyncAction æ¥å£ä¸­æ·»åŠ å­—æ®µ
interface SyncAction {
  // ... ç°æœ‰å­—æ®µ ...
  lastError?: string;  // è®°å½•æœ€åä¸€æ¬¡é”™è¯¯
  lastAttemptTime?: Date;  // è®°å½•æœ€åä¸€æ¬¡å°è¯•æ—¶é—´
}

// ğŸ”§ [NEW] åœ¨ performSync ä¸­ä¼˜å…ˆå¤„ç†å¤±è´¥çš„ actions
private async performSync() {
  // ... ç°æœ‰ä»£ç  ...
  
  // ğŸ”§ ä¼˜å…ˆåŒæ­¥å¤±è´¥æ¬¡æ•°å°‘çš„ actions
  await this.syncPendingLocalActions();
  
  // ... å…¶ä»–åŒæ­¥ä»£ç  ...
}

private async syncPendingLocalActions() {
  const pendingLocalActions = this.actionQueue.filter(
    action => action.source === 'local' && !action.synchronized
  );
  
  // ğŸ”§ [NEW] æŒ‰é‡è¯•æ¬¡æ•°æ’åºï¼Œä¼˜å…ˆå¤„ç†å¤±è´¥æ¬¡æ•°å°‘çš„
  pendingLocalActions.sort((a, b) => 
    (a.retryCount || 0) - (b.retryCount || 0)
  );
  
  console.log('ğŸ“Š [Sync] Pending local actions:', {
    total: pendingLocalActions.length,
    byRetryCount: pendingLocalActions.reduce((acc, action) => {
      const count = action.retryCount || 0;
      acc[count] = (acc[count] || 0) + 1;
      return acc;
    }, {} as Record<number, number>)
  });

  for (const action of pendingLocalActions) {
    await this.syncSingleAction(action);
  }
}
```

## æµ‹è¯•æ–¹æ¡ˆ

### æµ‹è¯•æ­¥éª¤

1. **æ–­ç½‘æµ‹è¯•**
   ```
   1. æ–­å¼€ç½‘ç»œè¿æ¥
   2. å¯åŠ¨Timerå¹¶åœæ­¢ï¼Œåˆ›å»ºäº‹ä»¶
   3. æ£€æŸ¥localStorageä¸­çš„actionQueueæ˜¯å¦åŒ…å«è¯¥action
   4. æ¢å¤ç½‘ç»œè¿æ¥
   5. è§‚å¯Ÿæ§åˆ¶å°æ—¥å¿—ï¼Œåº”è¯¥çœ‹åˆ°ï¼š
      - "ğŸŒ [Network] Network is back online"
      - "ğŸ”„ [Network] Executing sync after network recovery"
      - äº‹ä»¶åŒæ­¥æˆåŠŸ
   ```

2. **é•¿æ—¶é—´æ–­ç½‘æµ‹è¯•**
   ```
   1. æ–­å¼€ç½‘ç»œè¿æ¥
   2. åˆ›å»ºå¤šä¸ªTimeräº‹ä»¶
   3. ä¿æŒæ–­ç½‘è¶…è¿‡60ç§’
   4. æ¢å¤ç½‘ç»œ
   5. éªŒè¯æ‰€æœ‰äº‹ä»¶éƒ½èƒ½åŒæ­¥æˆåŠŸ
   ```

3. **åˆ·æ–°é¡µé¢æµ‹è¯•**
   ```
   1. æ–­ç½‘çŠ¶æ€ä¸‹åˆ›å»ºäº‹ä»¶
   2. åˆ·æ–°é¡µé¢
   3. æ¢å¤ç½‘ç»œ
   4. éªŒè¯äº‹ä»¶èƒ½è‡ªåŠ¨åŒæ­¥
   ```

### é¢„æœŸæ—¥å¿—

```
// æ–­ç½‘æ—¶
ğŸ“´ [Network] Network is offline, sync will be queued
ğŸ” [RECORD LOCAL ACTION] Network is offline, action will be synced when online

// è”ç½‘å
ğŸŒ [Network] Network is back online, triggering sync...
ğŸ”„ [Network] Executing sync after network recovery
ğŸ”„ [performSync] Starting sync cycle...
ğŸ“Š [Sync] Pending local actions: {"total": 3, "byRetryCount": {"0": 3}}
âœ… [SYNC SINGLE ACTION] Action completed successfully
```

## ä»£ç ä¿®æ”¹ä½ç½®

éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶ï¼š
- `src/services/ActionBasedSyncManager.ts`

éœ€è¦æ·»åŠ çš„æ–¹æ³•ï¼š
1. `setupNetworkListeners()` - è®¾ç½®ç½‘ç»œç›‘å¬
2. `isNetworkError()` - åˆ¤æ–­ç½‘ç»œé”™è¯¯
3. ä¿®æ”¹ `syncSingleAction()` - å¢åŠ é‡è¯•æ¬¡æ•°å’Œæ™ºèƒ½åˆ¤æ–­
4. ä¿®æ”¹ `recordLocalAction()` - æ·»åŠ ç½‘ç»œæ£€æŸ¥
5. ä¿®æ”¹ `syncPendingLocalActions()` - ä¼˜å…ˆå¤„ç†å¤±è´¥æ¬¡æ•°å°‘çš„

## å…¼å®¹æ€§è¯´æ˜

- `navigator.onLine` - æ‰€æœ‰ç°ä»£æµè§ˆå™¨æ”¯æŒ
- `window.addEventListener('online/offline')` - IE9+ æ”¯æŒ
- å¯¹ç°æœ‰åŠŸèƒ½æ— å½±å“ï¼Œçº¯æ–°å¢åŠŸèƒ½

## æ€»ç»“

é€šè¿‡æ·»åŠ ç½‘ç»œçŠ¶æ€ç›‘å¬å’Œæ”¹è¿›é‡è¯•æœºåˆ¶ï¼Œå¯ä»¥ç¡®ä¿ï¼š
1. âœ… æ–­ç½‘æ—¶åˆ›å»ºçš„äº‹ä»¶ä¼šè¢«æ­£ç¡®ä¿å­˜åˆ°é˜Ÿåˆ—
2. âœ… è”ç½‘åç«‹å³è‡ªåŠ¨åŒæ­¥ï¼ˆ1ç§’å»¶è¿Ÿï¼‰
3. âœ… é•¿æ—¶é—´æ–­ç½‘ä¹Ÿèƒ½ä¿æŒé‡è¯•
4. âœ… åˆ·æ–°é¡µé¢åä»èƒ½ç»§ç»­åŒæ­¥

è¿™ä¸ªä¿®å¤æ–¹æ¡ˆä¸ä¼šç ´åç°æœ‰åŠŸèƒ½ï¼Œåªæ˜¯å¢åŠ äº†æ›´å¯é çš„åŒæ­¥ä¿éšœã€‚
