<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>è°ƒè¯• EventTree æ•°æ®</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h1 { color: #333; }
    pre {
      background: #f8f8f8;
      padding: 12px;
      border-radius: 4px;
      overflow-x: auto;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    .event-card {
      border: 1px solid #ddd;
      padding: 12px;
      margin: 8px 0;
      border-radius: 4px;
    }
    .event-card.has-children {
      border-left: 4px solid #4caf50;
    }
    .event-card.has-parent {
      border-left: 4px solid #2196f3;
    }
    .child-events {
      margin-left: 24px;
      padding-left: 12px;
      border-left: 2px solid #e0e0e0;
    }
    button {
      padding: 8px 16px;
      margin: 4px;
      border: none;
      border-radius: 4px;
      background: #2196f3;
      color: white;
      cursor: pointer;
    }
    button:hover {
      background: #1976d2;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ” EventTree æ•°æ®è°ƒè¯•</h1>
    
    <div>
      <button onclick="loadAllEvents()">åŠ è½½æ‰€æœ‰äº‹ä»¶</button>
      <button onclick="findEventsWithChildren()">æŸ¥æ‰¾æœ‰å­äº‹ä»¶çš„äº‹ä»¶</button>
      <button onclick="findTargetEvent()">æŸ¥æ‰¾"å¤å¾·"ç›¸å…³äº‹ä»¶</button>
      <button onclick="createTestTree()">åˆ›å»ºæµ‹è¯•æ ‘ç»“æ„</button>
    </div>

    <div id="output"></div>
  </div>

  <script>
    const output = document.getElementById('output');

    function log(html) {
      output.innerHTML += html + '<br>';
    }

    function clear() {
      output.innerHTML = '';
    }

    function loadAllEvents() {
      clear();
      const eventsStr = localStorage.getItem('events');
      if (!eventsStr) {
        log('<p style="color: red;">âŒ localStorage ä¸­æ²¡æœ‰ events æ•°æ®</p>');
        return;
      }

      try {
        const events = JSON.parse(eventsStr);
        log(`<h2>æ€»å…± ${events.length} ä¸ªäº‹ä»¶</h2>`);
        
        events.forEach(event => {
          const title = typeof event.title === 'string' 
            ? event.title 
            : (event.title?.simpleTitle || event.title?.colorTitle || 'æ— æ ‡é¢˜');
          
          const hasChildren = event.childEventIds && event.childEventIds.length > 0;
          const hasParent = !!event.parentEventId;
          const cssClass = hasChildren ? 'has-children' : (hasParent ? 'has-parent' : '');
          
          log(`
            <div class="event-card ${cssClass}">
              <strong>${title}</strong> (${event.id})<br>
              ${hasParent ? `çˆ¶äº‹ä»¶: ${event.parentEventId}<br>` : ''}
              ${hasChildren ? `å­äº‹ä»¶ (${event.childEventIds.length}): ${event.childEventIds.join(', ')}<br>` : ''}
              ${event.linkedEventIds?.length ? `å…³è”äº‹ä»¶: ${event.linkedEventIds.length} ä¸ª<br>` : ''}
            </div>
          `);
        });
      } catch (error) {
        log(`<p style="color: red;">âŒ è§£æå¤±è´¥: ${error.message}</p>`);
      }
    }

    function findEventsWithChildren() {
      clear();
      const eventsStr = localStorage.getItem('events');
      if (!eventsStr) {
        log('<p style="color: red;">âŒ localStorage ä¸­æ²¡æœ‰ events æ•°æ®</p>');
        return;
      }

      try {
        const events = JSON.parse(eventsStr);
        const withChildren = events.filter(e => e.childEventIds && e.childEventIds.length > 0);
        
        log(`<h2>æ‰¾åˆ° ${withChildren.length} ä¸ªæœ‰å­äº‹ä»¶çš„äº‹ä»¶</h2>`);
        
        withChildren.forEach(event => {
          const title = typeof event.title === 'string' 
            ? event.title 
            : (event.title?.simpleTitle || event.title?.colorTitle || 'æ— æ ‡é¢˜');
          
          log(`
            <div class="event-card has-children">
              <strong>${title}</strong> (${event.id})<br>
              å­äº‹ä»¶æ•°é‡: ${event.childEventIds.length}<br>
              å­äº‹ä»¶ IDs: ${event.childEventIds.join(', ')}
            </div>
          `);

          // æ˜¾ç¤ºå­äº‹ä»¶
          log('<div class="child-events">');
          event.childEventIds.forEach(childId => {
            const child = events.find(e => e.id === childId);
            if (child) {
              const childTitle = typeof child.title === 'string' 
                ? child.title 
                : (child.title?.simpleTitle || child.title?.colorTitle || 'æ— æ ‡é¢˜');
              log(`<div class="event-card">â†³ ${childTitle} (${child.id})</div>`);
            }
          });
          log('</div>');
        });
      } catch (error) {
        log(`<p style="color: red;">âŒ è§£æå¤±è´¥: ${error.message}</p>`);
      }
    }

    function findTargetEvent() {
      clear();
      const eventsStr = localStorage.getItem('events');
      if (!eventsStr) {
        log('<p style="color: red;">âŒ localStorage ä¸­æ²¡æœ‰ events æ•°æ®</p>');
        return;
      }

      try {
        const events = JSON.parse(eventsStr);
        const target = events.find(e => {
          const title = typeof e.title === 'string' 
            ? e.title 
            : (e.title?.simpleTitle || e.title?.colorTitle || '');
          return title.includes('å¤å¾·') || title.includes('11-25');
        });

        if (!target) {
          log('<p style="color: orange;">âš ï¸ æœªæ‰¾åˆ°"å¤å¾·"ç›¸å…³äº‹ä»¶</p>');
          return;
        }

        const title = typeof target.title === 'string' 
          ? target.title 
          : (target.title?.simpleTitle || target.title?.colorTitle || 'æ— æ ‡é¢˜');

        log(`<h2>æ‰¾åˆ°ç›®æ ‡äº‹ä»¶</h2>`);
        log(`<pre>${JSON.stringify(target, null, 2)}</pre>`);

        // æ˜¾ç¤ºå­äº‹ä»¶
        if (target.childEventIds && target.childEventIds.length > 0) {
          log(`<h3>å­äº‹ä»¶ (${target.childEventIds.length} ä¸ª):</h3>`);
          target.childEventIds.forEach(childId => {
            const child = events.find(e => e.id === childId);
            if (child) {
              const childTitle = typeof child.title === 'string' 
                ? child.title 
                : (child.title?.simpleTitle || child.title?.colorTitle || 'æ— æ ‡é¢˜');
              log(`<div class="event-card has-parent">
                <strong>${childTitle}</strong> (${child.id})<br>
                parentEventId: ${child.parentEventId}<br>
                ${child.childEventIds?.length ? `å­äº‹ä»¶: ${child.childEventIds.length} ä¸ª` : ''}
              </div>`);

              // é€’å½’æ˜¾ç¤ºä¸‰çº§å­äº‹ä»¶
              if (child.childEventIds && child.childEventIds.length > 0) {
                log('<div class="child-events">');
                child.childEventIds.forEach(grandChildId => {
                  const grandChild = events.find(e => e.id === grandChildId);
                  if (grandChild) {
                    const gcTitle = typeof grandChild.title === 'string' 
                      ? grandChild.title 
                      : (grandChild.title?.simpleTitle || grandChild.title?.colorTitle || 'æ— æ ‡é¢˜');
                    log(`<div class="event-card">â†³ ${gcTitle} (${grandChild.id})</div>`);
                  }
                });
                log('</div>');
              }
            }
          });
        } else {
          log('<p style="color: orange;">âš ï¸ è¯¥äº‹ä»¶æ²¡æœ‰ childEventIds æ•°æ®</p>');
          log('<p>è¿™æ„å‘³ç€è™½ç„¶è§†è§‰ä¸Šæœ‰ç¼©è¿›ï¼Œä½†æ•°æ®åº“ä¸­æ²¡æœ‰çˆ¶å­å…³ç³»ã€‚éœ€è¦åœ¨ Plan é¡µé¢ä¿®å¤ã€‚</p>');
        }
      } catch (error) {
        log(`<p style="color: red;">âŒ è§£æå¤±è´¥: ${error.message}</p>`);
      }
    }

    async function createTestTree() {
      clear();
      log('<h2>åˆ›å»ºæµ‹è¯•æ ‘ç»“æ„...</h2>');

      // è¿™é‡Œéœ€è¦åœ¨å®é™…åº”ç”¨ä¸­è¿è¡Œï¼Œå› ä¸ºéœ€è¦ EventService
      log('<p style="color: orange;">âš ï¸ æ­¤åŠŸèƒ½éœ€è¦åœ¨å®é™…åº”ç”¨ä¸­è¿è¡Œ</p>');
      log('<p>åœ¨æµè§ˆå™¨ DevTools Console ä¸­è¿è¡Œä»¥ä¸‹ä»£ç ï¼š</p>');
      log(`<pre>
// åˆ›å»ºæµ‹è¯•æ ‘
(async () => {
  const EventService = window.EventService;
  
  // åˆ›å»ºçˆ¶äº‹ä»¶
  const parent = await EventService.createEvent({
    title: { simpleTitle: 'æµ‹è¯•çˆ¶äº‹ä»¶' },
    isTask: false
  });
  
  if (!parent.success) {
    console.error('åˆ›å»ºå¤±è´¥:', parent.error);
    return;
  }
  
  const parentId = parent.event.id;
  console.log('âœ… åˆ›å»ºçˆ¶äº‹ä»¶:', parentId);
  
  // åˆ›å»ºå­äº‹ä»¶
  const child1 = await EventService.createEvent({
    title: { simpleTitle: 'æµ‹è¯•å­äº‹ä»¶ 1' },
    parentEventId: parentId,
    isTask: false
  });
  
  const child2 = await EventService.createEvent({
    title: { simpleTitle: 'æµ‹è¯•å­äº‹ä»¶ 2' },
    parentEventId: parentId,
    isTask: false
  });
  
  // æ›´æ–°çˆ¶äº‹ä»¶çš„ childEventIds
  await EventService.updateEvent(parentId, {
    childEventIds: [child1.event.id, child2.event.id]
  });
  
  console.log('âœ… æµ‹è¯•æ ‘åˆ›å»ºå®Œæˆ!');
  console.log('çˆ¶äº‹ä»¶ ID:', parentId);
  console.log('å­äº‹ä»¶ IDs:', [child1.event.id, child2.event.id]);
})();
      </pre>`);
    }

    // è‡ªåŠ¨åŠ è½½
    window.addEventListener('load', () => {
      loadAllEvents();
    });
  </script>
</body>
</html>
